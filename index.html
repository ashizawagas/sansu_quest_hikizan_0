<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>さんすうクエスト ひきざん</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #a8e6cf, #88d8c0, #74b9ff);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 共通スタイル */

/* 共通：hidden クラスで完全に隠す */
       .hidden {
          display: none !important;
       }


        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-title {
            font-size: 3em;
            color: #00b894;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .main-btn {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-width: 250px;
        }

        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .main-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .back-btn {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-top: 20px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        /* レベル選択画面 */
        .lv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            max-width: 600px;
            margin: 20px 0;
        }

        .lv-btn {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
            border: none;
            padding: 30px 20px;
            font-size: 1.2em;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            position: relative;
        }

        .lv-btn:hover {
            transform: translateY(-3px);
        }

        .lv-btn.cleared {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .lv-btn.cleared::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 1.5em;
        }

        /* レベル1のスタイル */
        .lv1-container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 120px);
        }

        .lv1-left-panel {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .lv1-right-panel {
            flex: 0 0 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .lv1-left-panel::before,
        .lv1-right-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv1-float 20s infinite linear;
            pointer-events: none;
        }

        @keyframes lv1-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv1-title {
            color: #00b894;
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .lv1-score {
            background: #6c5ce7;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 1em;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            z-index: 1;
            text-align: center;
            align-self: center;
        }

        .lv1-problem {
            background: #dff6f0;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 1.1em;
            line-height: 1.6;
            border: 3px solid #00b894;
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .lv1-acorn-section {
            margin: 15px 0;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            flex: 1;
        }

        .lv1-acorn-container {
            min-height: 80px;
            padding: 10px;
            margin: 8px 0;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #74b9ff;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 2px;
            position: relative;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }

        .lv1-initial-acorns {
            border-color: #00b894;
            background: rgba(168, 230, 207, 0.3);
        }

        .lv1-used-acorns {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .lv1-acorn {
            width: 25px;
            height: 25px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            transition: transform 0.2s ease;
            position: relative;
        }

        .lv1-acorn:hover {
            transform: scale(1.1);
        }

        .lv1-acorn.lv1-dragging {
            cursor: grabbing;
            transform: scale(1.2);
            z-index: 1000;
        }

        .lv1-workspace-label {
            position: absolute;
            top: -15px;
            left: 20px;
            background: #74b9ff;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            pointer-events: none;
        }

        .lv1-used-label {
            background: #e74c3c;
            pointer-events: none;
        }

        .lv1-input-group {
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .lv1-input-group label {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2d3436;
            text-align: center;
        }

        .lv1-formula-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1.3em;
            flex-wrap: wrap;
        }

        .lv1-input {
            font-size: 1.2em;
            padding: 10px;
            border: 3px solid #74b9ff;
            border-radius: 10px;
            width: 60px;
            text-align: center;
            margin: 5px;
            box-sizing: border-box;
        }

        .lv1-input[type="number"]::-webkit-outer-spin-button,
        .lv1-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .lv1-input[type="number"] {
            -moz-appearance: textfield;
        }

        .lv1-input:focus {
            outline: none;
            border-color: #0984e3;
            box-shadow: 0 0 10px rgba(116, 185, 255, 0.5);
        }

        .lv1-buttons {
            margin: 15px 0;
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .lv1-btn {
            font-size: 1.1em;
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .lv1-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .lv1-check-btn {
            background: #00b894;
            color: white;
        }

        .lv1-check-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .lv1-next-btn {
            background: #fdcb6e;
            color: #2d3436;
        }

        .lv1-next-btn:hover {
            background: #e17055;
            color: white;
            transform: translateY(-2px);
        }

        .lv1-result {
            font-size: 1.2em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .lv1-correct {
            background: #d1f2eb;
            color: #00b894;
            border: 2px solid #00b894;
        }

        .lv1-incorrect {
            background: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .lv1-clear {
            background: #e8f5e8;
            color: #27ae60;
            border: 3px solid #27ae60;
            font-size: 1.5em;
            animation: lv1-bounce 1s infinite;
            text-align: center;
        }

        @keyframes lv1-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .lv1-drop-zone {
            border-color: #00b894 !important;
            background: rgba(0, 184, 148, 0.1) !important;
        }

        .lv1-drop-zone.lv1-used-acorns {
            border-color: #e74c3c !important;
            background: rgba(231, 76, 60, 0.2) !important;
        }

        /* レベル2のスタイル */
        .lv2-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .lv2-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv2-float 20s infinite linear;
        }

        @keyframes lv2-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv2-title {
            color: #e17055;
            font-size: 2.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .lv2-score {
            background: #55a3ff;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .lv2-problem-text {
            background: #a8e6cf;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.2em;
            line-height: 1.5;
            border: 3px solid #81c784;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .lv2-main-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        /* 左エリア - どんぐりゾーン */
        .lv2-left-section {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .lv2-left-section h3 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-size: 1.3em;
        }

        /* 真ん中エリア - 式とボタン */
        .lv2-center-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            justify-content: flex-start;
        }

        /* 右エリア - かんがえかた */
        .lv2-right-section {
            flex: 1;
            background: #e8f5ff;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        .lv2-person-section {
            background: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .lv2-person-section h4 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-size: 1.1em;
        }

        .lv2-acorn-container {
            min-height: 70px;
            padding: 12px;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #74b9ff;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            justify-items: center;
            align-items: center;
            position: relative;
        }

        .lv2-acorn {
            width: 28px;
            height: 28px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .lv2-acorn:hover {
            transform: scale(1.1);
        }

        .lv2-acorn.lv2-used {
            opacity: 0.3;
            text-decoration: line-through;
        }

        .lv2-acorn.lv2-remaining {
            background-color: #a8e6cf;
            border: 2px solid #81c784;
            border-radius: 50%;
        }

        .lv2-formula-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #74b9ff;
            position: relative;
            min-height: 180px;
            width: 100%;
            max-width: 350px;
        }

        .lv2-formula-section h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.3em;
        }

        .lv2-formula-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .lv2-formula-number {
            position: relative;
            display: inline-block;
        }

        /* さくらんぼ方式のスタイル */
        .lv2-cherry-display {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }

        .lv2-cherry-display.lv2-show {
            opacity: 1;
        }

        .lv2-cherry-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
        }

        .lv2-cherry-line {
            width: 2px;
            height: 40px;
            background: #2d3436;
            margin: 5px 0;
            position: relative;
            animation: lv2-cherryLineGrow 1s ease-out 0.3s both;
        }

        .lv2-cherry-branches {
            display: flex;
            gap: 25px;
            position: relative;
        }

        .lv2-cherry-branches::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: #2d3436;
            animation: lv2-cherryBranchGrow 0.8s ease-out 1s both;
        }

        .lv2-cherry-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lv2-cherry-branch-line {
            width: 2px;
            height: 25px;
            background: #2d3436;
            margin-bottom: 5px;
            animation: lv2-cherryBranchLineGrow 0.6s ease-out both;
        }

        .lv2-cherry-branch:nth-child(1) .lv2-cherry-branch-line {
            animation-delay: 1.5s;
        }

        .lv2-cherry-branch:nth-child(2) .lv2-cherry-branch-line {
            animation-delay: 1.7s;
        }

        .lv2-cherry-value {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #0984e3;
            min-width: 30px;
            text-align: center;
            animation: lv2-cherryPop 0.8s ease forwards;
            opacity: 0;
            position: relative;
        }

        .lv2-cherry-value.lv2-first {
            background: #ff7675;
            border-color: #d63031;
            animation-delay: 2s;
        }

        .lv2-cherry-value.lv2-second {
            background: #00b894;
            border-color: #00a085;
            animation-delay: 2.2s;
        }

        /* 斜線アニメーション */
        .lv2-cherry-value.lv2-crossed {
            position: relative;
        }

        .lv2-cherry-value.lv2-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv2-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        .lv2-remaining-value {
            background: #a8e6cf;
            color: #2d3436;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #81c784;
            min-width: 30px;
            text-align: center;
            position: absolute;
            top: 115%;
            left: 25%;
            transform: translateX(-50%);
            margin-top: 5px;
            opacity: 0;
            animation: lv2-remainingPop 0.8s ease forwards 1s;
        }

        @keyframes lv2-cherryLineGrow {
            0% { height: 0; }
            100% { height: 40px; }
        }

        @keyframes lv2-cherryBranchGrow {
            0% { width: 0; }
            100% { width: 50px; }
        }

        @keyframes lv2-cherryBranchLineGrow {
            0% { height: 0; }
            100% { height: 25px; }
        }

        @keyframes lv2-cherryPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-15px); 
            }
            50% { 
                transform: scale(1.3) translateY(-8px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes lv2-strikethrough {
            0% { width: 0; }
            100% { width: 120%; }
        }

        @keyframes lv2-remainingPop {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) scale(0.3); 
            }
            50% { 
                transform: translateX(-50%) scale(1.3); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) scale(1); 
            }
        }

        /* ③のステップで表示される結果 */
        .lv2-step3-result-display {
            margin-top: 15px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .lv2-step3-result-display.lv2-show {
            opacity: 1;
        }

        .lv2-step3-ten-block {
            background: #ff7675;
            color: white;
            border: 2px solid #d63031;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 0 5px;
            display: inline-block;
            font-weight: bold;
            position: relative;
        }

        .lv2-step3-ten-block.lv2-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv2-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        .lv2-step3-result-number {
            background: #a8e6cf;
            color: #2d3436;
            border: 2px solid #81c784;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 0 5px;
            display: inline-block;
            font-weight: bold;
            opacity: 0;
            animation: lv2-resultPop 0.8s ease forwards 1s;
        }

        /* ④のステップでしきウインドーの楕円アニメーション */
        .lv2-formula-oval-highlight {
            position: absolute;
            border: 3px solid #00b894;
            border-radius: 50%;
            background: rgba(0, 184, 148, 0.1);
            opacity: 0;
            z-index: 15;
            pointer-events: none;
            transform-origin: center center !important;
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        opacity 0.8s ease-out, 
                        box-shadow 0.8s ease-out;
        }

        @keyframes lv2-resultPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3); 
            }
            50% { 
                transform: scale(1.3); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes lv2-ovalHighlight {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 20px rgba(0, 184, 148, 0.5);
            }
            100% {
                opacity: 0.8;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(0, 184, 148, 0.3);
            }
        }

        /* 式の被減数を強調表示するスタイル */
        .lv2-formula-first-highlight {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #0984e3;
            animation: lv2-formulaHighlight 2s ease-in-out;
        }

        @keyframes lv2-formulaHighlight {
            0%, 100% { transform: scale(1); }
            30%, 70% { 
                transform: scale(1.2); 
                box-shadow: 0 0 15px rgba(116, 185, 255, 0.6); 
            }
        }

/* レベル2のボタン位置修正 */
.lv2-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 100%;
    max-width: 350px;
    margin-top: 150px; /* 100px から 150px に変更 */
}
        .lv2-button {
            font-size: 1.2em;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            width: 100%;
            max-width: 280px;
        }

        .lv2-check-btn {
            background: #00b894;
            color: white;
        }

        .lv2-check-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .lv2-next-btn {
            background: #fdcb6e;
            color: #2d3436;
        }

        .lv2-next-btn:hover {
            background: #e17055;
            color: white;
            transform: translateY(-2px);
        }

        .lv2-calculation-steps {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00b894;
            flex: 1;
            overflow-y: auto;
        }

        .lv2-calculation-steps h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.2em;
        }

        .lv2-step {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #74b9ff;
            display: none;
            font-size: 1.1em;
        }

        .lv2-step.lv2-active {
            display: block;
            animation: lv2-fadeIn 0.5s ease-in;
        }

        @keyframes lv2-fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lv2-input {
            font-size: 1.2em;
            padding: 8px;
            border: 2px solid #74b9ff;
            border-radius: 8px;
            width: 50px;
            text-align: center;
            margin: 3px;
        }

        .lv2-input:focus {
            outline: none;
            border-color: #0984e3;
            box-shadow: 0 0 8px rgba(116, 185, 255, 0.5);
        }

        /* spinnerを非表示 */
        .lv2-input[type="number"]::-webkit-outer-spin-button,
        .lv2-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .lv2-input[type="number"] {
            -moz-appearance: textfield;
        }

        .lv2-ten-block {
            background: #ff7675;
            color: white;
            border: 2px solid #d63031;
            border-radius: 5px;
            padding: 3px 8px;
            margin: 0 3px;
            display: inline-block;
            font-weight: bold;
        }

        .lv2-ten-digit {
            display: inline-block;
            margin: 0;
            padding: 0;
        }

        /* メッセージ表示のスタイル */
        .lv2-message {
            font-size: 1.4em;
            margin: 20px 0 0 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
            width: 100%;
            max-width: 350px;
        }

        .lv2-message.lv2-show {
            display: block;
            animation: lv2-messageSlide 0.5s ease-in-out;
        }

        .lv2-message.lv2-error {
            background: #ffeaa7;
            color: #e17055;
            border: 2px solid #e17055;
        }

        .lv2-message.lv2-success {
            background: #d1f2eb;
            color: #00b894;
            border: 2px solid #00b894;
        }

        @keyframes lv2-messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .lv2-result {
            font-size: 1.3em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .lv2-clear {
            background: #e8f5e8;
            color: #27ae60;
            border: 3px solid #27ae60;
            font-size: 1.8em;
            animation: lv2-bounce 1s infinite;
        }

        @keyframes lv2-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .lv2-restart-btn {
            background: #6c5ce7;
            color: white;
        }

        .lv2-restart-btn:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
        }

        /* レベル3のスタイル */
        .lv3-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .lv3-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv3-float 20s infinite linear;
        }

        @keyframes lv3-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv3-title {
            color: #e17055;
            font-size: 2.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .lv3-score {
            background: #55a3ff;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .lv3-main-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        /* 左エリア - 式とボタン */
        .lv3-left-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            justify-content: flex-start;
        }

        /* 右エリア - かんがえかた */
        .lv3-right-section {
            flex: 1;
            background: #e8f5ff;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        .lv3-formula-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #74b9ff;
            position: relative;
            min-height: 180px;
            width: 100%;
            max-width: 350px;
        }

        .lv3-formula-section h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.3em;
        }

        .lv3-formula-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .lv3-formula-number {
            position: relative;
            display: inline-block;
        }

        /* さくらんぼの左枝に斜線を引くスタイル */
        .lv3-cherry-strikethrough {
            position: absolute;
            width: 60px;
            height: 2px;
            background: #e74c3c;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            opacity: 0;
            animation: lv3-strikeShow 1s ease-in-out 0.5s forwards;
            z-index: 20;
        }

        @keyframes lv3-strikeShow {
            0% {
                opacity: 0;
                width: 0;
            }
            100% {
                opacity: 1;
                width: 60px;
            }
        }

        /* ②の答えブロック */
        .lv3-step2-result-block {
            position: absolute;
            background: #00b894;
            color: white;
            border: 2px solid #00a085;
            border-radius: 5px;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 1.1em;
            min-width: 30px;
            text-align: center;
            z-index: 15;
            opacity: 0;
            animation: lv3-resultBlockShow 1s ease-in-out 1.5s forwards;
            top: 100px;
            left: 0%;
            transform: translateX(-50%);
        }

        @keyframes lv3-resultBlockShow {
            0% {
                opacity: 0;
                transform: translateX(-50%) scale(0.3) translateY(-15px);
            }
            50% {
                transform: translateX(-50%) scale(1.3) translateY(-8px);
            }
            100% {
                opacity: 1;
                transform: translateX(-50%) scale(1) translateY(0);
            }
        }

        /* ③のステップで2つの数を囲む楕円 */
        .lv3-final-circle {
            position: absolute;
            border: 2px solid #e17055;
            border-radius: 50% / 30%;
            background: rgba(225, 112, 85, 0.1);
            opacity: 0;
            z-index: 12;
            transform-origin: center;
        }

        /* 楕円のスケールアニメーション用 */
        .lv3-final-circle.lv3-animate {
            animation: lv3-finalCircleScale 2s ease-in-out forwards;
        }

        @keyframes lv3-finalCircleScale {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) rotate(var(--rotation)) scale(0.3);
            }
            50% {
                transform: translate(-50%, -50%) rotate(var(--rotation)) scale(1.3);
                box-shadow: 0 0 20px rgba(225, 112, 85, 0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) rotate(var(--rotation)) scale(1);
                box-shadow: 0 0 10px rgba(225, 112, 85, 0.3);
            }
        }

        /* さくらんぼ方式のスタイル */
        .lv3-cherry-display {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }

        .lv3-cherry-display.lv3-show {
            opacity: 1;
        }

        .lv3-cherry-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
        }

        .lv3-cherry-line {
            width: 2px;
            height: 40px;
            background: #2d3436;
            margin: 5px 0;
            position: relative;
            animation: lv3-cherryLineGrow 1s ease-out 0.3s both;
        }

        .lv3-cherry-branches {
            display: flex;
            gap: 25px;
            position: relative;
        }

        .lv3-cherry-branches::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: #2d3436;
            animation: lv3-cherryBranchGrow 0.8s ease-out 1s both;
        }

        .lv3-cherry-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lv3-cherry-branch-line {
            width: 2px;
            height: 25px;
            background: #2d3436;
            margin-bottom: 5px;
            animation: lv3-cherryBranchLineGrow 0.6s ease-out both;
        }

        .lv3-cherry-branch:nth-child(1) .lv3-cherry-branch-line {
            animation-delay: 1.5s;
        }

        .lv3-cherry-branch:nth-child(2) .lv3-cherry-branch-line {
            animation-delay: 1.7s;
        }

        .lv3-cherry-value {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #0984e3;
            min-width: 30px;
            text-align: center;
            animation: lv3-cherryPop 0.8s ease forwards;
            opacity: 0;
            position: relative;
        }

        /* 色を入れ替え：左が赤、右が緑 */
        .lv3-cherry-value.lv3-first {
            background: #ff7675;
            border-color: #d63031;
            animation-delay: 2s;
        }

        .lv3-cherry-value.lv3-second {
            background: #00b894;
            border-color: #00a085;
            animation-delay: 2.2s;
        }

        @keyframes lv3-cherryLineGrow {
            0% { height: 0; }
            100% { height: 40px; }
        }

        @keyframes lv3-cherryBranchGrow {
            0% { width: 0; }
            100% { width: 50px; }
        }

        @keyframes lv3-cherryBranchLineGrow {
            0% { height: 0; }
            100% { height: 25px; }
        }

        @keyframes lv3-cherryPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-15px); 
            }
            50% { 
                transform: scale(1.3) translateY(-8px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* 式の前項を強調表示するスタイル */
        .lv3-formula-first-highlight {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #0984e3;
            animation: lv3-formulaHighlight 2s ease-in-out;
        }

        @keyframes lv3-formulaHighlight {
            0%, 100% { transform: scale(1); }
            30%, 70% { 
                transform: scale(1.2); 
                box-shadow: 0 0 15px rgba(116, 185, 255, 0.6); 
            }
        }

       /* レベル3のボタン位置修正 */
.lv3-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 100%;
    max-width: 350px;
    margin-top: 110px; /* 60px から 110px に変更 */
}

        .lv3-button {
            font-size: 1.2em;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            width: 100%;
            max-width: 280px;
        }

        .lv3-check-btn {
            background: #00b894;
            color: white;
        }

        .lv3-check-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .lv3-next-btn {
            background: #fdcb6e;
            color: #2d3436;
        }

        .lv3-next-btn:hover {
            background: #e17055;
            color: white;
            transform: translateY(-2px);
        }

        .lv3-calculation-steps {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00b894;
            flex: 1;
            overflow-y: auto;
        }

        .lv3-calculation-steps h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.2em;
        }

        .lv3-step {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #74b9ff;
            display: none;
            font-size: 1.1em;
        }

        .lv3-step.lv3-active {
            display: block;
            animation: lv3-fadeIn 0.5s ease-in;
        }

        @keyframes lv3-fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lv3-input {
            font-size: 1.2em;
            padding: 8px;
            border: 2px solid #74b9ff;
            border-radius: 8px;
            width: 50px;
            text-align: center;
            margin: 3px;
        }

        .lv3-input:focus {
            outline: none;
            border-color: #0984e3;
            box-shadow: 0 0 8px rgba(116, 185, 255, 0.5);
        }

        /* spinnerを非表示 */
        .lv3-input[type="number"]::-webkit-outer-spin-button,
        .lv3-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .lv3-input[type="number"] {
            -moz-appearance: textfield;
        }

        .lv3-ten-block {
            background: #00b894;
            color: white;
            border: 2px solid #00a085;
            border-radius: 5px;
            padding: 3px 8px;
            margin: 0 3px;
            display: inline-block;
            font-weight: bold;
        }

        /* 式ゾーンの10ブロック（小さなサイズで統一） */
        .lv3-formula-ten-block {
            position: absolute;
            background: #00b894;
            color: white;
            border: 2px solid #00a085;
            border-radius: 5px;
            padding: 3px 8px;
            font-weight: bold;
            font-size: 1em;
            min-width: 30px;
            text-align: center;
            z-index: 15;
            opacity: 0;
            animation: lv3-formulaTenShow 2s ease-in-out forwards;
        }

        @keyframes lv3-formulaTenShow {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* メッセージ表示のスタイル */
        .lv3-message {
            font-size: 1.4em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
            width: 100%;
            max-width: 350px;
        }

        .lv3-message.lv3-show {
            display: block;
            animation: lv3-messageSlide 0.5s ease-in-out;
        }

        .lv3-message.lv3-error {
            background: #ffeaa7;
            color: #e17055;
            border: 2px solid #e17055;
        }

        .lv3-message.lv3-success {
            background: #d1f2eb;
            color: #00b894;
            border: 2px solid #00b894;
        }

        @keyframes lv3-messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .lv3-result {
            font-size: 1.3em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .lv3-clear {
            background: #e8f5e8;
            color: #27ae60;
            border: 3px solid #27ae60;
            font-size: 1.8em;
            animation: lv3-bounce 1s infinite;
        }

        @keyframes lv3-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .lv3-restart-btn {
            background: #6c5ce7;
            color: white;
        }

        .lv3-restart-btn:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
        }

        /* 式の値を表示するスタイル */
        .lv3-formula-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2d3436;
            padding: 8px;
        }

        /* レベル4のスタイル */
        .lv4-container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .lv4-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv4-float 20s infinite linear;
        }

        @keyframes lv4-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv4-title {
            color: #e17055;
            font-size: 2.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .lv4-score {
            background: #55a3ff;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .lv4-problem-text {
            background: #a8e6cf;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.2em;
            line-height: 1.5;
            border: 3px solid #81c784;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .lv4-main-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        /* 左エリア - どんぐりゾーン */
        .lv4-left-section {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .lv4-left-section h3 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-size: 1.3em;
        }

        /* 真ん中エリア - 式とボタン */
        .lv4-center-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            justify-content: flex-start;
        }

        /* 右エリア - かんがえかた */
        .lv4-right-section {
            flex: 1;
            background: #e8f5ff;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        .lv4-person-section {
            background: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .lv4-person-section h4 {
            margin: 0 0 10px 0;
            color: #2d3436;
            font-size: 1.1em;
        }

        .lv4-acorn-container {
            min-height: 70px;
            padding: 12px;
            background: rgba(255,255,255,0.9);
            border: 2px dashed #74b9ff;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            justify-items: center;
            align-items: center;
            position: relative;
        }

        .lv4-acorn {
            width: 28px;
            height: 28px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
        }

        .lv4-acorn:hover {
            transform: scale(1.1);
        }

        .lv4-acorn.lv4-used {
            opacity: 0.3;
            text-decoration: line-through;
        }

        .lv4-acorn.lv4-remaining {
            background-color: #a8e6cf;
            border: 2px solid #81c784;
            border-radius: 50%;
        }

        .lv4-formula-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #74b9ff;
            position: relative;
            min-height: 180px;
            width: 100%;
            max-width: 350px;
        }

        .lv4-formula-section h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.3em;
        }

        .lv4-formula-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .lv4-formula-number {
            position: relative;
            display: inline-block;
        }

        /* さくらんぼ方式のスタイル */
        .lv4-cherry-display {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }

        .lv4-cherry-display.lv4-show {
            opacity: 1;
        }

        .lv4-cherry-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
        }

        .lv4-cherry-line {
            width: 2px;
            height: 40px;
            background: #2d3436;
            margin: 5px 0;
            position: relative;
            animation: lv4-cherryLineGrow 1s ease-out 0.3s both;
        }

        .lv4-cherry-branches {
            display: flex;
            gap: 25px;
            position: relative;
        }

        .lv4-cherry-branches::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: #2d3436;
            animation: lv4-cherryBranchGrow 0.8s ease-out 1s both;
        }

        .lv4-cherry-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lv4-cherry-branch-line {
            width: 2px;
            height: 25px;
            background: #2d3436;
            margin-bottom: 5px;
            animation: lv4-cherryBranchLineGrow 0.6s ease-out both;
        }

        .lv4-cherry-branch:nth-child(1) .lv4-cherry-branch-line {
            animation-delay: 1.5s;
        }

        .lv4-cherry-branch:nth-child(2) .lv4-cherry-branch-line {
            animation-delay: 1.7s;
        }

        .lv4-cherry-value {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #0984e3;
            min-width: 30px;
            text-align: center;
            animation: lv4-cherryPop 0.8s ease forwards;
            opacity: 0;
            position: relative;
        }

        .lv4-cherry-value.lv4-first {
            background: #ff7675;
            border-color: #d63031;
            animation-delay: 2s;
        }

        .lv4-cherry-value.lv4-second {
            background: #00b894;
            border-color: #00a085;
            animation-delay: 2.2s;
        }

        /* 斜線アニメーション */
        .lv4-cherry-value.lv4-crossed {
            position: relative;
        }

        .lv4-cherry-value.lv4-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv4-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        .lv4-remaining-value {
            background: #a8e6cf;
            color: #2d3436;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #81c784;
            min-width: 30px;
            text-align: center;
            position: absolute;
            top: 115%;
            left: 25%;
            transform: translateX(-50%);
            margin-top: 5px;
            opacity: 0;
            animation: lv4-remainingPop 0.8s ease forwards 1s;
        }

        @keyframes lv4-cherryLineGrow {
            0% { height: 0; }
            100% { height: 40px; }
        }

        @keyframes lv4-cherryBranchGrow {
            0% { width: 0; }
            100% { width: 50px; }
        }

        @keyframes lv4-cherryBranchLineGrow {
            0% { height: 0; }
            100% { height: 25px; }
        }

        @keyframes lv4-cherryPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-15px); 
            }
            50% { 
                transform: scale(1.3) translateY(-8px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes lv4-strikethrough {
            0% { width: 0; }
            100% { width: 120%; }
        }

        @keyframes lv4-remainingPop {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) scale(0.3); 
            }
            50% { 
                transform: translateX(-50%) scale(1.3); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) scale(1); 
            }
        }

       /* ③のステップで表示される結果 */
        .lv4-step3-result-display, .lv4-step4-result-display {
            margin-top: 15px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .lv4-step3-result-display.lv4-show, .lv4-step4-result-display.lv4-show {
            opacity: 1;
        }

        .lv4-step3-ten-block {
            background: #ff7675;
            color: white;
            border: 2px solid #d63031;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 0 5px;
            display: inline-block;
            font-weight: bold;
            position: relative;
        }

        .lv4-step3-ten-block.lv4-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv4-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        .lv4-step3-result-number {
            background: #a8e6cf;
            color: #2d3436;
            border: 2px solid #81c784;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 0 5px;
            display: inline-block;
            font-weight: bold;
            opacity: 0;
            animation: lv4-resultPop 0.8s ease forwards 1s;
        }

        /* ④のステップでしきウインドーの楕円アニメーション */
        .lv4-formula-oval-highlight {
            position: absolute;
            border: 3px solid #00b894;
            border-radius: 50%;
            background: rgba(0, 184, 148, 0.1);
            opacity: 0;
            z-index: 15;
            pointer-events: none;
            transform-origin: center center !important;
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        opacity 0.8s ease-out, 
                        box-shadow 0.8s ease-out;
        }

        .lv4-formula-result-block {
            position: absolute;
            opacity: 0;
            animation: lv4-resultPop 0.8s ease forwards;
        }

        .lv4-formula-overlay-block {
            position: absolute;
            opacity: 0;
            animation: lv4-resultPop 0.5s ease forwards;
        }

        @keyframes lv4-resultPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3); 
            }
            50% { 
                transform: scale(1.3); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes lv4-ovalHighlight {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 20px rgba(0, 184, 148, 0.5);
            }
            100% {
                opacity: 0.8;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(0, 184, 148, 0.3);
            }
        }

        /* 式の被減数を強調表示するスタイル */
        .lv4-formula-first-highlight {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #0984e3;
            animation: lv4-formulaHighlight 2s ease-in-out;
        }

        .lv4-formula-second-highlight {
            background: #ff7675;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #d63031;
            animation: lv4-formulaHighlight 2s ease-in-out;
        }

        @keyframes lv4-formulaHighlight {
            0%, 100% { transform: scale(1); }
            30%, 70% { 
                transform: scale(1.2); 
                box-shadow: 0 0 15px rgba(116, 185, 255, 0.6); 
            }
        }

       /* レベル4のボタン位置修正 */
.lv4-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 100%;
    max-width: 350px;
    margin-top: 150px; /* 100px から 150px に変更 */
}

        .lv4-button {
            font-size: 1.2em;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            width: 100%;
            max-width: 280px;
        }

        .lv4-check-btn {
            background: #00b894;
            color: white;
        }

        .lv4-check-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .lv4-next-btn {
            background: #fdcb6e;
            color: #2d3436;
        }

        .lv4-next-btn:hover {
            background: #e17055;
            color: white;
            transform: translateY(-2px);
        }

        .lv4-calculation-steps {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00b894;
            flex: 1;
            overflow-y: auto;
        }

        .lv4-calculation-steps h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.2em;
        }

        .lv4-step {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #74b9ff;
            display: none;
            font-size: 1.1em;
        }

        .lv4-step.lv4-active {
            display: block;
            animation: lv4-fadeIn 0.5s ease-in;
        }

        @keyframes lv4-fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lv4-input {
            font-size: 1.2em;
            padding: 8px;
            border: 2px solid #74b9ff;
            border-radius: 8px;
            width: 50px;
            text-align: center;
            margin: 3px;
        }

        .lv4-input:focus {
            outline: none;
            border-color: #0984e3;
            box-shadow: 0 0 8px rgba(116, 185, 255, 0.5);
        }

        /* spinnerを非表示 */
        .lv4-input[type="number"]::-webkit-outer-spin-button,
        .lv4-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .lv4-input[type="number"] {
            -moz-appearance: textfield;
        }

        .lv4-ten-block {
            background: #ff7675;
            color: white;
            border: 2px solid #d63031;
            border-radius: 5px;
            padding: 3px 8px;
            margin: 0 3px;
            display: inline-block;
            font-weight: bold;
            position: relative;
        }

        .lv4-ten-block.lv4-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv4-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        .lv4-ten-digit {
            display: inline-block;
            margin: 0;
            padding: 0;
        }

        /* メッセージ表示のスタイル */
        .lv4-message {
            font-size: 1.4em;
            margin: 20px 0 0 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
            width: 100%;
            max-width: 350px;
        }

        .lv4-message.lv4-show {
            display: block;
            animation: lv4-messageSlide 0.5s ease-in-out;
        }

        .lv4-message.lv4-error {
            background: #ffeaa7;
            color: #e17055;
            border: 2px solid #e17055;
        }

        .lv4-message.lv4-success {
            background: #d1f2eb;
            color: #00b894;
            border: 2px solid #00b894;
        }

        @keyframes lv4-messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .lv4-result {
            font-size: 1.3em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .lv4-clear {
            background: #e8f5e8;
            color: #27ae60;
            border: 3px solid #27ae60;
            font-size: 1.8em;
            animation: lv4-bounce 1s infinite;
        }

        @keyframes lv4-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .lv4-restart-btn {
            background: #6c5ce7;
            color: white;
        }

        .lv4-restart-btn:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
        }

        /* レベル5のスタイル */
        .lv5-container {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .lv5-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv5-float 20s infinite linear;
        }

        @keyframes lv5-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv5-title {
            color: #e17055;
            font-size: 2.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .lv5-score {
            background: #55a3ff;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 1.1em;
            margin-bottom: 30px;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .lv5-main-layout {
            display: flex;
            gap: 40px;
            flex: 1;
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        /* 左エリア - 式ゾーン */
        .lv5-left-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
            justify-content: flex-start;
        }

        /* 右エリア - かんがえかた */
        .lv5-right-section {
            flex: 1;
            background: #e8f5ff;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
        }

        .lv5-formula-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #74b9ff;
            position: relative;
            min-height: 200px;
            width: 100%;
            max-width: 400px;
        }

        .lv5-formula-section h3 {
            margin: 0 0 25px 0;
            color: #2d3436;
            font-size: 1.4em;
        }

        .lv5-formula-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.6em;
            margin-bottom: 20px;
        }

        .lv5-formula-number {
            position: relative;
            display: inline-block;
        }

        /* さくらんぼ方式のスタイル */
        .lv5-cherry-display {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
        }

        .lv5-cherry-display.lv5-show {
            opacity: 1;
        }

        .lv5-cherry-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
        }

        .lv5-cherry-line {
            width: 2px;
            height: 40px;
            background: #2d3436;
            margin: 5px 0;
            position: relative;
            animation: lv5-cherryLineGrow 1s ease-out 0.3s both;
        }

        .lv5-cherry-branches {
            display: flex;
            gap: 25px;
            position: relative;
        }

        .lv5-cherry-branches::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: #2d3436;
            animation: lv5-cherryBranchGrow 0.8s ease-out 1s both;
        }

        .lv5-cherry-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lv5-cherry-branch-line {
            width: 2px;
            height: 25px;
            background: #2d3436;
            margin-bottom: 5px;
            animation: lv5-cherryBranchLineGrow 0.6s ease-out both;
        }

        .lv5-cherry-branch:nth-child(1) .lv5-cherry-branch-line {
            animation-delay: 1.5s;
        }

        .lv5-cherry-branch:nth-child(2) .lv5-cherry-branch-line {
            animation-delay: 1.7s;
        }

        .lv5-cherry-value {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid #0984e3;
            min-width: 30px;
            text-align: center;
            animation: lv5-cherryPop 0.8s ease forwards;
            opacity: 0;
            position: relative;
        }

        .lv5-cherry-value.lv5-first {
            background: #ff7675;
            border-color: #d63031;
            animation-delay: 2s;
        }

        .lv5-cherry-value.lv5-second {
            background: #00b894;
            border-color: #00a085;
            animation-delay: 2.2s;
        }

        /* 斜線アニメーション */
        .lv5-cherry-value.lv5-crossed {
            position: relative;
        }

        .lv5-cherry-value.lv5-crossed::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 3px;
            background: #d63031;
            transform: translate(-50%, -50%) rotate(-45deg);
            animation: lv5-strikethrough 0.8s ease-out forwards;
            z-index: 1;
        }

        @keyframes lv5-cherryLineGrow {
            0% { height: 0; }
            100% { height: 40px; }
        }

        @keyframes lv5-cherryBranchGrow {
            0% { width: 0; }
            100% { width: 50px; }
        }

        @keyframes lv5-cherryBranchLineGrow {
            0% { height: 0; }
            100% { height: 25px; }
        }

        @keyframes lv5-cherryPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3) translateY(-15px); 
            }
            50% { 
                transform: scale(1.3) translateY(-8px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        @keyframes lv5-strikethrough {
            0% { width: 0; }
            100% { width: 120%; }
        }

        /* 式の強調表示するスタイル */
        .lv5-formula-first-highlight {
            background: #74b9ff;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #0984e3;
            animation: lv5-formulaHighlight 2s ease-in-out;
        }

        .lv5-formula-second-highlight {
            background: #ff7675;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            border: 2px solid #d63031;
            animation: lv5-formulaHighlight 2s ease-in-out;
        }

        @keyframes lv5-formulaHighlight {
            0%, 100% { transform: scale(1); }
            30%, 70% { 
                transform: scale(1.2); 
                box-shadow: 0 0 15px rgba(116, 185, 255, 0.6); 
            }
        }

        .lv5-formula-result-block {
            position: absolute;
            opacity: 0;
            animation: lv5-resultPop 0.8s ease forwards;
        }

        .lv5-formula-overlay-block {
            position: absolute;
            opacity: 0;
            animation: lv5-resultPop 0.5s ease forwards;
        }

        @keyframes lv5-resultPop {
            0% { 
                opacity: 0; 
                transform: scale(0.3); 
            }
            50% { 
                transform: scale(1.3); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

       /* レベル5のボタン位置修正 */
.lv5-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 100%;
    max-width: 400px;
    margin-top: 200px; /* 150px から 200px に変更 */
}

        .lv5-button {
            font-size: 1.2em;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            width: 100%;
            max-width: 280px;
        }

        .lv5-check-btn {
            background: #00b894;
            color: white;
        }

        .lv5-check-btn:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .lv5-next-btn {
            background: #fdcb6e;
            color: #2d3436;
        }

        .lv5-next-btn:hover {
            background: #e17055;
            color: white;
            transform: translateY(-2px);
        }

        .lv5-calculation-steps {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00b894;
            flex: 1;
            overflow-y: auto;
        }

        .lv5-calculation-steps h3 {
            margin: 0 0 15px 0;
            color: #2d3436;
            font-size: 1.2em;
        }

        .lv5-step {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #74b9ff;
            display: none;
            font-size: 1.1em;
        }

        .lv5-step.lv5-active {
            display: block;
            animation: lv5-fadeIn 0.5s ease-in;
        }

        @keyframes lv5-fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lv5-input {
            font-size: 1.2em;
            padding: 8px;
            border: 2px solid #74b9ff;
            border-radius: 8px;
            width: 50px;
            text-align: center;
            margin: 3px;
        }

        .lv5-input:focus {
            outline: none;
            border-color: #0984e3;
            box-shadow: 0 0 8px rgba(116, 185, 255, 0.5);
        }

        /* spinnerを非表示 */
        .lv5-input[type="number"]::-webkit-outer-spin-button,
        .lv5-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .lv5-input[type="number"] {
            -moz-appearance: textfield;
        }

        /* メッセージ表示のスタイル */
        .lv5-message {
            font-size: 1.4em;
            margin: 20px 0 0 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            display: none;
            width: 100%;
            max-width: 400px;
        }

        .lv5-message.lv5-show {
            display: block;
            animation: lv5-messageSlide 0.5s ease-in-out;
        }

        .lv5-message.lv5-error {
            background: #ffeaa7;
            color: #e17055;
            border: 2px solid #e17055;
        }

        .lv5-message.lv5-success {
            background: #d1f2eb;
            color: #00b894;
            border: 2px solid #00b894;
        }

        @keyframes lv5-messageSlide {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .lv5-result {
            font-size: 1.3em;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .lv5-clear {
            background: #e8f5e8;
            color: #27ae60;
            border: 3px solid #27ae60;
            font-size: 1.8em;
            animation: lv5-bounce 1s infinite;
        }

        @keyframes lv5-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .lv5-restart-btn {
            background: #6c5ce7;
            color: white;
        }

        .lv5-restart-btn:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
        }

        /* レベル6のスタイル */
        .lv6-container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .lv6-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: lv6-float 20s infinite linear;
        }

        @keyframes lv6-float {
            0% { transform: rotate(0deg) translate(-50%, -50%); }
            100% { transform: rotate(360deg) translate(-50%, -50%); }
        }

        .lv6-header {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .lv6-title {
            color: #ff6b9d;
            font-size: 2.5em;
            margin: 0 0 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .lv6-progress {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #666;
            font-size: 1.2em;
            position: relative;
            z-index: 1;
        }

        .lv6-problem-area {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 300px;
            position: relative;
            z-index: 1;
        }

        .lv6-problem-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 3em;
            color: #333;
            margin: 10px 0;
        }

        .lv6-answer-input {
            font-size: 1em;
            padding: 10px 15px;
            border: 3px solid #ff9a9e;
            border-radius: 15px;
            text-align: center;
            width: 100px;
            background: #fef7f7;
        }

        .lv6-answer-input:focus {
            outline: none;
            border-color: #ff6b9d;
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.3);
        }

        .lv6-message {
            font-size: 1.8em;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .lv6-correct {
            color: #4CAF50;
            font-weight: bold;
            animation: lv6-bounce 0.6s ease-in-out;
        }

        .lv6-incorrect {
            color: #ff6b9d;
            font-weight: bold;
        }

        @keyframes lv6-bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }

        .lv6-sort-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            display: none;
            position: relative;
            z-index: 1;
        }

        .lv6-sort-button:hover {
            transform: translateY(-2px);
        }

        .lv6-sort-button:active {
            transform: translateY(0);
        }

        .lv6-cards-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 1000px;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        .lv6-column-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .lv6-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 100px;
            min-height: 50px;
        }

        .lv6-column-label {
            background: #667eea;
            color: white;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .lv6-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: lv6-cardAppear 0.5s ease-out;
            border: 2px solid white;
            transition: all 0.3s ease;
        }

        .lv6-card.lv6-sorting {
            animation: lv6-cardSort 0.5s ease-in-out;
        }

        @keyframes lv6-cardAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes lv6-cardSort {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .lv6-completion-message {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            border-radius: 20px;
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: lv6-celebrationPulse 2s infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes lv6-celebrationPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }


/* レベル7のスタイル */
    .lv7-container {
        background: white;
        border-radius: 30px;
        padding: 40px;
        box-shadow: 0 15px 35px rgba(72,187,120,0.3);
        max-width: 700px;
        width: 100%;
        text-align: center;
        border: 5px solid #90cdf4;
        position: relative;
        z-index: 1;
    }

    .lv7-title {
        color: #4299e1;
        margin-bottom: 30px;
        font-size: 2.8em;
        text-shadow: 2px 2px 4px rgba(66,153,225,0.3);
    }

    .lv7-target-number {
        font-size: 4em;
        color: #2b6cb0;
        margin: 20px 0;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(43,108,176,0.3);
    }

    .lv7-number-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin: 40px 0;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .lv7-number-card {
        background: linear-gradient(135deg, #bee3f8, #90cdf4);
        border: 4px solid #4299e1;
        border-radius: 20px;
        padding: 25px;
        font-size: 2.5em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        min-height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 15px rgba(66,153,225,0.2);
    }

    .lv7-number-card:hover {
        transform: translateY(-8px) scale(1.05);
        box-shadow: 0 15px 25px rgba(66,153,225,0.4);
    }

    .lv7-number-card.lv7-selected {
        background: linear-gradient(135deg, #fbb6ce, #f687b3);
        color: white;
        border-color: #ed64a6;
        transform: scale(1.15);
        box-shadow: 0 10px 20px rgba(237,100,166,0.5);
    }

    .lv7-number-card.lv7-matched {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        animation: lv7-matchAnimation 0.8s ease;
    }

    @keyframes lv7-matchAnimation {
        0% { transform: scale(1); }
        30% { transform: scale(1.3) rotate(5deg); }
        60% { transform: scale(1.3) rotate(-5deg); }
        100% { transform: scale(0) rotate(0deg); opacity: 0; }
    }

    .lv7-button {
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        color: #2b6cb0;
        border: 3px solid #4299e1;
        padding: 20px 35px;
        font-size: 1.4em;
        font-weight: bold;
        border-radius: 25px;
        cursor: pointer;
        margin: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 8px 15px rgba(66,153,225,0.2);
    }

    .lv7-button:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 25px rgba(66,153,225,0.4);
        background: linear-gradient(135deg, #fed6e3, #a8edea);
    }

    .lv7-button:active {
        transform: translateY(-2px) scale(1.02);
    }

    .lv7-clear-message {
        display: none;
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        padding: 30px;
        border-radius: 25px;
        margin: 30px 0;
        font-size: 1.8em;
        font-weight: bold;
        animation: lv7-celebration 1.5s ease;
        box-shadow: 0 10px 20px rgba(72,187,120,0.3);
    }

    .lv7-question-clear-message {
        display: none;
        background: linear-gradient(135deg, #4299e1, #3182ce);
        color: white;
        padding: 25px;
        border-radius: 20px;
        margin: 25px 0;
        font-size: 1.5em;
        font-weight: bold;
        animation: lv7-celebration 1s ease;
        box-shadow: 0 8px 15px rgba(66,153,225,0.3);
    }

    @keyframes lv7-celebration {
        0% { transform: scale(0.5) rotate(-5deg); opacity: 0; }
        50% { transform: scale(1.2) rotate(5deg); }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .lv7-instructions {
        background: linear-gradient(135deg, #f7fafc, #edf2f7);
        padding: 25px;
        border-radius: 20px;
        margin: 25px 0;
        font-size: 1.3em;
        color: #2b6cb0;
        font-weight: bold;
        border: 3px solid #90cdf4;
    }

    .lv7-score-info {
        display: flex;
        justify-content: space-between;
        margin: 25px 0;
        font-size: 1.4em;
        color: #2b6cb0;
        font-weight: bold;
    }

    .lv7-emoji {
        font-size: 1.5em;
        margin: 0 10px;
    }

    .lv7-cute-decoration {
        font-size: 2em;
        color: #4299e1;
        margin: 0 15px;
    }

    .lv7-question-counter {
        background: linear-gradient(135deg, #9f7aea, #805ad5);
        color: white;
        padding: 15px 25px;
        border-radius: 20px;
        margin: 20px 0;
        font-size: 1.5em;
        font-weight: bold;
        box-shadow: 0 8px 15px rgba(159,122,234,0.3);
    }




     /* ボーナスゲームのスタイル */
        .bonus-game-container {
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #bonus-gameCanvas {
            display: block;
            margin: 10px auto 0;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
            background: linear-gradient(180deg, #000011, #001122);
            max-width: 95vw;
            max-height: 85vh;
        }

        #bonus-ui {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        .bonus-game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 2000;
            box-shadow: 0 0 50px rgba(255, 107, 107, 0.8);
            animation: bonus-pulse 1s infinite;
        }

        @keyframes bonus-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .bonus-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .bonus-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }


        /* レスポンシブ対応 */
        @media (max-width: 1200px) {
            .lv1-container, .lv2-main-layout, .lv3-main-layout, .lv4-main-layout, .lv5-main-layout {
                flex-direction: column;
                gap: 20px;
            }
            
            .lv1-right-panel {
                flex: none;
            }
            
            .lv2-container, .lv3-container, .lv4-container, .lv5-container, .lv6-container {
                max-width: 800px;
            }

            .lv6-cards-container {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .lv1-container {
                flex-direction: column;
                gap: 15px;
            }

            .lv1-right-panel {
                flex: none;
            }

            .lv1-title, .lv2-title, .lv3-title, .lv4-title, .lv5-title, .lv6-title {
                font-size: 1.5em;
            }

            .lv1-formula-inputs, .lv2-formula-inputs, .lv3-formula-inputs, .lv4-formula-inputs, .lv5-formula-inputs {
                font-size: 1.1em;
                gap: 5px;
                flex-wrap: wrap;
            }

            .lv1-input, .lv2-input, .lv3-input, .lv4-input, .lv5-input {
                width: 50px;
                font-size: 1em;
                padding: 8px;
            }

            .lv1-btn, .lv2-button, .lv3-button, .lv4-button, .lv5-button {
                font-size: 1em;
                padding: 10px 20px;
            }

            .game-title {
                font-size: 2em;
            }

            .lv2-step, .lv3-step, .lv4-step, .lv5-step {
                font-size: 1em;
            }

            .lv2-cherry-display, .lv3-cherry-display, .lv4-cherry-display, .lv5-cherry-display {
                position: relative;
                top: 20px;
                left: 0;
                transform: none;
                margin: 20px 0;
            }

            .lv6-cards-container {
                flex-direction: column;
                align-items: center;
            }

            .lv6-column-wrapper {
                margin-bottom: 20px;
            }

            .lv6-problem-container {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>

 <!-- スタート画面 -->
<div id="start-screen" class="screen active">
    <h1 class="game-title">🌰 さんすうクエスト ひきざん 🌰</h1>
    <div class="button-container">
        <button class="main-btn" onclick="main_showModeSelect()">ゲームスタート</button>
    </div>
</div>
<!-- モード選択画面 -->
<div id="mode-select-screen" class="screen">
    <h1 class="game-title">モードを選んでね</h1>
    <div class="button-container">
        <button class="main-btn" onclick="main_showlvSelect()">れんしゅうモード</button>
        <button class="main-btn" onclick="main_startMatomeMode()" disabled>まとめモード</button>
        <button class="back-btn" onclick="main_showStart()">もどる</button>
    </div>
</div>
<!-- レベル選択画面 -->
<div id="lv-select-screen" class="screen">
    <h1 class="game-title">レベルをえらんでね</h1>
    <div class="lv-grid">
        <button class="lv-btn" onclick="main_startlv(1)">
            レベル 1<br>
            <small>くりさがりなし</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(2)">
            レベル 2<br>
            <small>くりさがりあり</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(3)">
            レベル 3<br>
            <small>ひきざん３</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(4)">
            レベル 4<br>
            <small>ひきざん４</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(5)">
            レベル 5<br>
            <small>ひきざん５</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(6)">
            レベル 6<br>
            <small>ひきざん６</small>
        </button>
        <button class="lv-btn" onclick="main_startlv(7)">
            レベル 7<br>
            <small>ひきざん７</small>
        </button>
    </div>
    <button class="back-btn" onclick="main_showModeSelect()">もどる</button>
</div>

<!-- レベル1画面 -->
<div id="lv1-screen" class="screen">
    <h1 class="lv1-title">🌰 ひきざん１ 🌰</h1>
    <div class="lv1-score">
        せいかい: <span id="lv1-correct-count">0</span>/3
    </div>

    <div class="lv1-container">
        <!-- 左側パネル：問題文とどんぐり -->
        <div class="lv1-left-panel">
            <div id="lv1-problem-area">
                <div class="lv1-problem">
                    <div id="lv1-problem-text"></div>
                    <div class="lv1-acorn-section">
                        <div><strong>さいしょの どんぐり</strong></div>
                        <div class="lv1-acorn-container lv1-initial-acorns" id="lv1-initial-acorns"></div>
                    </div>
                    <div class="lv1-acorn-section">
                        <div><strong>つかった どんぐり</strong></div>
                        <div class="lv1-acorn-container lv1-used-acorns" id="lv1-used-acorns">
                            <div class="lv1-workspace-label lv1-used-label">ここに つかった どんぐりを いれてね</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側パネル：式の入力とボタン -->
        <div class="lv1-right-panel">
            <div class="lv1-input-group">
                <label>しき:</label>
                <div class="lv1-formula-inputs">
                    <input type="number" class="lv1-input" id="lv1-formula-first" min="0" max="20">
                    <span>－</span>
                    <input type="number" class="lv1-input" id="lv1-formula-second" min="0" max="20">
                    <span>＝</span>
                    <input type="number" class="lv1-input" id="lv1-answer-input" min="0" max="20">
                </div>
            </div>
            <div class="lv1-buttons">
                <button class="lv1-btn lv1-check-btn" onclick="lv1_checkAnswer()">こたえあわせ</button>
            </div>
            <div id="lv1-result" class="lv1-result hidden"></div>
            <div class="lv1-buttons">
                <button class="lv1-btn lv1-next-btn hidden" id="lv1-next-btn" onclick="lv1_nextProblem()">つぎのもんだい</button>
            </div>
            <div class="lv1-buttons">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>
</div>


    <!-- レベル2画面 -->
    <div id="lv2-screen" class="screen">
        <div class="lv2-container">
            <h1 class="lv2-title">🌰 ひきざん２ 🌰</h1>
            
            <div class="lv2-score">
                せいかい: <span id="lv2-correct-count">0</span>/3
            </div>

            <div class="lv2-problem-text">
                <div id="lv2-problem-text"></div>
            </div>

            <div id="lv2-problem-area">
                <div class="lv2-main-layout">
                    <!-- 左エリア - どんぐりゾーン -->
                    <div class="lv2-left-section">
                        <h3>🌰 どんぐり 🌰</h3>
                        
                        <div class="lv2-person-section">
                            <h4><strong id="lv2-situation-label">はじめ</strong></h4>
                            <div class="lv2-acorn-container" id="lv2-acorns-initial"></div>
                        </div>
                        
                        <div class="lv2-person-section">
                            <h4><strong id="lv2-usage-label">つかった どんぐり</strong></h4>
                            <div class="lv2-acorn-container" id="lv2-acorns-used"></div>
                        </div>

                        <div class="lv2-person-section">
                            <h4><strong id="lv2-remaining-label">のこった どんぐり</strong></h4>
                            <div class="lv2-acorn-container" id="lv2-acorns-remaining"></div>
                        </div>
                    </div>

                    <!-- 真ん中エリア - 式とボタン -->
                    <div class="lv2-center-section">
                        <div class="lv2-formula-section">
                            <h3>しき</h3>
                            <div class="lv2-formula-inputs">
                                <span class="lv2-formula-number" id="lv2-formula-first-container">
                                    <input type="number" id="lv2-formula-first" class="lv2-input" min="11" max="18">
                                    <!-- さくらんぼ方式の表示 -->
                                    <div id="lv2-cherry-display" class="lv2-cherry-display">
                                        <div class="lv2-cherry-container">
                                            <div class="lv2-cherry-line"></div>
                                            <div class="lv2-cherry-branches">
                                                <div class="lv2-cherry-branch">
                                                    <div class="lv2-cherry-branch-line"></div>
                                                    <div class="lv2-cherry-value lv2-first" id="lv2-cherry-split1">１０</div>
                                                    <div class="lv2-remaining-value" id="lv2-remaining-from-ten"></div>
                                                </div>
                                                <div class="lv2-cherry-branch">
                                                    <div class="lv2-cherry-branch-line"></div>
                                                    <div class="lv2-cherry-value lv2-second" id="lv2-cherry-split2"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>－</span>
                                <span class="lv2-formula-number" id="lv2-formula-second-container">
                                    <input type="number" id="lv2-formula-second" class="lv2-input" min="2" max="9">
                                </span>
                                <span>＝</span>
                                <span>？</span>
                            </div>
                        </div>

                        <div class="lv2-buttons">
                            <button class="lv2-button lv2-check-btn" onclick="lv2_checkStep()">せいかいを かくにん</button>
                            <button class="lv2-button lv2-next-btn hidden" id="lv2-next-btn" onclick="lv2_nextProblem()">つぎのもんだい</button>
                            
                            <!-- メッセージ表示エリア -->
                            <div id="lv2-message" class="lv2-message"></div>
                        </div>
                    </div>

                    <!-- 右エリア - かんがえかた -->
                    <div class="lv2-right-section">
                        <div class="lv2-calculation-steps">
                            <h3>かんがえかた</h3>
                            <div class="lv2-step" id="lv2-step1">
                                <strong>①</strong> <span id="lv2-ones-digit"></span>から<span id="lv2-subtrahend1"></span>は ひけない。
                            </div>
                            <div class="lv2-step" id="lv2-step2">
                                <strong>②</strong> <span id="lv2-minuend-full"></span>を<span class="lv2-ten-block"><span class="lv2-ten-digit">１</span><span class="lv2-ten-digit">０</span></span>と<input type="number" id="lv2-step2-input" class="lv2-input" min="1" max="8">にわける。
                            </div>
                            <div class="lv2-step" id="lv2-step3">
                                <strong>③</strong> <span class="lv2-ten-block"><span class="lv2-ten-digit">１</span><span class="lv2-ten-digit">０</span></span>から<input type="number" id="lv2-step3-input1" class="lv2-input" min="2" max="9">をひくと<input type="number" id="lv2-step3-input2" class="lv2-input" min="1" max="8">
                                <div id="lv2-step3-result" class="lv2-step3-result-display"></div>
                            </div>
                            <div class="lv2-step" id="lv2-step4">
                                <strong>④</strong> <input type="number" id="lv2-step4-input1" class="lv2-input" min="1" max="8">と<input type="number" id="lv2-step4-input2" class="lv2-input" min="1" max="8">をあわせて<input type="number" id="lv2-step4-input3" class="lv2-input" min="2" max="9">
                            </div>
                            <div class="lv2-step" id="lv2-step5">
                                <strong>⑤</strong> <span id="lv2-final-minuend"></span>－<span id="lv2-final-subtrahend"></span>＝<input type="number" id="lv2-step5-input" class="lv2-input" min="2" max="9">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lv2-clear-area" class="hidden">
                <div class="lv2-result lv2-clear">
                    🎉 おめでとう！ 🎉<br>
                    ぜんぶせいかいです！
                </div>
                <button class="lv2-button lv2-restart-btn" onclick="lv2_restartGame()">もういちど</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>

    <!-- レベル3画面 -->
    <div id="lv3-screen" class="screen">
        <div class="lv3-container">
            <h1 class="lv3-title">🍊 ひきざん３ 🍊</h1>
            
            <div class="lv3-score">
                せいかい: <span id="lv3-correct-count">0</span>/5
            </div>

            <div id="lv3-problem-area">
                <div class="lv3-main-layout">
                    <!-- 左エリア - 式とボタン -->
                    <div class="lv3-left-section">
                        <div class="lv3-formula-section">
                            <h3>しき</h3>
                            <div class="lv3-formula-inputs">
                                <span class="lv3-formula-number" id="lv3-formula-first-container">
                                    <span class="lv3-formula-value" id="lv3-formula-first-value"></span>
                                    <!-- さくらんぼ方式の表示 -->
                                    <div id="lv3-cherry-display" class="lv3-cherry-display">
                                        <div class="lv3-cherry-container">
                                            <div class="lv3-cherry-line"></div>
                                            <div class="lv3-cherry-branches">
                                                <div class="lv3-cherry-branch">
                                                    <div class="lv3-cherry-branch-line"></div>
                                                    <div class="lv3-cherry-value lv3-first" id="lv3-cherry-split1"></div>
                                                </div>
                                                <div class="lv3-cherry-branch">
                                                    <div class="lv3-cherry-branch-line"></div>
                                                    <div class="lv3-cherry-value lv3-second" id="lv3-cherry-split2"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>－</span>
                                <span class="lv3-formula-number" id="lv3-formula-second-container">
                                    <span class="lv3-formula-value" id="lv3-formula-second-value"></span>
                                </span>
                            </div>
                        </div>

                        <div class="lv3-buttons">
                            <button class="lv3-button lv3-check-btn" onclick="lv3_checkStep()">せいかいを かくにん</button>
                            <button class="lv3-button lv3-next-btn hidden" id="lv3-next-btn" onclick="lv3_nextProblem()">つぎのもんだい</button>
                            <!-- メッセージ表示エリアをボタンの下に移動 -->
                            <div id="lv3-message" class="lv3-message"></div>
                        </div>
                    </div>

                    <!-- 右エリア - かんがえかた -->
                    <div class="lv3-right-section">
                        <div class="lv3-calculation-steps">
                            <h3>かんがえかた</h3>
                            <div class="lv3-step" id="lv3-step1">
                                <strong>①</strong> <span id="lv3-first-num"></span>を<span class="lv3-ten-block">１０</span>と<input type="number" id="lv3-step1-input" class="lv3-input" min="1" max="8">にわけます。
                            </div>
                            <div class="lv3-step" id="lv3-step2">
                                <strong>②</strong> <span class="lv3-ten-block">１０</span>から<span id="lv3-second-num"></span>をひくと<input type="number" id="lv3-step2-input" class="lv3-input" min="1" max="8">です。
                            </div>
                            <div class="lv3-step" id="lv3-step3">
                                <strong>③</strong> <span id="lv3-step2-result"></span>と<span id="lv3-ones-digit"></span>をあわせて、<input type="number" id="lv3-step3-input" class="lv3-input" min="1" max="9">です。
                            </div>
                            <div class="lv3-step" id="lv3-step4">
                                <strong>④</strong> <span id="lv3-final-first"></span>－<span id="lv3-final-second"></span>＝<span id="lv3-final-answer"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lv3-clear-area" class="hidden">
                <div class="lv3-result lv3-clear">
                    🎉 おめでとう！ 🎉<br>
                    ぜんぶせいかいです！
                </div>
                <button class="lv3-button lv3-restart-btn" onclick="lv3_restartGame()">もういちど</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>

    <!-- レベル4画面 -->
    <div id="lv4-screen" class="screen">
        <div class="lv4-container">
            <h1 class="lv4-title">🌰 ひきざん４ 🌰</h1>
            
            <div class="lv4-score">
                せいかい: <span id="lv4-correct-count">0</span>/3
            </div>

            <div class="lv4-problem-text">
                <div id="lv4-problem-text"></div>
            </div>

            <div id="lv4-problem-area">
                <div class="lv4-main-layout">
                    <!-- 左エリア - どんぐりゾーン -->
                    <div class="lv4-left-section">
                        <h3>🌰 どんぐり 🌰</h3>
                        
                        <div class="lv4-person-section">
                            <h4><strong id="lv4-situation-label">はじめ</strong></h4>
                            <div class="lv4-acorn-container" id="lv4-acorns-initial"></div>
                        </div>
                        
                        <div class="lv4-person-section">
                            <h4><strong id="lv4-usage-label">つかった どんぐり</strong></h4>
                            <div class="lv4-acorn-container" id="lv4-acorns-used"></div>
                        </div>

                        <div class="lv4-person-section">
                            <h4><strong id="lv4-remaining-label">のこった どんぐり</strong></h4>
                            <div class="lv4-acorn-container" id="lv4-acorns-remaining"></div>
                        </div>
                    </div>

                    <!-- 真ん中エリア - 式とボタン -->
                    <div class="lv4-center-section">
                        <div class="lv4-formula-section">
                            <h3>しき</h3>
                            <div class="lv4-formula-inputs">
                                <span class="lv4-formula-number" id="lv4-formula-first-container">
                                    <input type="number" id="lv4-formula-first" class="lv4-input" min="11" max="18">
                                    <!-- さくらんぼ方式の表示（被減数用） -->
                                    <div id="lv4-cherry-display-first" class="lv4-cherry-display">
                                        <div class="lv4-cherry-container">
                                            <div class="lv4-cherry-line"></div>
                                            <div class="lv4-cherry-branches">
                                                <div class="lv4-cherry-branch">
                                                    <div class="lv4-cherry-branch-line"></div>
                                                    <div class="lv4-cherry-value lv4-first" id="lv4-cherry-split1-first">１０</div>
                                                    <div class="lv4-remaining-value" id="lv4-remaining-from-ten-first"></div>
                                                </div>
                                                <div class="lv4-cherry-branch">
                                                    <div class="lv4-cherry-branch-line"></div>
                                                    <div class="lv4-cherry-value lv4-second" id="lv4-cherry-split2-first"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>－</span>
                                <span class="lv4-formula-number" id="lv4-formula-second-container">
                                    <input type="number" id="lv4-formula-second" class="lv4-input" min="2" max="9">
                                    <!-- さくらんぼ方式の表示（減数用） -->
                                    <div id="lv4-cherry-display-second" class="lv4-cherry-display">
                                        <div class="lv4-cherry-container">
                                            <div class="lv4-cherry-line"></div>
                                            <div class="lv4-cherry-branches">
                                                <div class="lv4-cherry-branch">
                                                    <div class="lv4-cherry-branch-line"></div>
                                                    <div class="lv4-cherry-value lv4-first" id="lv4-cherry-split1-second"></div>
                                                </div>
                                                <div class="lv4-cherry-branch">
                                                    <div class="lv4-cherry-branch-line"></div>
                                                    <div class="lv4-cherry-value lv4-second" id="lv4-cherry-split2-second"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>＝</span>
                                <span>？</span>
                            </div>
                        </div>

                        <div class="lv4-buttons">
                            <button class="lv4-button lv4-check-btn" onclick="lv4_checkStep()">せいかいを かくにん</button>
                            <button class="lv4-button lv4-next-btn hidden" id="lv4-next-btn" onclick="lv4_nextProblem()">つぎのもんだい</button>
                            
                            <!-- メッセージ表示エリア -->
                            <div id="lv4-message" class="lv4-message"></div>
                        </div>
                    </div>

                    <!-- 右エリア - かんがえかた -->
                    <div class="lv4-right-section">
                        <div class="lv4-calculation-steps">
                            <h3>かんがえかた</h3>
                            <div class="lv4-step" id="lv4-step1">
                                <strong>①</strong> <span id="lv4-ones-digit"></span>から<span id="lv4-subtrahend1"></span>は ひけない。
                            </div>
                            <div class="lv4-step" id="lv4-step2">
                                <strong>②</strong> <input type="number" id="lv4-step2-input" class="lv4-input" min="2" max="18">を<input type="number" id="lv4-step2-diamond" class="lv4-input" min="1" max="18">と<input type="number" id="lv4-step2-circle" class="lv4-input" min="1" max="18">にわける。
                            </div>
                            <div class="lv4-step" id="lv4-step3">
                                <strong>③</strong> <span id="lv4-step3-text-template"></span>
                            </div>
                            <div class="lv4-step" id="lv4-step4">
                                <strong>④</strong> <span id="lv4-step4-text-template"></span>
                            </div>
                            <div class="lv4-step" id="lv4-step5">
                                <strong>⑤</strong> <span id="lv4-final-minuend"></span>－<span id="lv4-final-subtrahend"></span>＝<input type="number" id="lv4-step5-input" class="lv4-input" min="2" max="9">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lv4-clear-area" class="hidden">
                <div class="lv4-result lv4-clear">
                    🎉 おめでとう！ 🎉<br>
                    ぜんぶせいかいです！
                </div>
                <button class="lv4-button lv4-restart-btn" onclick="lv4_restartGame()">もういちど</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>

    <!-- レベル5画面 -->
    <div id="lv5-screen" class="screen">
        <div class="lv5-container">
            <h1 class="lv5-title">🌰 ひきざん５ 🌰</h1>
            
            <div class="lv5-score">
                せいかい: <span id="lv5-correct-count">0</span>/3
            </div>

            <div id="lv5-problem-area">
                <div class="lv5-main-layout">
                    <!-- 左エリア - 式ゾーン -->
                    <div class="lv5-left-section">
                        <div class="lv5-formula-section">
                            <h3>しき</h3>
                            <div class="lv5-formula-inputs">
                                <span class="lv5-formula-number" id="lv5-formula-first-container">
                                    <span id="lv5-formula-first-display">15</span>
                                    <!-- さくらんぼ方式の表示（被減数用） -->
                                    <div id="lv5-cherry-display-first" class="lv5-cherry-display">
                                        <div class="lv5-cherry-container">
                                            <div class="lv5-cherry-line"></div>
                                            <div class="lv5-cherry-branches">
                                                <div class="lv5-cherry-branch">
                                                    <div class="lv5-cherry-branch-line"></div>
                                                    <div class="lv5-cherry-value lv5-first" id="lv5-cherry-split1-first">１０</div>
                                                </div>
                                                <div class="lv5-cherry-branch">
                                                    <div class="lv5-cherry-branch-line"></div>
                                                    <div class="lv5-cherry-value lv5-second" id="lv5-cherry-split2-first">5</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>－</span>
                                <span class="lv5-formula-number" id="lv5-formula-second-container">
                                    <span id="lv5-formula-second-display">7</span>
                                    <!-- さくらんぼ方式の表示（減数用） -->
                                    <div id="lv5-cherry-display-second" class="lv5-cherry-display">
                                        <div class="lv5-cherry-container">
                                            <div class="lv5-cherry-line"></div>
                                            <div class="lv5-cherry-branches">
                                                <div class="lv5-cherry-branch">
                                                    <div class="lv5-cherry-branch-line"></div>
                                                    <div class="lv5-cherry-value lv5-first" id="lv5-cherry-split1-second">5</div>
                                                </div>
                                                <div class="lv5-cherry-branch">
                                                    <div class="lv5-cherry-branch-line"></div>
                                                    <div class="lv5-cherry-value lv5-second" id="lv5-cherry-split2-second">2</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                                <span>＝</span>
                                <span>？</span>
                            </div>
                        </div>

                        <div class="lv5-buttons">
                            <button class="lv5-button lv5-check-btn" onclick="lv5_checkStep()">せいかいを かくにん</button>
                            <button class="lv5-button lv5-next-btn hidden" id="lv5-next-btn" onclick="lv5_nextProblem()">つぎのもんだい</button>
                            
                            <!-- メッセージ表示エリア -->
                            <div id="lv5-message" class="lv5-message"></div>
                        </div>
                    </div>

                    <!-- 右エリア - かんがえかた -->
                    <div class="lv5-right-section">
                        <div class="lv5-calculation-steps">
                            <h3>かんがえかた</h3>
                            <div class="lv5-step" id="lv5-step1">
                                <strong>①</strong> <input type="number" id="lv5-step1-input" class="lv5-input" min="2" max="18">を<input type="number" id="lv5-step1-diamond" class="lv5-input" min="1" max="18">と<input type="number" id="lv5-step1-circle" class="lv5-input" min="1" max="18">にわける。
                            </div>
                            <div class="lv5-step" id="lv5-step2">
                                <strong>②</strong> <span id="lv5-step2-text-template"></span>
                            </div>
                            <div class="lv5-step" id="lv5-step3">
                                <strong>③</strong> <span id="lv5-final-minuend">15</span>－<span id="lv5-final-subtrahend">7</span>＝<input type="number" id="lv5-step3-input" class="lv5-input" min="2" max="9">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="lv5-clear-area" class="hidden">
                <div class="lv5-result lv5-clear">
                    🎉 おめでとう！ 🎉<br>
                    ぜんぶせいかいです！
                </div>
                <button class="lv5-button lv5-restart-btn" onclick="lv5_restartGame()">もういちど</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>

    <!-- レベル6画面 -->
    <div id="lv6-screen" class="screen">
        <div class="lv6-container">
            <div class="lv6-header">
                <h1 class="lv6-title">ひきざん６</h1>
            </div>
            <div class="lv6-progress">
                <span id="lv6-progress-text">もんだい 1 / 64</span>
            </div>
            <div class="lv6-problem-area" id="lv6-problem-area">
                <div class="lv6-problem-container">
                    <span id="lv6-problem-left"></span>
                    <span>＝</span>
                    <input type="text" class="lv6-answer-input" id="lv6-answer" maxlength="1">
                </div>
                <div class="lv6-message" id="lv6-message"></div>
            </div>
            <button class="lv6-sort-button" id="lv6-sort-button">なんべらえかえ</button>
            <div class="lv6-cards-container" id="lv6-cards-container">
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">9</div>
                    <div class="lv6-column" data-answer="9"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">8</div>
                    <div class="lv6-column" data-answer="8"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">7</div>
                    <div class="lv6-column" data-answer="7"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">6</div>
                    <div class="lv6-column" data-answer="6"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">5</div>
                    <div class="lv6-column" data-answer="5"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">4</div>
                    <div class="lv6-column" data-answer="4"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">3</div>
                    <div class="lv6-column" data-answer="3"></div>
                </div>
                <div class="lv6-column-wrapper">
                    <div class="lv6-column-label">2</div>
                    <div class="lv6-column" data-answer="2"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="back-btn" onclick="main_backFromlv()">もどる</button>
            </div>
        </div>
    </div>

<!-- レベル7画面 -->
<div id="lv7-screen" class="screen">
    <div class="lv7-container">
        <h1 class="lv7-title">🌊 ひきざん７ 🌊</h1>
        <div class="lv7-game-screen" id="lv7-gameScreen">
            <div class="lv7-instructions">
                <span class="lv7-cute-decoration">⭐</span>
                <strong>ひいて こたえのかずになる ペアをみつけて つなげよう！</strong>
                <span class="lv7-cute-decoration">⭐</span>
                <br>
                <span class="lv7-emoji">✨</span>すべてのカードを けして １もんせいかい！３もんせいかいで クリアー<span class="lv7-emoji">✨</span>
            </div>
            <div class="lv7-question-counter" id="lv7-questionCounter">
                もんだい 1 / 3
            </div>
            <div class="lv7-score-info">
                <div>🎯 こたえ: <span class="lv7-target-number" id="lv7-targetNumber"></span></div>
                <div>💎 せいかい: <span id="lv7-correctCount">0</span> / 3</div>
            </div>
            <div class="lv7-score-info">
                <div>📦 のこりカード: <span id="lv7-remainingCards">10</span></div>
                <div>✅ みつけたペア: <span id="lv7-foundPairs">0</span></div>
            </div>
            <div class="lv7-number-grid" id="lv7-numberGrid"></div>

<!-- 追加：もんだいをかえるボタン -->
<div style="text-align: center; margin: 20px 0;">
    <button class="lv7-button" onclick="lv7_changeQuestion()" id="lv7-changeButton">
        🔄 もんだいを かえる 🔄
    </button>
</div>


            <div class="lv7-question-clear-message" id="lv7-questionClearMessage">
                🎉 １もんせいかい！ 🎉
                <br>
                すべてのペアを みつけました！
            </div>
            <div class="lv7-clear-message" id="lv7-clearMessage">
                🎉✨ おめでとう！ ✨🎉
                <br>
                ３もんだい すべて せいかい！
                <br>
                🌟 とってもじょうず 🌟
            </div>
            <button class="lv7-button" onclick="lv7_nextQuestion()" id="lv7-nextButton" style="display: none;">✨ つぎのもんだい ✨</button>
            <button class="lv7-button" onclick="lv7_restartGame()" id="lv7-restartButton" style="display: none;">🔄 もういちど あそぶ 🔄</button>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="back-btn" onclick="main_backFromlv()">もどる</button>
        </div>
    </div>
</div>


    <!-- ボーナスゲーム画面 -->
    <div id="bonus-game-screen" class="screen">
        <div class="bonus-game-container">
            <div id="bonus-ui">
                <div>スコア: <span id="bonus-score">0</span></div>
                <div>じかん: <span id="bonus-timer">60</span>びょう</div>
                <div>ライフ: <span id="bonus-lives">❤️❤️❤️</span></div>
                <div>パワー: <span id="bonus-power">Lv.0</span></div>
            </div>
            <div id="bonus-game-over" class="bonus-game-over">
                <h2>ゲームしゅうりょう！</h2>
                <p>スコア: <span id="bonus-final-score">0</span></p>
                <button class="bonus-btn" onclick="bonus_endGame()">つぎへ</button>
            </div>
            <canvas id="bonus-gameCanvas" width="1200" height="800"></canvas>
        </div>
    </div>

    <!-- ゲームクリア画面 -->
    <div id="game-clear-screen" class="screen">
        <h1 class="game-title">🎉 ゲームクリア！ 🎉</h1>
        <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; color: #2d3436;">
            <h2 style="margin-bottom: 20px;">おめでとう！</h2>
            <p style="font-size: 1.2em; margin-bottom: 15px;">すべてのレベルをクリアしました！</p>
            <p style="font-size: 1.5em; font-weight: bold; color: #00b894;">
                総ボーナススコア: <span id="total-bonus-score">0</span>点
            </p>
        </div>
        <button class="main-btn" onclick="main_showStart()" style="margin-top: 30px;">スタート画面にもどる</button>
    </div>

    <script>
        // グローバル状態管理
        let main_gameState = {
            currentMode: null, // 'practice' or 'matome'
            currentlv: 1,
            clearedlvs: [], // クリア済みレベル（ローカルストレージから読み込み）
            totalBonusScore: 0,
            bonusScores: [] // 各レベルのボーナススコア
        };

        // ローカルストレージからクリア状態を読み込み
        function main_loadClearedlvs() {
            const saved = localStorage.getItem('mathQuest_clearedlvs');
            if (saved) {
                try {
                    main_gameState.clearedlvs = JSON.parse(saved);
                } catch (e) {
                    main_gameState.clearedlvs = [];
                }
            }
        }

        // ローカルストレージにクリア状態を保存
        function main_saveClearedlvs() {
            localStorage.setItem('mathQuest_clearedlvs', JSON.stringify(main_gameState.clearedlvs));
        }

        // メイン画面制御
        function main_showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function main_showStart() {
            main_showScreen('start-screen');
        }


// まとめモードボタンの状態を更新する関数
function main_updateMatomeButton() {
    const matomeBtn = document.querySelector('button[onclick="main_startMatomeMode()"]');
    const totalLevels = 7; // 全レベル数
    const allLevelsCleared = main_gameState.clearedlvs.length === totalLevels;
    
    if (allLevelsCleared) {
        matomeBtn.disabled = false;
        matomeBtn.textContent = 'まとめモード';
        matomeBtn.style.opacity = '1';
    } else {
        matomeBtn.disabled = true;
        matomeBtn.textContent = `まとめモード (${main_gameState.clearedlvs.length}/${totalLevels})`;
        matomeBtn.style.opacity = '0.5';
    }
}



function main_showModeSelect() {
    main_showScreen('mode-select-screen');
    main_updateMatomeButton(); // この行を追加
}

        function main_showlvSelect() {
            main_gameState.currentMode = 'practice';
            main_updatelvButtons();
            main_showScreen('lv-select-screen');
        }

       function main_startMatomeMode() {
    // 全レベルクリアしているかチェック
    if (main_gameState.clearedlvs.length < 7) {
        alert('すべてのレベルをクリアしてから まとめモードに ちょうせんしてね！');
        return;
    }
    
    main_gameState.currentMode = 'matome';
    main_gameState.currentlv = 1;
    main_gameState.totalBonusScore = 0;
    main_gameState.bonusScores = [];
    main_startlv(1);
}

        function main_startlv(lv) {
            main_gameState.currentlv = lv;
            if (lv === 1) {
                lv1_initGame();
                main_showScreen('lv1-screen');
            } else if (lv === 2) {
                lv2_initGame();
                main_showScreen('lv2-screen');
            } else if (lv === 3) {
                lv3_initGame();
                main_showScreen('lv3-screen');
            } else if (lv === 4) {
                lv4_initGame();
                main_showScreen('lv4-screen');
            } else if (lv === 5) {
                lv5_initGame();
                main_showScreen('lv5-screen');
            } else if (lv === 6) {
                lv6_initGame();
                main_showScreen('lv6-screen');
           } else if (lv === 7) {
            lv7_initGame();
            main_showScreen('lv7-screen');
        }
    }








        function main_backFromlv() {
            if (main_gameState.currentMode === 'practice') {
                main_showlvSelect();
            } else {
                main_showModeSelect();
            }
        }

        function main_updatelvButtons() {
            const lvButtons = document.querySelectorAll('.lv-btn');
            lvButtons.forEach((btn, index) => {
                const lv = index + 1;
                if (main_gameState.clearedlvs.includes(lv)) {
                    btn.classList.add('cleared');
                } else {
                    btn.classList.remove('cleared');
                }
            });
        }

     function main_lvCleared(lv) {
    if (!main_gameState.clearedlvs.includes(lv)) {
        main_gameState.clearedlvs.push(lv);
        main_saveClearedlvs(); // ローカルストレージに保存
    }

    if (main_gameState.currentMode === 'matome') {
        // まとめモードの場合、ボーナスゲームへ
        const bonusTime = (lv === 7) ? 180 : 60; // レベル7は3分、他は1分
        bonus_startGame(bonusTime);
    } else {
        // れんしゅうモードの場合、レベル選択に戻る
        main_showlvSelect();
        // モード選択に戻る際にまとめボタンの状態を更新
        setTimeout(() => {
            main_updateMatomeButton();
        }, 100);
    }
}

        function main_bonusGameEnded(score) {
            main_gameState.bonusScores.push(score);
            main_gameState.totalBonusScore += score;

            if (main_gameState.currentMode === 'matome') {
                if (main_gameState.currentlv === 7) {
                    // ゲームクリア
                    document.getElementById('total-bonus-score').textContent = main_gameState.totalBonusScore;
                    main_showScreen('game-clear-screen');
                } else {
                    // 次のレベルへ
                    main_gameState.currentlv++;
                    main_startlv(main_gameState.currentlv);
                }
            }
        }

        // レベル1の実装
        let lv1_currentProblem = {};
        let lv1_correctCount = 0;
        let lv1_totalProblems = 3;
        let lv1_draggedElement = null;
        let lv1_isProcessing = false;

        function lv1_initGame() {
            lv1_correctCount = 0;
            lv1_totalProblems = 3;
            lv1_isProcessing = false;
            lv1_draggedElement = null;
            document.getElementById('lv1-correct-count').textContent = '0';
            document.getElementById('lv1-formula-first').value = '';
            document.getElementById('lv1-formula-second').value = '';
            document.getElementById('lv1-answer-input').value = '';
            document.getElementById('lv1-result').classList.add('hidden');
            document.getElementById('lv1-next-btn').classList.add('hidden');
            document.querySelector('.lv1-check-btn').disabled = false;
            lv1_generateProblem();
        }

        function lv1_reorganizeAcorns(container) {
            const acorns = Array.from(container.querySelectorAll('.lv1-acorn'));
            container.innerHTML = '';

            if (container.id === 'lv1-used-acorns' && acorns.length === 0) {
                const label = document.createElement('div');
                label.className = 'lv1-workspace-label lv1-used-label';
                label.textContent = 'ここに つかった どんぐりを いれてね';
                label.style.pointerEvents = 'none';
                container.appendChild(label);
                return;
            }

            let currentRow = null;
            acorns.forEach((acorn, i) => {
                if (i % 10 === 0) {
                    currentRow = document.createElement('div');
                    currentRow.style.display = 'flex';
                    currentRow.style.flexWrap = 'wrap';
                    currentRow.style.justifyContent = 'flex-start';
                    currentRow.style.gap = '4px';
                    currentRow.style.marginBottom = '4px';
                    container.appendChild(currentRow);
                }

                acorn.addEventListener('mousedown', lv1_handleMouseDown);
                currentRow.appendChild(acorn);
            });
        }

        function lv1_createInitialAcorns(count) {
            const container = document.getElementById('lv1-initial-acorns');
            container.innerHTML = '';

            let currentRow = null;
            for (let i = 0; i < count; i++) {
                if (i % 10 === 0) {
                    currentRow = document.createElement('div');
                    currentRow.style.display = 'flex';
                    currentRow.style.flexWrap = 'wrap';
                    currentRow.style.justifyContent = 'flex-start';
                    currentRow.style.gap = '4px';
                    currentRow.style.marginBottom = '4px';
                    container.appendChild(currentRow);
                }

                const acorn = document.createElement('div');
                acorn.className = 'lv1-acorn';
                acorn.innerHTML = '🌰';
                acorn.dataset.index = i;
                acorn.addEventListener('mousedown', lv1_handleMouseDown);
                currentRow.appendChild(acorn);
            }
        }

        function lv1_generateProblem() {
            let minuend, subtrahend, difference;
            let validProblem = false;

            while (!validProblem) {
                minuend = Math.floor(Math.random() * 18) + 2;

                if (minuend >= 10) {
                    let minuendOnes = minuend % 10;
                    if (minuendOnes > 1) {
                        let maxSubtrahend = minuendOnes - 1;
                        subtrahend = Math.floor(Math.random() * maxSubtrahend) + 1;
                        difference = minuend - subtrahend;
                        validProblem = true;
                    }
                } else {
                    subtrahend = Math.floor(Math.random() * (minuend - 1)) + 1;
                    difference = minuend - subtrahend;
                    validProblem = true;
                }
            }

            lv1_currentProblem = { minuend, subtrahend, difference };

            document.getElementById('lv1-problem-text').innerHTML = `
                どんぐりを つかって、こうさくを します。<br>
                <strong>${minuend}</strong> こ あります。<br>
                <strong>${subtrahend}</strong> こ つかいました。<br>
                どんぐりは なんこ のこって いますか？
            `;

            lv1_createInitialAcorns(minuend);
            const usedContainer = document.getElementById('lv1-used-acorns');
            usedContainer.innerHTML = '';
           lv1_reorganizeAcorns(usedContainer);
    
    // 前項の入力フィールドにフォーカスを設定
    setTimeout(() => {
        document.getElementById('lv1-formula-first').focus();
    }, 100);
}

        let lv1_isDragging = false;
        let lv1_dragOffset = { x: 0, y: 0 };

        function lv1_handleMouseDown(e) {
            lv1_isDragging = true;
            lv1_draggedElement = e.target;
            e.target.classList.add('lv1-dragging');
            const rect = e.target.getBoundingClientRect();
            lv1_dragOffset.x = e.clientX - rect.left - rect.width / 2;
            lv1_dragOffset.y = e.clientY - rect.top - rect.height / 2;
            document.addEventListener('mousemove', lv1_handleMouseMove);
            document.addEventListener('mouseup', lv1_handleMouseUp);
            e.preventDefault();
        }

        function lv1_handleMouseMove(e) {
            if (!lv1_isDragging || !lv1_draggedElement) return;
            lv1_draggedElement.style.position = 'fixed';
            lv1_draggedElement.style.left = (e.clientX - lv1_dragOffset.x) + 'px';
            lv1_draggedElement.style.top = (e.clientY - lv1_dragOffset.y) + 'px';
            lv1_draggedElement.style.zIndex = '1000';

            const rect1 = document.getElementById('lv1-initial-acorns').getBoundingClientRect();
            const rect2 = document.getElementById('lv1-used-acorns').getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            document.getElementById('lv1-initial-acorns').classList.remove('lv1-drop-zone');
            document.getElementById('lv1-used-acorns').classList.remove('lv1-drop-zone');

            if (mouseX >= rect1.left && mouseX <= rect1.right && 
                mouseY >= rect1.top && mouseY <= rect1.bottom) {
                document.getElementById('lv1-initial-acorns').classList.add('lv1-drop-zone');
            } else if (mouseX >= rect2.left && mouseX <= rect2.right && 
                       mouseY >= rect2.top && mouseY <= rect2.bottom) {
                document.getElementById('lv1-used-acorns').classList.add('lv1-drop-zone');
            }
        }

        function lv1_handleMouseUp(e) {
            if (!lv1_isDragging || !lv1_draggedElement) return;
            lv1_isDragging = false;
            lv1_draggedElement.classList.remove('lv1-dragging');

            const rect1 = document.getElementById('lv1-initial-acorns').getBoundingClientRect();
            const rect2 = document.getElementById('lv1-used-acorns').getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            let dropZone = null;

            if (mouseX >= rect1.left && mouseX <= rect1.right && 
                mouseY >= rect1.top && mouseY <= rect1.bottom) {
                dropZone = document.getElementById('lv1-initial-acorns');
            } else if (mouseX >= rect2.left && mouseX <= rect2.right && 
                       mouseY >= rect2.top && mouseY <= rect2.bottom) {
                dropZone = document.getElementById('lv1-used-acorns');
            }

            if (dropZone) {
                lv1_draggedElement.style.position = '';
                lv1_draggedElement.style.left = '';
                lv1_draggedElement.style.top = '';
                lv1_draggedElement.style.zIndex = '';

                const label = dropZone.querySelector('.lv1-workspace-label');
                if (label) {
                    label.remove();
                }

                dropZone.appendChild(lv1_draggedElement);
                lv1_reorganizeAcorns(dropZone);
                
                document.getElementById('lv1-initial-acorns').classList.remove('lv1-drop-zone');
                document.getElementById('lv1-used-acorns').classList.remove('lv1-drop-zone');
            } else {
                lv1_draggedElement.style.position = '';
                lv1_draggedElement.style.left = '';
                lv1_draggedElement.style.top = '';
                lv1_draggedElement.style.zIndex = '';
            }

            lv1_draggedElement = null;
            document.removeEventListener('mousemove', lv1_handleMouseMove);
            document.removeEventListener('mouseup', lv1_handleMouseUp);
        }

        function lv1_checkAnswer() {
            if (lv1_isProcessing) return;
            lv1_isProcessing = true;

            const checkBtn = document.querySelector('.lv1-check-btn');
            checkBtn.disabled = true;

            let first = parseInt(document.getElementById('lv1-formula-first').value) || 0;
            let second = parseInt(document.getElementById('lv1-formula-second').value) || 0;
            let answer = parseInt(document.getElementById('lv1-answer-input').value) || 0;

            let isFormulaCorrect = (first === lv1_currentProblem.minuend && second === lv1_currentProblem.subtrahend);
            let isAnswerCorrect = answer === lv1_currentProblem.difference;

            let resultDiv = document.getElementById('lv1-result');
            resultDiv.classList.remove('hidden');

            if (isFormulaCorrect && isAnswerCorrect) {
                lv1_correctCount++;
                resultDiv.className = 'lv1-result lv1-correct';
                resultDiv.innerHTML = '🎉 せいかい！ よくできました！';
                document.getElementById('lv1-correct-count').textContent = lv1_correctCount;
                
                if (lv1_correctCount >= lv1_totalProblems) {
                    setTimeout(() => {
                        main_lvCleared(1);
                        lv1_isProcessing = false;
                    }, 1500);
                } else {
                    document.getElementById('lv1-next-btn').classList.remove('hidden');
                    setTimeout(() => {
                        lv1_isProcessing = false;
                    }, 1000);
                }
            } else {
                resultDiv.className = 'lv1-result lv1-incorrect';
                let message = 'ざんねん。';
                if (!isFormulaCorrect && !isAnswerCorrect) {
                    message += '<br>しきと こたえを かくにんしてね。';
                } else if (!isFormulaCorrect) {
                    message += '<br>しきを かくにんしてね。';
                } else {
                    message += '<br>こたえを かくにんしてね。';
                }
                resultDiv.innerHTML = message;
                document.getElementById('lv1-next-btn').classList.remove('hidden');
                setTimeout(() => {
                    lv1_isProcessing = false;
                }, 1000);
            }
        }

        function lv1_nextProblem() {
            if (lv1_isProcessing) return;
            lv1_isProcessing = true;

            const nextBtn = document.getElementById('lv1-next-btn');
            nextBtn.disabled = true;

            document.getElementById('lv1-formula-first').value = '';
            document.getElementById('lv1-formula-second').value = '';
            document.getElementById('lv1-answer-input').value = '';
            document.getElementById('lv1-result').classList.add('hidden');
            document.getElementById('lv1-next-btn').classList.add('hidden');
            lv1_generateProblem();

            const checkBtn = document.querySelector('.lv1-check-btn');
            checkBtn.disabled = false;

            setTimeout(() => {
                nextBtn.disabled = false;
                lv1_isProcessing = false;
            }, 500);
        }

        // レベル2の実装
        let lv2_currentProblem = {};
        let lv2_correctCount = 0;
        let lv2_totalProblems = 3;
        let lv2_currentStep = 0;
        let lv2_stepValues = {};
        let lv2_isProcessing = false;
        let lv2_cherryDisplayShown = false;

        function lv2_initGame() {
            lv2_correctCount = 0;
            lv2_totalProblems = 3;
            lv2_currentStep = 0;
            lv2_isProcessing = false;
            lv2_cherryDisplayShown = false;
            document.getElementById('lv2-correct-count').textContent = '0';
            document.getElementById('lv2-problem-area').classList.remove('hidden');
            document.getElementById('lv2-clear-area').classList.add('hidden');
            lv2_generateProblem();
        }

        // メッセージ表示機能
        function lv2_showMessage(text, type) {
            const messageElement = document.getElementById('lv2-message');
            messageElement.textContent = text;
            messageElement.className = `lv2-message lv2-${type} lv2-show`;
            
            setTimeout(() => {
                messageElement.classList.remove('lv2-show');
            }, 3000);
        }

        function lv2_hideMessage() {
            const messageElement = document.getElementById('lv2-message');
            messageElement.classList.remove('lv2-show');
        }

        // さくらんぼ方式の表示を更新（③のときに▲を表示）
        function lv2_updateCherryDisplay(showRemaining = false) {
            document.getElementById('lv2-cherry-split2').textContent = lv2_stepValues.onesDigit;
            
            const remainingElement = document.getElementById('lv2-remaining-from-ten');
            if (showRemaining) {
                remainingElement.textContent = lv2_stepValues.remaining;
                remainingElement.style.display = 'block';
            } else {
                remainingElement.style.display = 'none';
            }
        }

        // 式の被減数を強調表示
        function lv2_highlightFormulaFirst() {
            const formulaFirst = document.getElementById('lv2-formula-first');
            formulaFirst.classList.add('lv2-formula-first-highlight');
            
            setTimeout(() => {
                formulaFirst.classList.remove('lv2-formula-first-highlight');
            }, 2500);
        }

        // さくらんぼ方式のアニメーション表示（②のとき）
        function lv2_showCherryAnimation() {
            const cherryDisplay = document.getElementById('lv2-cherry-display');
            lv2_updateCherryDisplay(false); // ②のときは▲を表示しない
            
            lv2_highlightFormulaFirst();
            
            cherryDisplay.classList.add('lv2-show');
            lv2_cherryDisplayShown = true;
        }

        // ③のときに▲を表示
        function lv2_showRemainingValue() {
            lv2_updateCherryDisplay(true); // ③のときに▲を表示
        }

        // 斜線アニメーションを表示
        function lv2_showStrikethroughAnimation() {
            const tenValue = document.getElementById('lv2-cherry-split1');
            tenValue.classList.add('lv2-crossed');
        }

        // ③のステップで結果を表示
        function lv2_showStep3Result() {
            const resultDiv = document.getElementById('lv2-step3-result');
            resultDiv.innerHTML = `
                <span class="lv2-step3-ten-block lv2-crossed">１０</span>
                <span>→</span>
                <span class="lv2-step3-result-number">${lv2_stepValues.remaining}</span>
            `;
            resultDiv.classList.add('lv2-show');
        }

        // ④のステップでしきウインドーの楕円アニメーション
        function lv2_showFormulaOvalAnimation() {
            const remainingValue = document.getElementById('lv2-remaining-from-ten');
            const onesValue = document.getElementById('lv2-cherry-split2');
            
            if (!remainingValue || !onesValue || remainingValue.style.display === 'none') {
                console.log('要素が見つからないか、非表示です');
                return;
            }
            
            const formulaSection = document.querySelector('.lv2-formula-section');
            
            // 要素が完全に描画されてから位置を取得
            setTimeout(() => {
                // 既存の楕円を削除
                const existingOvals = formulaSection.querySelectorAll('.lv2-formula-oval-highlight');
                existingOvals.forEach(oval => oval.remove());
                
                // 要素の位置を取得
                const formulaRect = formulaSection.getBoundingClientRect();
                const remainingRect = remainingValue.getBoundingClientRect();
                const onesRect = onesValue.getBoundingClientRect();
                
                // formulaSectionを基準とした相対座標で▲と◆の中心位置を計算
                const remainingCenterX = remainingRect.left - formulaRect.left + remainingRect.width / 2;
                const remainingCenterY = remainingRect.top - formulaRect.top + remainingRect.height / 2;
                const onesCenterX = onesRect.left - formulaRect.left + onesRect.width / 2;
                const onesCenterY = onesRect.top - formulaRect.top + onesRect.height / 2;
                
                // 楕円の中心点（▲と◆の中点）
                const ovalCenterX = (remainingCenterX + onesCenterX) / 2;
                const ovalCenterY = (remainingCenterY + onesCenterY) / 2;
                
                // ▲と◆を結ぶ直線の角度を計算
                const deltaX = onesCenterX - remainingCenterX;
                const deltaY = onesCenterY - remainingCenterY;
                const angleInRadians = Math.atan2(deltaY, deltaX);
                const angleInDegrees = angleInRadians * (180 / Math.PI);
                
                // 楕円のサイズ（距離に基づいて調整）
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const ovalWidth = Math.max(distance + 100, 140);
                const ovalHeight = 60;
                
                // 楕円要素を作成
                const oval = document.createElement('div');
                oval.className = 'lv2-formula-oval-highlight';
                oval.style.position = 'absolute';
                oval.style.left = (ovalCenterX - ovalWidth / 2) + 'px';
                oval.style.top = (ovalCenterY - ovalHeight / 2) + 'px';
                oval.style.width = ovalWidth + 'px';
                oval.style.height = ovalHeight + 'px';
                
                // 初期状態の設定（小さく、透明）
                oval.style.transform = `rotate(${angleInDegrees}deg) scale(0.3)`;
                oval.style.opacity = '0';
                
                // formulaSectionに楕円を追加
                formulaSection.style.position = 'relative';
                formulaSection.appendChild(oval);
                
                // アニメーション開始
                requestAnimationFrame(() => {
                    // 少し待ってからアニメーション
                    setTimeout(() => {
                        oval.style.transform = `rotate(${angleInDegrees}deg) scale(1)`;
                        oval.style.opacity = '0.8';
                        oval.style.boxShadow = '0 0 20px rgba(0, 184, 148, 0.5)';
                    }, 50);
                });
            }, 800); // 遅延を増やして確実に要素が表示されるのを待つ
        }

        function lv2_hideCherryDisplay() {
            const cherryDisplay = document.getElementById('lv2-cherry-display');
            cherryDisplay.classList.remove('lv2-show');
            
            // ▲を非表示にリセット
            const remainingElement = document.getElementById('lv2-remaining-from-ten');
            if (remainingElement) {
                remainingElement.style.display = 'none';
            }
            
            lv2_cherryDisplayShown = false;
        }

        // 問題を生成する関数
        function lv2_generateProblem() {
            lv2_hideMessage();
            lv2_hideCherryDisplay();
            
            // 全てのアニメーション要素をクリア
            const formulaSection = document.querySelector('.lv2-formula-section');
            const existingOvals = formulaSection.querySelectorAll('.lv2-formula-oval-highlight');
            existingOvals.forEach(oval => oval.remove());
            
            // cherry-split1 の crossed クラスを削除
            const cherryTen = document.getElementById('lv2-cherry-split1');
            if (cherryTen) {
                cherryTen.classList.remove('lv2-crossed');
            }
            
            let minuend, subtrahend, difference;
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                minuend = Math.floor(Math.random() * 8) + 11; // 11-18
                subtrahend = Math.floor(Math.random() * 8) + 2; // 2-9
                difference = minuend - subtrahend;
                attempts++;
                
                const onesDigit = minuend % 10;
                
                // 条件：
                // 1. 差が2-9の範囲
                // 2. 繰り下がりが必要（1の位の数字 < 減数）
                if (difference >= 2 && difference <= 9 && onesDigit < subtrahend) {
                    break;
                }
                
            } while (attempts < maxAttempts);
            
            if (attempts >= maxAttempts) {
                minuend = 15;
                subtrahend = 7;
                difference = 8;
            }

            lv2_currentProblem = { minuend, subtrahend, difference };
            lv2_currentStep = 0;
            lv2_isProcessing = false;
            lv2_cherryDisplayShown = false;
            
            const onesDigit = minuend % 10;
            const tensDigit = Math.floor(minuend / 10);
            const remaining = 10 - subtrahend;
            
            lv2_stepValues = {
                onesDigit: onesDigit,
                tensDigit: tensDigit,
                remaining: remaining,
                finalAnswer: remaining + onesDigit
            };
            
            document.getElementById('lv2-problem-text').innerHTML = `
                どんぐりを つかって、こうさくを します。<br>
                <strong>${minuend}</strong>こ あります。<strong>${subtrahend}</strong>こ つかいました。<br>
                どんぐりは なんこ のこって いますか？
            `;

            // どんぐりを表示
            lv2_createAcorns('lv2-acorns-initial', minuend);
            lv2_createAcorns('lv2-acorns-used', 0);
            lv2_createAcorns('lv2-acorns-remaining', 0);
            
            lv2_resetSteps();
            lv2_showStep(0);
            
            setTimeout(() => {
                document.getElementById('lv2-formula-first').focus();
            }, 100);
        }

        // ステップ表示を初期化
        function lv2_resetSteps() {
            document.querySelectorAll('.lv2-step').forEach(step => {
                step.classList.remove('lv2-active');
            });
            
            document.getElementById('lv2-ones-digit').textContent = lv2_stepValues.onesDigit;
            document.getElementById('lv2-subtrahend1').textContent = lv2_currentProblem.subtrahend;
            document.getElementById('lv2-minuend-full').textContent = lv2_currentProblem.minuend;
            document.getElementById('lv2-final-minuend').textContent = lv2_currentProblem.minuend;
            document.getElementById('lv2-final-subtrahend').textContent = lv2_currentProblem.subtrahend;
            
            // ③のステップ結果表示をリセット
            const step3Result = document.getElementById('lv2-step3-result');
            if (step3Result) {
                step3Result.classList.remove('lv2-show');
                step3Result.innerHTML = '';
            }
            
            // さくらんぼ表示で▲を非表示にリセット
            const remainingElement = document.getElementById('lv2-remaining-from-ten');
            if (remainingElement) {
                remainingElement.style.display = 'none';
            }
            
            // 入力フィールドをクリア
            document.getElementById('lv2-step2-input').value = '';
            document.getElementById('lv2-step3-input1').value = '';
            document.getElementById('lv2-step3-input2').value = '';
            document.getElementById('lv2-step4-input1').value = '';
            document.getElementById('lv2-step4-input2').value = '';
            document.getElementById('lv2-step4-input3').value = '';
            document.getElementById('lv2-step5-input').value = '';
            
            // 式の入力フィールドをクリア
            document.getElementById('lv2-formula-first').value = '';
            document.getElementById('lv2-formula-second').value = '';
            
            // ボタンを表示
            document.querySelector('.lv2-check-btn').style.display = 'block';
            document.getElementById('lv2-next-btn').classList.add('hidden');
        }

        function lv2_showStep(stepNum) {
            lv2_currentStep = stepNum;
            if (stepNum === 0) {
                document.querySelectorAll('.lv2-step').forEach(step => {
                    step.classList.remove('lv2-active');
                });
            } else {
                document.getElementById(`lv2-step${stepNum}`).classList.add('lv2-active');
            }
        }

        function lv2_focusNextInput(delay = 300) {
            setTimeout(() => {
                let nextInput = null;
                
                if (lv2_currentStep === 2) {
                    nextInput = document.getElementById('lv2-step2-input');
                } else if (lv2_currentStep === 3) {
                    nextInput = document.getElementById('lv2-step3-input1');
                } else if (lv2_currentStep === 4) {
                    nextInput = document.getElementById('lv2-step4-input1');
                } else if (lv2_currentStep === 5) {
                    nextInput = document.getElementById('lv2-step5-input');
                }
                
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }, delay);
        }

        // どんぐりを作成する関数
        function lv2_createAcorns(containerId, count) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const acorn = document.createElement('div');
                acorn.className = 'lv2-acorn';
                acorn.innerHTML = '🌰';
                acorn.dataset.containerId = containerId;
                acorn.dataset.index = i;
                
                container.appendChild(acorn);
            }
        }

        // ステップをチェックする関数
        function lv2_checkStep() {
            if (lv2_isProcessing) {
                return;
            }

            if (lv2_currentStep === 0) {
                // 式のチェック
                let formulaFirst = parseInt(document.getElementById('lv2-formula-first').value) || 0;
                let formulaSecond = parseInt(document.getElementById('lv2-formula-second').value) || 0;
                
                if (formulaFirst === lv2_currentProblem.minuend && formulaSecond === lv2_currentProblem.subtrahend) {
                    lv2_hideMessage();
                    lv2_showStep(1);
                    setTimeout(() => lv2_showStep(2), 1000);
                    lv2_focusNextInput(1200);
                } else {
                    lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv2-formula-first').focus();
                    }, 100);
                }
                return;
            } 
            
            if (lv2_currentStep === 2) {
                // ②のチェック - 1の位の数を入力
                let input2 = parseInt(document.getElementById('lv2-step2-input').value) || 0;
                
                if (input2 === lv2_stepValues.onesDigit) {
                    lv2_hideMessage();
                    lv2_isProcessing = true;
                    
                    lv2_showCherryAnimation();
                    // ②のときはドングリアニメーションなし
                    
                    setTimeout(() => {
                        lv2_showStep(3);
                        lv2_isProcessing = false;
                        lv2_focusNextInput(300);
                    }, 3000);
                } else {
                    lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv2-step2-input').focus();
                    }, 100);
                }
                return;
            }
            
            if (lv2_currentStep === 3) {
                // ③のチェック - 10から引く
                let input1 = parseInt(document.getElementById('lv2-step3-input1').value) || 0;
                let input2 = parseInt(document.getElementById('lv2-step3-input2').value) || 0;
                
                if (input1 === lv2_currentProblem.subtrahend && input2 === lv2_stepValues.remaining) {
                    lv2_hideMessage();
                    lv2_isProcessing = true;
                    
                    lv2_showStrikethroughAnimation();
                    lv2_showRemainingValue(); // ③のときに▲を表示
                    lv2_animateStep3(); // ドングリウインドーのアニメーションは残す
                    
                    setTimeout(() => {
                        lv2_showStep(4);
                        lv2_isProcessing = false;
                        lv2_focusNextInput(300);
                    }, 2500); // 2000から2500に増やす
                } else {
                    lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv2-step3-input1').focus();
                    }, 100);
                }
                return;
            }
            
            if (lv2_currentStep === 4) {
                // ④のチェック - 残りを合わせる
                let input1 = parseInt(document.getElementById('lv2-step4-input1').value) || 0;
                let input2 = parseInt(document.getElementById('lv2-step4-input2').value) || 0;
                let input3 = parseInt(document.getElementById('lv2-step4-input3').value) || 0;
                
                if ((input1 === lv2_stepValues.remaining && input2 === lv2_stepValues.onesDigit) ||
                    (input1 === lv2_stepValues.onesDigit && input2 === lv2_stepValues.remaining)) {
                    if (input3 === lv2_currentProblem.difference) {
                        lv2_hideMessage();
                        lv2_isProcessing = true;
                        
                        lv2_showFormulaOvalAnimation();
                        
                        setTimeout(() => {
                            lv2_showStep(5);
                            lv2_isProcessing = false;
                            lv2_focusNextInput(300);
                        }, 2000);
                    } else {
                        lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv2-step4-input3').focus();
                        }, 100);
                    }
                } else {
                    lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv2-step4-input1').focus();
                    }, 100);
                }
                return;
            }
            
            if (lv2_currentStep === 5) {
                // ⑤のチェック（最終答え）
                let finalAnswer = parseInt(document.getElementById('lv2-step5-input').value) || 0;
                
                if (finalAnswer === lv2_currentProblem.difference) {
                     lv2_isProcessing = true;  // 追加：処理中フラグを設定
                    lv2_showMessage('せいかいです。すごい！', 'success');
                    lv2_correctCount++;
                    document.getElementById('lv2-correct-count').textContent = lv2_correctCount;
                    
                    // 最終のどんぐり表示
                    lv2_animateFinalResult();
                    
                    setTimeout(() => {
                        if (lv2_correctCount >= lv2_totalProblems) {
                            document.getElementById('lv2-problem-area').classList.add('hidden');
                            document.getElementById('lv2-clear-area').classList.remove('hidden');
                            setTimeout(() => {
                                main_lvCleared(2);
                           lv2_isProcessing = false;  // 追加：フラグをリセット
                            }, 2000);
                        } else {
                            document.getElementById('lv2-next-btn').classList.remove('hidden');
                            document.getElementById('lv2-next-btn').focus();
                           lv2_isProcessing = false;  // 追加：フラグをリセット
                        }
                    }, 2000);
                } else {
                    lv2_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv2-step5-input').focus();
                     lv2_isProcessing = false;  // 追加：エラー時にフラグをリセット
                    }, 100);
                }
                return;
            }
        }

        // ②のアニメーション
        function lv2_animateStep2() {
            const containerInitial = document.getElementById('lv2-acorns-initial');
            const acorns = containerInitial.querySelectorAll('.lv2-acorn');
            
            // 使った分を強調
            for (let i = 0; i < lv2_currentProblem.subtrahend && i < acorns.length; i++) {
                setTimeout(() => {
                    acorns[i].style.backgroundColor = '#ff7675';
                    acorns[i].style.transform = 'scale(1.2)';
                }, i * 100 + 1000);
            }
        }

        // ③のアニメーション
        function lv2_animateStep3() {
            const containerInitial = document.getElementById('lv2-acorns-initial');
            const containerUsed = document.getElementById('lv2-acorns-used');
            const acorns = containerInitial.querySelectorAll('.lv2-acorn');
            
            // 使ったどんぐりを移動
            for (let i = 0; i < lv2_currentProblem.subtrahend; i++) {
                setTimeout(() => {
                    if (i < acorns.length) {
                        acorns[i].classList.add('lv2-used');
                        
                        // 使用済みコンテナに追加
                        const usedAcorn = document.createElement('div');
                        usedAcorn.className = 'lv2-acorn';
                        usedAcorn.innerHTML = '🌰';
                        usedAcorn.style.backgroundColor = '#ff7675';
                        containerUsed.appendChild(usedAcorn);
                    }
                }, i * 200 + 500);
            }
        }

        // 最終結果のアニメーション
        function lv2_animateFinalResult() {
            const containerRemaining = document.getElementById('lv2-acorns-remaining');
            
            // 残ったどんぐりを表示
            for (let i = 0; i < lv2_currentProblem.difference; i++) {
                setTimeout(() => {
                    const remainingAcorn = document.createElement('div');
                    remainingAcorn.className = 'lv2-acorn lv2-remaining';
                    remainingAcorn.innerHTML = '🌰';
                    containerRemaining.appendChild(remainingAcorn);
                }, i * 150);
            }
        }

        function lv2_nextProblem() {
            document.getElementById('lv2-formula-first').value = '';
            document.getElementById('lv2-formula-second').value = '';
            document.getElementById('lv2-next-btn').classList.add('hidden');
            document.querySelector('.lv2-check-btn').style.display = 'block';
            
            lv2_generateProblem();
        }

        function lv2_restartGame() {
            lv2_correctCount = 0;
            document.getElementById('lv2-correct-count').textContent = lv2_correctCount;
            document.getElementById('lv2-problem-area').classList.remove('hidden');
            document.getElementById('lv2-clear-area').classList.add('hidden');
            lv2_nextProblem();
        }

        // レベル3の実装
        let lv3_currentProblem = {};
        let lv3_correctCount = 0;
        let lv3_totalProblems = 5;
        let lv3_currentStep = 1;
        let lv3_stepValues = {};
        let lv3_isProcessing = false;
        let lv3_cherryDisplayShown = false;

        function lv3_initGame() {
            lv3_correctCount = 0;
            lv3_totalProblems = 5;
            lv3_currentStep = 1;
            lv3_isProcessing = false;
            lv3_cherryDisplayShown = false;
            document.getElementById('lv3-correct-count').textContent = '0';
            document.getElementById('lv3-problem-area').classList.remove('hidden');
            document.getElementById('lv3-clear-area').classList.add('hidden');
            lv3_generateProblem();
       // Enterキーイベントリスナーを追加
    lv3_addEnterKeyListeners();
}


// レベル3の入力フィールドにEnterキーイベントを追加
function lv3_addEnterKeyListeners() {
    const inputIds = ['lv3-step1-input', 'lv3-step2-input', 'lv3-step3-input'];
    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (!lv3_isProcessing) {
                        lv3_checkStep();
                    }
                }
            });
        }
    });
}




        // メッセージ表示機能
        function lv3_showMessage(text, type) {
            const messageElement = document.getElementById('lv3-message');
            messageElement.textContent = text;
            messageElement.className = `lv3-message lv3-${type} lv3-show`;
            
            // 3秒後にメッセージを自動で隠す
            setTimeout(() => {
                messageElement.classList.remove('lv3-show');
            }, 3000);
        }

        // メッセージを隠す
        function lv3_hideMessage() {
            const messageElement = document.getElementById('lv3-message');
            messageElement.classList.remove('lv3-show');
        }

        // さくらんぼ方式の表示を更新
        function lv3_updateCherryDisplay(split1, split2) {
            document.getElementById('lv3-cherry-split1').textContent = split1;
            document.getElementById('lv3-cherry-split2').textContent = split2;
        }

        // 式の前項を強調表示
        function lv3_highlightFormulaFirst() {
            const formulaFirst = document.getElementById('lv3-formula-first-value');
            formulaFirst.classList.add('lv3-formula-first-highlight');
            
            // 2.5秒後に強調を解除
            setTimeout(() => {
                formulaFirst.classList.remove('lv3-formula-first-highlight');
            }, 2500);
        }

        // ②の正解後に左枝に斜線とその下に答えブロックを表示
        function lv3_showStep2Animation() {
            const cherryFirstValue = document.getElementById('lv3-cherry-split1');
            const cherryBranch = cherryFirstValue.closest('.lv3-cherry-branch');
            
            // 斜線を追加
            const strikethrough = document.createElement('div');
            strikethrough.className = 'lv3-cherry-strikethrough';
            cherryFirstValue.appendChild(strikethrough);
            
            // ②の答えブロックを左枝の真下に追加
            const resultBlock = document.createElement('div');
            resultBlock.className = 'lv3-step2-result-block';
            resultBlock.textContent = lv3_stepValues.intermediate;
            
            // 左枝のブロックの位置に合わせて配置
            const cherryFirstRect = cherryFirstValue.getBoundingClientRect();
            const branchRect = cherryBranch.getBoundingClientRect();
            const leftOffset = (cherryFirstRect.left - branchRect.left) + (cherryFirstRect.width / 2);
            
            resultBlock.style.left = leftOffset + 'px';
            cherryBranch.appendChild(resultBlock);
        }

        // ③で②の答えブロックと右枝を楕円で囲む
        function lv3_showFinalCircleAnimation() {
            const formulaSectionElement = document.querySelector('.lv3-formula-section');
            const sectionRect = formulaSectionElement.getBoundingClientRect();
            
            // ②の答えブロック（緑色）の位置を取得
            const resultBlock = document.querySelector('.lv3-step2-result-block');
            const resultRect = resultBlock.getBoundingClientRect();
            
            // さくらんぼの右枝（緑色の数字）の位置を取得
            const cherrySecondValue = document.getElementById('lv3-cherry-split2');
            const cherryRect = cherrySecondValue.getBoundingClientRect();
            
            // 各ブロックの中心位置（相対位置）
            const resultCenterX = resultRect.left - sectionRect.left + resultRect.width / 2;
            const resultCenterY = resultRect.top - sectionRect.top + resultRect.height / 2;
            const cherryCenterX = cherryRect.left - sectionRect.left + cherryRect.width / 2;
            const cherryCenterY = cherryRect.top - sectionRect.top + cherryRect.height / 2;
            
            // 2つのブロックの中心を結ぶ線の中点
            const centerX = (resultCenterX + cherryCenterX) / 2;
            const centerY = (resultCenterY + cherryCenterY) / 2;
            
            // 2つのブロック間の距離と角度
            const deltaX = cherryCenterX - resultCenterX;
            const deltaY = cherryCenterY - resultCenterY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
            
            // 細長い楕円のサイズ計算
            const longAxis = distance + (resultRect.width + cherryRect.width) / 2 + 40;
            const shortAxis = Math.max(resultRect.height, cherryRect.height) + 20;
            
            // 楕円を作成
            const finalCircle = document.createElement('div');
            finalCircle.className = 'lv3-final-circle';
            
            // CSS変数として角度を設定
            finalCircle.style.setProperty('--rotation', `${angle}deg`);
            
            // スタイルを設定
            finalCircle.style.width = longAxis + 'px';
            finalCircle.style.height = shortAxis + 'px';
            finalCircle.style.left = centerX + 'px';
            finalCircle.style.top = centerY + 'px';
            finalCircle.style.transformOrigin = 'center center';
            finalCircle.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            
            // 式セクションに追加
            formulaSectionElement.appendChild(finalCircle);
            
            // アニメーションを開始
            setTimeout(() => {
                finalCircle.classList.add('lv3-animate');
            }, 50);
        }

        // アニメーション要素を隠す
        function lv3_hideAnimations() {
            const strikethroughs = document.querySelectorAll('.lv3-cherry-strikethrough');
            const resultBlocks = document.querySelectorAll('.lv3-step2-result-block');
            const finalCircles = document.querySelectorAll('.lv3-final-circle');
            
            strikethroughs.forEach(element => element.remove());
            resultBlocks.forEach(element => element.remove());
            finalCircles.forEach(element => element.remove());
        }

        // さくらんぼ方式のアニメーション表示
        function lv3_showCherryAnimation() {
            const cherryDisplay = document.getElementById('lv3-cherry-display');
            lv3_updateCherryDisplay(lv3_stepValues.tensDigit, lv3_stepValues.onesDigit);
            
            // 式の前項を強調表示
            lv3_highlightFormulaFirst();
            
            // アニメーションを表示
            cherryDisplay.classList.add('lv3-show');
            lv3_cherryDisplayShown = true;
        }

        // さくらんぼ方式の表示を隠す
        function lv3_hideCherryDisplay() {
            const cherryDisplay = document.getElementById('lv3-cherry-display');
            cherryDisplay.classList.remove('lv3-show');
            lv3_cherryDisplayShown = false;
        }

        // 問題を生成する関数（引き算用）
        function lv3_generateProblem() {
            // メッセージを隠す
            lv3_hideMessage();
            // さくらんぼ方式の表示を隠す
            lv3_hideCherryDisplay();
            // アニメーション要素を隠す
            lv3_hideAnimations();
            
            let a, b, answer;
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                // 前項：11-18の範囲
                a = Math.floor(Math.random() * 8) + 11; // 11-18
                
                // 後項：2-9の範囲
                b = Math.floor(Math.random() * 8) + 2; // 2-9
                
                answer = a - b;
                
                // 条件チェック：前項の一の位が後項より小さく、答えが1-9の範囲
                const onesDigitA = a % 10;
                
                if (onesDigitA < b && answer >= 1 && answer <= 9) {
                    break;
                }
                
                attempts++;
                
            } while (attempts < maxAttempts);
            
            // 適切な組み合わせが見つからなかった場合のフォールバック
            if (attempts >= maxAttempts) {
                a = 13;
                b = 5;
                answer = 8;
            }

            lv3_currentProblem = { a, b, answer };
            lv3_currentStep = 1;
            lv3_isProcessing = false;
            lv3_cherryDisplayShown = false;
            
            // ステップ計算
            const tensDigit = Math.floor(a / 10) * 10; // 10の位の数字（10 or 10）
            const onesDigit = a % 10; // 1の位の数字
            const intermediate = 10 - b; // 10から後項を引いた結果
            
            lv3_stepValues = {
                tensDigit: tensDigit,
                onesDigit: onesDigit,
                intermediate: intermediate,
                answer: answer
            };
            
            // 式に値を表示
            document.getElementById('lv3-formula-first-value').textContent = a;
            document.getElementById('lv3-formula-second-value').textContent = b;
            
            // ステップ表示を初期化
            lv3_resetSteps();
            lv3_showStep(1);
            
            // 最初の入力フィールドにフォーカス
            setTimeout(() => {
                document.getElementById('lv3-step1-input').focus();
            }, 100);
        }

        // ステップ表示を初期化
        function lv3_resetSteps() {
            document.querySelectorAll('.lv3-step').forEach(step => {
                step.classList.remove('lv3-active');
            });
            
            // ステップ内容を設定
            document.getElementById('lv3-first-num').textContent = lv3_currentProblem.a;
            document.getElementById('lv3-second-num').textContent = lv3_currentProblem.b;
            document.getElementById('lv3-step2-result').textContent = lv3_stepValues.intermediate;
            document.getElementById('lv3-ones-digit').textContent = lv3_stepValues.onesDigit;
            document.getElementById('lv3-final-first').textContent = lv3_currentProblem.a;
            document.getElementById('lv3-final-second').textContent = lv3_currentProblem.b;
            document.getElementById('lv3-final-answer').textContent = lv3_stepValues.answer;
            
            // 入力フィールドをクリア
            document.getElementById('lv3-step1-input').value = '';
            document.getElementById('lv3-step2-input').value = '';
            document.getElementById('lv3-step3-input').value = '';
        }

        // 特定のステップを表示
        function lv3_showStep(stepNum) {
            lv3_currentStep = stepNum;
            document.getElementById(`lv3-step${stepNum}`).classList.add('lv3-active');
        }

        // 次の入力フィールドにフォーカスを移動
        function lv3_focusNextInput(delay = 300) {
            setTimeout(() => {
                let nextInput = null;
                
                if (lv3_currentStep === 1) {
                    nextInput = document.getElementById('lv3-step1-input');
                } else if (lv3_currentStep === 2) {
                    nextInput = document.getElementById('lv3-step2-input');
                } else if (lv3_currentStep === 3) {
                    nextInput = document.getElementById('lv3-step3-input');
                }
                
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }, delay);
        }

        // ステップをチェックする関数
        function lv3_checkStep() {
            // 処理中の場合は何もしない
            if (lv3_isProcessing) {
                return;
            }
            
            if (lv3_currentStep === 1) {
                // ①のチェック - 前項を10と□に分ける
                let input1 = parseInt(document.getElementById('lv3-step1-input').value) || 0;
                
                if (input1 === lv3_stepValues.onesDigit) {
                    // 正解：さくらんぼ方式のアニメーションを表示してから次のステップ
                    lv3_hideMessage();
                    lv3_isProcessing = true;
                    
                    // さくらんぼ方式のアニメーション表示
                    lv3_showCherryAnimation();
                    
                    setTimeout(() => {
                        lv3_showStep(2);
                        lv3_isProcessing = false;
                        lv3_focusNextInput(300);
                    }, 3000);
                } else {
                    // 不正解：エラーメッセージを表示
                    lv3_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv3-step1-input').focus();
                    }, 100);
                }
                return;
            }
            
            if (lv3_currentStep === 2) {
                // ②のチェック - 10から後項を引く
                let input2 = parseInt(document.getElementById('lv3-step2-input').value) || 0;
                
                if (input2 === lv3_stepValues.intermediate) {
                    // 正解：斜線と答えブロックを表示してから次のステップへ
                    lv3_hideMessage();
                    lv3_isProcessing = true;
                    
                    // ②のアニメーション表示（斜線と答えブロック）
                    lv3_showStep2Animation();
                    
                    setTimeout(() => {
                        lv3_showStep(3);
                        lv3_isProcessing = false;
                        lv3_focusNextInput(300);
                    }, 2500);
                } else {
                    // 不正解：エラーメッセージを表示
                    lv3_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv3-step2-input').focus();
                    }, 100);
                }
                return;
            }
            
            if (lv3_currentStep === 3) {
                // ③のチェック - 2つの数を合わせる
                let input3 = parseInt(document.getElementById('lv3-step3-input').value) || 0;
                
                if (input3 === lv3_stepValues.answer) {
                    // 正解：楕円アニメーションを表示してから④のステップを表示
                    lv3_hideMessage();
                    lv3_isProcessing = true;
                    
                    // ③のアニメーション表示（楕円で囲む）
                    lv3_showFinalCircleAnimation();
                    
                    setTimeout(() => {
                        lv3_showStep(4);
                        
                        // 成功メッセージを表示してスコア更新
                        setTimeout(() => {
                            lv3_showMessage('せいかいです。すごい！', 'success');
                            lv3_correctCount++;
                            document.getElementById('lv3-correct-count').textContent = lv3_correctCount;
                            
                            // 2秒後に次の処理へ
                            setTimeout(() => {
                                if (lv3_correctCount >= lv3_totalProblems) {
                                    document.getElementById('lv3-problem-area').classList.add('hidden');
                                    document.getElementById('lv3-clear-area').classList.remove('hidden');
                                    setTimeout(() => {
                                        main_lvCleared(3);
                                    }, 2000);
                                } else {
                                    document.getElementById('lv3-next-btn').classList.remove('hidden');
                                    document.getElementById('lv3-next-btn').focus();
                                }
                                lv3_isProcessing = false;
                            }, 2000);
                        }, 1000);
                    }, 2000);
                } else {
                    // 不正解：エラーメッセージを表示
                    lv3_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv3-step3-input').focus();
                    }, 100);
                }
                return;
            }
        }

        // 次の問題に進む
        function lv3_nextProblem() {
            document.getElementById('lv3-next-btn').classList.add('hidden');
            lv3_generateProblem();
        }

        // ゲームを再開始
        function lv3_restartGame() {
            lv3_correctCount = 0;
            document.getElementById('lv3-correct-count').textContent = lv3_correctCount;
            document.getElementById('lv3-problem-area').classList.remove('hidden');
            document.getElementById('lv3-clear-area').classList.add('hidden');
            lv3_nextProblem();
        }

        // レベル4の実装
        let lv4_currentProblem = {};
        let lv4_correctCount = 0;
        let lv4_totalProblems = 3;
        let lv4_currentStep = 0;
        let lv4_stepValues = {};
        let lv4_isProcessing = false;
        let lv4_cherryDisplayShown = false;
        let lv4_solutionMethod = 'A'; // A: 被減数を分ける, B: 減数を分ける

        function lv4_initGame() {
            lv4_correctCount = 0;
            lv4_totalProblems = 3;
            lv4_currentStep = 0;
            lv4_isProcessing = false;
            lv4_cherryDisplayShown = false;
            lv4_solutionMethod = 'A';
            document.getElementById('lv4-correct-count').textContent = '0';
            document.getElementById('lv4-problem-area').classList.remove('hidden');
            document.getElementById('lv4-clear-area').classList.add('hidden');
            lv4_generateProblem();
        }

        // メッセージ表示機能
        function lv4_showMessage(text, type) {
            const messageElement = document.getElementById('lv4-message');
            messageElement.textContent = text;
            messageElement.className = `lv4-message lv4-${type} lv4-show`;
            
            setTimeout(() => {
                messageElement.classList.remove('lv4-show');
            }, 3000);
        }

        function lv4_hideMessage() {
            const messageElement = document.getElementById('lv4-message');
            messageElement.classList.remove('lv4-show');
        }

        // さくらんぼ方式の表示を更新
        function lv4_updateCherryDisplay(method, values) {
            if (method === 'A') {
                // 被減数を分ける方法
                document.getElementById('lv4-cherry-split1-first').textContent = '１０';
                document.getElementById('lv4-cherry-split2-first').textContent = values.onesDigit;
                
                // 方法Aでは緑のブロック（▲）を非表示
                const remainingElement = document.getElementById('lv4-remaining-from-ten-first');
                if (remainingElement) {
                    remainingElement.style.display = 'none';
                }
                
                const cherryDisplayFirst = document.getElementById('lv4-cherry-display-first');
                cherryDisplayFirst.classList.add('lv4-show');
                
                const cherryDisplaySecond = document.getElementById('lv4-cherry-display-second');
                cherryDisplaySecond.classList.remove('lv4-show');
            } else {
                // 減数を分ける方法
                document.getElementById('lv4-cherry-split1-second').textContent = values.onesDigit;
                document.getElementById('lv4-cherry-split2-second').textContent = values.subtrahendRemaining;
                
                const cherryDisplaySecond = document.getElementById('lv4-cherry-display-second');
                cherryDisplaySecond.classList.add('lv4-show');
                
                const cherryDisplayFirst = document.getElementById('lv4-cherry-display-first');
                cherryDisplayFirst.classList.remove('lv4-show');
            }
            lv4_cherryDisplayShown = true;
        }

        // 式の強調表示
        function lv4_highlightFormula(target) {
            if (target === 'first') {
                const formulaFirst = document.getElementById('lv4-formula-first');
                formulaFirst.classList.add('lv4-formula-first-highlight');
                
                setTimeout(() => {
                    formulaFirst.classList.remove('lv4-formula-first-highlight');
                }, 2500);
            } else {
                const formulaSecond = document.getElementById('lv4-formula-second');
                formulaSecond.classList.add('lv4-formula-second-highlight');
                
                setTimeout(() => {
                    formulaSecond.classList.remove('lv4-formula-second-highlight');
                }, 2500);
            }
        }

        function lv4_hideCherryDisplay() {
            const cherryDisplayFirst = document.getElementById('lv4-cherry-display-first');
            const cherryDisplaySecond = document.getElementById('lv4-cherry-display-second');
            cherryDisplayFirst.classList.remove('lv4-show');
            cherryDisplaySecond.classList.remove('lv4-show');
            
            // さくらんぼの状態をリセット
            const cherry10First = document.getElementById('lv4-cherry-split1-first');
            const cherryLeftSecond = document.getElementById('lv4-cherry-split1-second');
            if (cherry10First) {
                cherry10First.classList.remove('lv4-crossed');
            }
            if (cherryLeftSecond) {
                cherryLeftSecond.style.opacity = '';
                cherryLeftSecond.style.textDecoration = '';
                cherryLeftSecond.style.backgroundColor = '';
                cherryLeftSecond.style.color = '';
                cherryLeftSecond.style.border = '';
                cherryLeftSecond.style.transition = '';
            }
            
            lv4_cherryDisplayShown = false;
        }

        // 問題を生成する関数
        function lv4_generateProblem() {
            lv4_hideMessage();
            lv4_hideCherryDisplay();
            
            let minuend, subtrahend, difference;
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                minuend = Math.floor(Math.random() * 8) + 11; // 11-18
                subtrahend = Math.floor(Math.random() * 8) + 2; // 2-9
                difference = minuend - subtrahend;
                attempts++;
                
                const onesDigit = minuend % 10;
                
                // 条件：
                // 1. 差が2-9の範囲
                // 2. 繰り下がりが必要（1の位の数字 < 減数）
                if (difference >= 2 && difference <= 9 && onesDigit < subtrahend) {
                    break;
                }
                
            } while (attempts < maxAttempts);
            
            if (attempts >= maxAttempts) {
                minuend = 15;
                subtrahend = 7;
                difference = 8;
            }

            lv4_currentProblem = { minuend, subtrahend, difference };
            lv4_currentStep = 0;
            lv4_isProcessing = false;
            lv4_cherryDisplayShown = false;
            lv4_solutionMethod = 'A'; // デフォルトはA
            
            const onesDigit = minuend % 10;
            const tensDigit = Math.floor(minuend / 10);
            
            lv4_stepValues = {
                onesDigit: onesDigit,
                tensDigit: tensDigit,
                remaining: 10 - subtrahend,
                subtrahendRemaining: subtrahend - onesDigit,
                finalAnswer: difference
            };
            
            document.getElementById('lv4-problem-text').innerHTML = `
                どんぐりを つかって、こうさくを します。<br>
                <strong>${minuend}</strong>こ あります。<strong>${subtrahend}</strong>こ つかいました。<br>
                どんぐりは なんこ のこって いますか？
            `;

            // どんぐりを表示
            lv4_createAcorns('lv4-acorns-initial', minuend);
            lv4_createAcorns('lv4-acorns-used', 0);
            lv4_createAcorns('lv4-acorns-remaining', 0);
            
            lv4_resetSteps();
            lv4_showStep(0);
            
            setTimeout(() => {
                document.getElementById('lv4-formula-first').focus();
            }, 100);
        }

        // ステップ表示を初期化
        function lv4_resetSteps() {
            document.querySelectorAll('.lv4-step').forEach(step => {
                step.classList.remove('lv4-active');
            });
            
            document.getElementById('lv4-ones-digit').textContent = lv4_stepValues.onesDigit;
            document.getElementById('lv4-subtrahend1').textContent = lv4_currentProblem.subtrahend;
            document.getElementById('lv4-final-minuend').textContent = lv4_currentProblem.minuend;
            document.getElementById('lv4-final-subtrahend').textContent = lv4_currentProblem.subtrahend;
            
            // 入力フィールドをクリア
            document.getElementById('lv4-step2-input').value = '';
            document.getElementById('lv4-step2-diamond').value = '';
            document.getElementById('lv4-step2-circle').value = '';
            document.getElementById('lv4-step5-input').value = '';
            
            // 動的に作成される入力フィールドをクリア
            const dynamicInputs = ['lv4-step3-input1', 'lv4-step3-input2', 'lv4-step4-input1', 'lv4-step4-input2', 'lv4-step4-input3'];
            dynamicInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });

            // 式の入力フィールドをクリア
            document.getElementById('lv4-formula-first').value = '';
            document.getElementById('lv4-formula-second').value = '';

            // ボタンを表示
            document.querySelector('.lv4-check-btn').style.display = 'block';
            document.getElementById('lv4-next-btn').classList.add('hidden');
        // すべての入力フィールドにEnterキーイベントを追加
    setTimeout(() => {
        lv4_addAllEnterKeyListeners();
    }, 100);
}


// レベル4のすべての入力フィールドにEnterキーイベントを追加
function lv4_addAllEnterKeyListeners() {
    const allInputIds = [
        'lv4-formula-first', 'lv4-formula-second',
        'lv4-step2-input', 'lv4-step2-diamond', 'lv4-step2-circle',
        'lv4-step3-input1', 'lv4-step3-input2',
        'lv4-step4-input1', 'lv4-step4-input2', 'lv4-step4-input3',
        'lv4-step5-input'
    ];
    allInputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.removeEventListener('keypress', lv4_handleEnterKey);
            input.addEventListener('keypress', lv4_handleEnterKey);
        }
    });
}

function lv4_handleEnterKey(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        if (!lv4_isProcessing) {
            lv4_checkStep();
        }
    }
}


        function lv4_showStep(stepNum) {
            lv4_currentStep = stepNum;
            if (stepNum === 0) {
                document.querySelectorAll('.lv4-step').forEach(step => {
                    step.classList.remove('lv4-active');
                });
            } else {
                document.getElementById(`lv4-step${stepNum}`).classList.add('lv4-active');
            }
        }

        function lv4_focusNextInput(delay = 300) {
            setTimeout(() => {
                let nextInput = null;
                
                if (lv4_currentStep === 2) {
                    nextInput = document.getElementById('lv4-step2-input');
                } else if (lv4_currentStep === 3) {
                    nextInput = document.getElementById('lv4-step3-input1');
                } else if (lv4_currentStep === 4) {
                    nextInput = document.getElementById('lv4-step4-input1');
                } else if (lv4_currentStep === 5) {
                    nextInput = document.getElementById('lv4-step5-input');
                }
                
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }, delay);
        }

        // どんぐりを作成する関数
        function lv4_createAcorns(containerId, count) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const acorn = document.createElement('div');
                acorn.className = 'lv4-acorn';
                acorn.innerHTML = '🌰';
                acorn.dataset.containerId = containerId;
                acorn.dataset.index = i;
                
                container.appendChild(acorn);
            }
        }

        // ステップをチェックする関数
        function lv4_checkStep() {
            if (lv4_isProcessing) {
                return;
            }

            if (lv4_currentStep === 0) {
                // 式のチェック
                let formulaFirst = parseInt(document.getElementById('lv4-formula-first').value) || 0;
                let formulaSecond = parseInt(document.getElementById('lv4-formula-second').value) || 0;
                
                if (formulaFirst === lv4_currentProblem.minuend && formulaSecond === lv4_currentProblem.subtrahend) {
                    lv4_hideMessage();
                    lv4_showStep(1);
                    setTimeout(() => lv4_showStep(2), 1000);
                    lv4_focusNextInput(1200);
                } else {
                    lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv4-formula-first').focus();
                    }, 100);
                }
                return;
            } 
            
            if (lv4_currentStep === 2) {
                // ②のチェック - □を◆と◇に分ける
                let inputValue = parseInt(document.getElementById('lv4-step2-input').value) || 0;
                let diamond = parseInt(document.getElementById('lv4-step2-diamond').value) || 0;
                let circle = parseInt(document.getElementById('lv4-step2-circle').value) || 0;
                
                // 入力値の合計が正しいかチェック
                if (diamond + circle !== inputValue) {
                    lv4_showMessage('◆と◇のあわせたかずが ちがいます', 'error');
                    return;
                }
                
                // 方法Aのチェック（被減数を分ける）
                if (inputValue === lv4_currentProblem.minuend && (diamond === 10 || circle === 10)) {
                    lv4_solutionMethod = 'A';
                    lv4_hideMessage();
                    lv4_isProcessing = true;
                    
                    lv4_highlightFormula('first');
                    lv4_updateCherryDisplay('A', lv4_stepValues);
                    lv4_updateStepTexts('A');
                    lv4_addDynamicEnterKeyListeners();
                    
                    setTimeout(() => {
                        lv4_showStep(3);
                        lv4_isProcessing = false;
                        lv4_focusNextInput(300);
                    }, 3000);
                    return;
                }
                
                // 方法Bのチェック（減数を分ける）
                if (inputValue === lv4_currentProblem.subtrahend && 
                    (diamond === lv4_stepValues.onesDigit || circle === lv4_stepValues.onesDigit)) {
                    lv4_solutionMethod = 'B';
                    lv4_stepValues.subtrahendRemaining = inputValue - lv4_stepValues.onesDigit;
                    lv4_hideMessage();
                    lv4_isProcessing = true;
                    
                    lv4_highlightFormula('second');
                    lv4_updateCherryDisplay('B', lv4_stepValues);
                    lv4_updateStepTexts('B');
                    lv4_addDynamicEnterKeyListeners();
                    
                    setTimeout(() => {
                        lv4_showStep(3);
                        lv4_isProcessing = false;
                        lv4_focusNextInput(300);
                    }, 3000);
                    return;
                }
                
                lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                setTimeout(() => {
                    document.getElementById('lv4-step2-input').focus();
                }, 100);
                return;
            }
            
            if (lv4_currentStep === 3) {
                // ③のチェック
                let input1 = parseInt(document.getElementById('lv4-step3-input1').value) || 0;
                let input2 = parseInt(document.getElementById('lv4-step3-input2').value) || 0;
                
                if (lv4_solutionMethod === 'A') {
                    // 方法A: 10から減数を引く
                    if (input1 === lv4_currentProblem.subtrahend && input2 === lv4_stepValues.remaining) {
                        lv4_hideMessage();
                        lv4_isProcessing = true;
                        lv4_showFormulaAnimation('A');
                        setTimeout(() => {
                            lv4_showStep(4);
                            lv4_isProcessing = false;
                            lv4_focusNextInput(300);
                        lv4_isProcessing = false;  // 追加：フラグをリセット
                        }, 2000);
                    } else {
                        lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv4-step3-input1').focus();
                         lv4_isProcessing = false;  // 追加：エラー時にフラグをリセット
                        }, 100);
                    }
                } else {
                    // 方法B: 被減数から被減数の1の位を引く
                    if (input1 === lv4_currentProblem.minuend && input2 === lv4_stepValues.onesDigit) {
                        lv4_hideMessage();
                        lv4_isProcessing = true;
                        lv4_showFormulaAnimation('B');
                        setTimeout(() => {
                            lv4_showStep(4);
                            lv4_isProcessing = false;
                            lv4_focusNextInput(300);
                        }, 2000);
                    } else {
                        lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv4-step3-input1').focus();
                        }, 100);
                    }
                }
                return;
            }
            
            if (lv4_currentStep === 4) {
                // ④のチェック
                let input1 = parseInt(document.getElementById('lv4-step4-input1').value) || 0;
                let input2 = parseInt(document.getElementById('lv4-step4-input2').value) || 0;
                
                if (lv4_solutionMethod === 'A') {
                    let input3 = parseInt(document.getElementById('lv4-step4-input3').value) || 0;
                    // 方法A: 残りを合わせる
                    if ((input1 === lv4_stepValues.remaining && input2 === lv4_stepValues.onesDigit) ||
                        (input1 === lv4_stepValues.onesDigit && input2 === lv4_stepValues.remaining)) {
                        if (input3 === lv4_currentProblem.difference) {
                            lv4_hideMessage();
                            lv4_showOvalAnimation('A');
                            setTimeout(() => {
                                lv4_showStep(5);
                                lv4_focusNextInput(300);
                            }, 2000);
                        } else {
                            lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                            setTimeout(() => {
                                document.getElementById('lv4-step4-input3').focus();
                             lv4_isProcessing = false;  // 追加：エラー時にフラグをリセット
                            }, 100);
                        }
                    } else {
                        lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv4-step4-input1').focus();
                            lv4_isProcessing = false;  // 追加：エラー時にフラグをリセット
                        }, 100);
                    }
                } else {
                    // 方法B: 10から残りを引く（楕円アニメーションなし）
                    if (input1 === lv4_stepValues.subtrahendRemaining && input2 === lv4_currentProblem.difference) {
                        lv4_hideMessage();
                        setTimeout(() => {
                            lv4_showStep(5);
                            lv4_focusNextInput(300);
                 lv4_isProcessing = false;  // 追加：フラグをリセット
                        }, 1000);
                    } else {
                        lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv4-step4-input1').focus();
                          lv4_isProcessing = false;  // 追加：エラー時にフラグをリセット
                        }, 100);
                    }
                }
                return;
            }
            
            if (lv4_currentStep === 5) {
                // ⑤のチェック（最終答え）
                let finalAnswer = parseInt(document.getElementById('lv4-step5-input').value) || 0;
                
                if (finalAnswer === lv4_currentProblem.difference) {
                 lv4_isProcessing = true;  // 追加：処理中フラグを設定
                    lv4_showMessage('せいかいです。すごい！', 'success');
                    lv4_correctCount++;
                    document.getElementById('lv4-correct-count').textContent = lv4_correctCount;
                    
                    // 最終のどんぐり表示
                    lv4_animateFinalResult();
                    
                    setTimeout(() => {
                        if (lv4_correctCount >= lv4_totalProblems) {
                            document.getElementById('lv4-problem-area').classList.add('hidden');
                            document.getElementById('lv4-clear-area').classList.remove('hidden');
                            setTimeout(() => {
                                main_lvCleared(4);
                     lv4_isProcessing = false;  // 追加：フラグをリセット
                            }, 2000);
                        } else {
                            document.getElementById('lv4-next-btn').classList.remove('hidden');
                            document.getElementById('lv4-next-btn').focus();
                                 lv4_isProcessing = false;  // 追加：フラグをリセット
                        }
                    }, 2000);
                } else {
                    lv4_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv4-step5-input').focus();
                         lv4_isProcessing = false;  // 追加：エラー時にフラグをリセット
                    }, 100);
                }
                return;
            }
        }

        // ステップテキストを更新
        function lv4_updateStepTexts(method) {
            if (method === 'A') {
                document.getElementById('lv4-step3-text-template').innerHTML = 
                    `１０から<input type="number" id="lv4-step3-input1" class="lv4-input" min="2" max="9">をひくと<input type="number" id="lv4-step3-input2" class="lv4-input" min="1" max="8">`;
                document.getElementById('lv4-step4-text-template').innerHTML = 
                    `<input type="number" id="lv4-step4-input1" class="lv4-input" min="1" max="8">と<input type="number" id="lv4-step4-input2" class="lv4-input" min="1" max="8">をあわせて<input type="number" id="lv4-step4-input3" class="lv4-input" min="2" max="9">`;
            } else {
                document.getElementById('lv4-step3-text-template').innerHTML = 
                    `<input type="number" id="lv4-step3-input1" class="lv4-input" min="11" max="18">から<input type="number" id="lv4-step3-input2" class="lv4-input" min="1" max="8">をひくと１０`;
                document.getElementById('lv4-step4-text-template').innerHTML = 
                    `１０から<input type="number" id="lv4-step4-input1" class="lv4-input" min="1" max="8">をひいて<input type="number" id="lv4-step4-input2" class="lv4-input" min="2" max="9">`;
            }
        }

        // 式ウィンドウでのアニメーション
        function lv4_showFormulaAnimation(method) {
            if (method === 'A') {
                // 方法A: さくらんぼの10に斜線、10の真下に残りを表示
                const cherry10 = document.getElementById('lv4-cherry-split1-first');
                const formulaContainer = document.getElementById('lv4-formula-first-container');
                
                // 10に斜線を追加
                cherry10.classList.add('lv4-crossed');
                
                // さくらんぼが完全に描画されてから位置を取得
                setTimeout(() => {
                    const cherry10Rect = cherry10.getBoundingClientRect();
                    const containerRect = formulaContainer.getBoundingClientRect();
                    const relativeLeft = cherry10Rect.left - containerRect.left;
                    const relativeTop = cherry10Rect.top - containerRect.top;
                    
                    const remainingBlock = document.createElement('div');
                    remainingBlock.className = 'lv4-formula-result-block';
                    remainingBlock.textContent = lv4_stepValues.remaining;
                    remainingBlock.style.cssText = `
                        position: absolute;
                        top: ${relativeTop + cherry10Rect.height + 20}px;
                        left: ${relativeLeft + cherry10Rect.width/2 - 15}px;
                        background: #a8e6cf;
                        color: #2d3436;
                        border: 2px solid #81c784;
                        border-radius: 50%;
                        padding: 8px 12px;
                        font-weight: bold;
                        min-width: 30px;
                        text-align: center;
                        animation: lv4-resultPop 0.8s ease forwards;
                    `;
                    formulaContainer.appendChild(remainingBlock);
                }, 100);
                
            } else {
                // 方法B: 前項の数字に重ねて数字ブロックを表示してから斜線
                const formulaFirst = document.getElementById('lv4-formula-first');
                const formulaContainer = document.getElementById('lv4-formula-first-container');
                const cherryLeft = document.getElementById('lv4-cherry-split1-second');
                
                // 前項の位置を取得
                const firstRect = formulaFirst.getBoundingClientRect();
                const containerRect = formulaContainer.getBoundingClientRect();
                const relativeLeft = firstRect.left - containerRect.left;
                const relativeTop = firstRect.top - containerRect.top;
                
                // 前項の数字に重ねて数字ブロックを表示
                const overlayBlock = document.createElement('div');
                overlayBlock.className = 'lv4-formula-overlay-block';
                overlayBlock.textContent = lv4_currentProblem.minuend;
                overlayBlock.style.cssText = `
                    position: absolute;
                    top: ${relativeTop}px;
                    left: ${relativeLeft}px;
                    width: ${firstRect.width}px;
                    height: ${firstRect.height}px;
                    background: #ff7675;
                    color: white;
                    border: 2px solid #d63031;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 1.2em;
                    z-index: 10;
                    animation: lv4-resultPop 0.5s ease forwards;
                `;
                formulaContainer.appendChild(overlayBlock);
                
                // 0.5秒後に斜線を追加
                setTimeout(() => {
                    const strikethrough = document.createElement('div');
                    strikethrough.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        width: 120%;
                        height: 3px;
                        background: #d63031;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        animation: lv4-strikethrough 0.8s ease-out forwards;
                        z-index: 11;
                    `;
                    overlayBlock.appendChild(strikethrough);
                }, 500);
                
                // 下に10のブロックを表示
                const tenBlock = document.createElement('div');
                tenBlock.className = 'lv4-formula-result-block';
                tenBlock.innerHTML = '<span class="lv4-ten-digit">１</span><span class="lv4-ten-digit">０</span>';
                tenBlock.style.cssText = `
                    position: absolute;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ff7675;
                    color: white;
                    border: 2px solid #d63031;
                    border-radius: 5px;
                    padding: 8px 12px;
                    font-weight: bold;
                    animation: lv4-resultPop 0.8s ease forwards;
                    animation-delay: 0.8s;
                `;
                formulaContainer.appendChild(tenBlock);
                
                // さくらんぼの左ブロックを一度消してから70%薄くして再表示
                cherryLeft.style.transition = 'opacity 0.3s ease';
                cherryLeft.style.opacity = '0';
                
                setTimeout(() => {
                    cherryLeft.style.opacity = '0.3';
                    cherryLeft.style.backgroundColor = '#e0e0e0';
                    cherryLeft.style.color = '#999';
                    cherryLeft.style.border = '2px solid #ccc';
                }, 300);
            }
        }

        // ④のステップでの楕円アニメーション
        function lv4_showOvalAnimation(method) {
            const formulaSection = document.querySelector('.lv4-formula-section');
            
            // 既存の楕円を削除
            const existingOvals = formulaSection.querySelectorAll('.lv4-formula-oval-highlight');
            existingOvals.forEach(oval => oval.remove());
            
            if (method === 'A') {
                // 方法A: 残りの数字と1の位の数字を楕円で囲む
                const remainingBlock = formulaSection.querySelector('.lv4-formula-result-block');
                const onesValue = document.getElementById('lv4-cherry-split2-first');
                
                if (remainingBlock && onesValue) {
                    setTimeout(() => {
                        const formulaRect = formulaSection.getBoundingClientRect();
                        const remainingRect = remainingBlock.getBoundingClientRect();
                        const onesRect = onesValue.getBoundingClientRect();
                        
                        const remainingCenterX = remainingRect.left - formulaRect.left + remainingRect.width / 2;
                        const remainingCenterY = remainingRect.top - formulaRect.top + remainingRect.height / 2;
                        const onesCenterX = onesRect.left - formulaRect.left + onesRect.width / 2;
                        const onesCenterY = onesRect.top - formulaRect.top + onesRect.height / 2;
                        
                        const ovalCenterX = (remainingCenterX + onesCenterX) / 2;
                        const ovalCenterY = (remainingCenterY + onesCenterY) / 2;
                        
                        const deltaX = onesCenterX - remainingCenterX;
                        const deltaY = onesCenterY - remainingCenterY;
                        const angleInRadians = Math.atan2(deltaY, deltaX);
                        const angleInDegrees = angleInRadians * (180 / Math.PI);
                        
                        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        const ovalWidth = Math.max(distance + 100, 140);
                        const ovalHeight = 60;
                        
                        const oval = document.createElement('div');
                        oval.className = 'lv4-formula-oval-highlight';
                        oval.style.cssText = `
                            position: absolute;
                            left: ${ovalCenterX - ovalWidth / 2}px;
                            top: ${ovalCenterY - ovalHeight / 2}px;
                            width: ${ovalWidth}px;
                            height: ${ovalHeight}px;
                            border: 3px solid #00b894;
                            border-radius: 50%;
                            background: rgba(0, 184, 148, 0.1);
                            transform: rotate(${angleInDegrees}deg) scale(0.3);
                            opacity: 0;
                            z-index: 15;
                            pointer-events: none;
                            transition: transform 0.8s ease, opacity 0.8s ease;
                        `;
                        
                        formulaSection.style.position = 'relative';
                        formulaSection.appendChild(oval);
                        
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                oval.style.transform = `rotate(${angleInDegrees}deg) scale(1)`;
                                oval.style.opacity = '0.8';
                                oval.style.boxShadow = '0 0 20px rgba(0, 184, 148, 0.5)';
                            }, 50);
                        });
                    }, 500);
                }
            }
        }

        function lv4_animateFinalResult() {
            const containerRemaining = document.getElementById('lv4-acorns-remaining');
            
            // 残ったどんぐりを表示
            for (let i = 0; i < lv4_currentProblem.difference; i++) {
                setTimeout(() => {
                    const remainingAcorn = document.createElement('div');
                    remainingAcorn.className = 'lv4-acorn lv4-remaining';
                    remainingAcorn.innerHTML = '🌰';
                    containerRemaining.appendChild(remainingAcorn);
                }, i * 150);
            }
        }

        function lv4_nextProblem() {
            // 全てのアニメーション要素をクリア
            const formulaSection = document.querySelector('.lv4-formula-section');
            const existingOvals = formulaSection.querySelectorAll('.lv4-formula-oval-highlight');
            existingOvals.forEach(oval => oval.remove());
            
            const existingResultBlocks = formulaSection.querySelectorAll('.lv4-formula-result-block');
            existingResultBlocks.forEach(block => block.remove());
            
            const existingOverlayBlocks = formulaSection.querySelectorAll('.lv4-formula-overlay-block');
            existingOverlayBlocks.forEach(block => block.remove());
            
            // 式ウィンドウの斜線をクリア
            const formulaFirst = document.getElementById('lv4-formula-first');
            const existingStrikes = formulaFirst.querySelectorAll('div');
            existingStrikes.forEach(strike => strike.remove());
            formulaFirst.style.position = '';
            
            document.getElementById('lv4-formula-first').value = '';
            document.getElementById('lv4-formula-second').value = '';
            document.getElementById('lv4-next-btn').classList.add('hidden');
            
            lv4_generateProblem();
        }

        function lv4_restartGame() {
            lv4_correctCount = 0;
            document.getElementById('lv4-correct-count').textContent = lv4_correctCount;
            document.getElementById('lv4-problem-area').classList.remove('hidden');
            document.getElementById('lv4-clear-area').classList.add('hidden');
            lv4_nextProblem();
        }

        // 動的に作成される入力フィールドにEnterキーイベントを追加
        function lv4_addDynamicEnterKeyListeners() {
            const dynamicInputIds = ['lv4-step3-input1', 'lv4-step3-input2', 'lv4-step4-input1', 'lv4-step4-input2', 'lv4-step4-input3'];
            dynamicInputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (!lv4_isProcessing) {
                                lv4_checkStep();
                            }
                        }
                    });
                }
            });
        }

        // レベル5の実装
        let lv5_currentProblem = {};
        let lv5_correctCount = 0;
        let lv5_totalProblems = 3;
        let lv5_currentStep = 0;
        let lv5_stepValues = {};
        let lv5_isProcessing = false;
        let lv5_cherryDisplayShown = false;
        let lv5_solutionMethod = 'A'; // A: 被減数を分ける, B: 減数を分ける

        function lv5_initGame() {
            lv5_correctCount = 0;
            lv5_totalProblems = 3;
            lv5_currentStep = 0;
            lv5_isProcessing = false;
            lv5_cherryDisplayShown = false;
            lv5_solutionMethod = 'A';
            document.getElementById('lv5-correct-count').textContent = '0';
            document.getElementById('lv5-problem-area').classList.remove('hidden');
            document.getElementById('lv5-clear-area').classList.add('hidden');
            lv5_generateProblem();
        }

        // メッセージ表示機能
        function lv5_showMessage(text, type) {
            const messageElement = document.getElementById('lv5-message');
            messageElement.textContent = text;
            messageElement.className = `lv5-message lv5-${type} lv5-show`;
            
            setTimeout(() => {
                messageElement.classList.remove('lv5-show');
            }, 3000);
        }

        function lv5_hideMessage() {
            const messageElement = document.getElementById('lv5-message');
            messageElement.classList.remove('lv5-show');
        }

        // さくらんぼ方式の表示を更新
        function lv5_updateCherryDisplay(method, values) {
            if (method === 'A') {
                // 被減数を分ける方法
                document.getElementById('lv5-cherry-split1-first').textContent = '１０';
                document.getElementById('lv5-cherry-split2-first').textContent = values.onesDigit;
                
                const cherryDisplayFirst = document.getElementById('lv5-cherry-display-first');
                cherryDisplayFirst.classList.add('lv5-show');
                
                const cherryDisplaySecond = document.getElementById('lv5-cherry-display-second');
                cherryDisplaySecond.classList.remove('lv5-show');
            } else {
                // 減数を分ける方法
                document.getElementById('lv5-cherry-split1-second').textContent = values.onesDigit;
                document.getElementById('lv5-cherry-split2-second').textContent = values.subtrahendRemaining;
                
                const cherryDisplaySecond = document.getElementById('lv5-cherry-display-second');
                cherryDisplaySecond.classList.add('lv5-show');
                
                const cherryDisplayFirst = document.getElementById('lv5-cherry-display-first');
                cherryDisplayFirst.classList.remove('lv5-show');
            }
            lv5_cherryDisplayShown = true;
        }

        // 式の強調表示
        function lv5_highlightFormula(target) {
            if (target === 'first') {
                const formulaFirst = document.getElementById('lv5-formula-first-display');
                formulaFirst.classList.add('lv5-formula-first-highlight');
                
                setTimeout(() => {
                    formulaFirst.classList.remove('lv5-formula-first-highlight');
                }, 2500);
            } else {
                const formulaSecond = document.getElementById('lv5-formula-second-display');
                formulaSecond.classList.add('lv5-formula-second-highlight');
                
                setTimeout(() => {
                    formulaSecond.classList.remove('lv5-formula-second-highlight');
                }, 2500);
            }
        }

        function lv5_hideCherryDisplay() {
            const cherryDisplayFirst = document.getElementById('lv5-cherry-display-first');
            const cherryDisplaySecond = document.getElementById('lv5-cherry-display-second');
            cherryDisplayFirst.classList.remove('lv5-show');
            cherryDisplaySecond.classList.remove('lv5-show');
            
            // さくらんぼの状態をリセット
            const cherry10First = document.getElementById('lv5-cherry-split1-first');
            const cherryLeftSecond = document.getElementById('lv5-cherry-split1-second');
            if (cherry10First) {
                cherry10First.classList.remove('lv5-crossed');
            }
            if (cherryLeftSecond) {
                cherryLeftSecond.style.opacity = '';
                cherryLeftSecond.style.textDecoration = '';
                cherryLeftSecond.style.backgroundColor = '';
                cherryLeftSecond.style.color = '';
                cherryLeftSecond.style.border = '';
                cherryLeftSecond.style.transition = '';
            }
            
            lv5_cherryDisplayShown = false;
        }

        // 問題を生成する関数
        function lv5_generateProblem() {
            lv5_hideMessage();
            lv5_hideCherryDisplay();
            
            let minuend, subtrahend, difference;
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                minuend = Math.floor(Math.random() * 8) + 11; // 11-18
                subtrahend = Math.floor(Math.random() * 8) + 2; // 2-9
                difference = minuend - subtrahend;
                attempts++;
                
                const onesDigit = minuend % 10;
                
                // 条件：
                // 1. 差が2-9の範囲
                // 2. 繰り下がりが必要（1の位の数字 < 減数）
                if (difference >= 2 && difference <= 9 && onesDigit < subtrahend) {
                    break;
                }
                
            } while (attempts < maxAttempts);
            
            if (attempts >= maxAttempts) {
                minuend = 15;
                subtrahend = 7;
                difference = 8;
            }

            lv5_currentProblem = { minuend, subtrahend, difference };
            lv5_currentStep = 0;
            lv5_isProcessing = false;
            lv5_cherryDisplayShown = false;
            lv5_solutionMethod = 'A'; // デフォルトはA
            
            const onesDigit = minuend % 10;
            const tensDigit = Math.floor(minuend / 10);
            
            lv5_stepValues = {
                onesDigit: onesDigit,
                tensDigit: tensDigit,
                remaining: 10 - subtrahend,
                subtrahendRemaining: subtrahend - onesDigit,
                finalAnswer: difference
            };
            
            // 式を表示
            document.getElementById('lv5-formula-first-display').textContent = minuend;
            document.getElementById('lv5-formula-second-display').textContent = subtrahend;
            document.getElementById('lv5-final-minuend').textContent = minuend;
            document.getElementById('lv5-final-subtrahend').textContent = subtrahend;
            
            lv5_resetSteps();
            lv5_showStep(1);
            
            setTimeout(() => {
                document.getElementById('lv5-step1-input').focus();
            }, 100);
        }

        // ステップ表示を初期化
        function lv5_resetSteps() {
            document.querySelectorAll('.lv5-step').forEach(step => {
                step.classList.remove('lv5-active');
            });
            
            // 入力フィールドをクリア
            document.getElementById('lv5-step1-input').value = '';
            document.getElementById('lv5-step1-diamond').value = '';
            document.getElementById('lv5-step1-circle').value = '';
            document.getElementById('lv5-step3-input').value = '';
            
            // 動的に作成される入力フィールドをクリア
            const dynamicInputs = ['lv5-step2-input1', 'lv5-step2-input2'];
            dynamicInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            });

// すべての入力フィールドにEnterキーイベントを追加
    setTimeout(() => {
        lv5_addAllEnterKeyListeners();
    }, 100);
}


// レベル5のすべての入力フィールドにEnterキーイベントを追加
function lv5_addAllEnterKeyListeners() {
    const allInputIds = [
        'lv5-step1-input', 'lv5-step1-diamond', 'lv5-step1-circle',
        'lv5-step2-input1', 'lv5-step2-input2',
        'lv5-step3-input'
    ];
    allInputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.removeEventListener('keypress', lv5_handleEnterKey);
            input.addEventListener('keypress', lv5_handleEnterKey);
        }
    });
}

function lv5_handleEnterKey(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        if (!lv5_isProcessing) {
            lv5_checkStep();
        }
    }
}


        function lv5_showStep(stepNum) {
            lv5_currentStep = stepNum;
            document.getElementById(`lv5-step${stepNum}`).classList.add('lv5-active');
        }

        function lv5_focusNextInput(delay = 300) {
            setTimeout(() => {
                let nextInput = null;
                
                if (lv5_currentStep === 1) {
                    nextInput = document.getElementById('lv5-step1-input');
                } else if (lv5_currentStep === 2) {
                    nextInput = document.getElementById('lv5-step2-input1');
                } else if (lv5_currentStep === 3) {
                    nextInput = document.getElementById('lv5-step3-input');
                }
                
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }, delay);
        }

        // ステップをチェックする関数
        function lv5_checkStep() {
            if (lv5_isProcessing) {
                return;
            }
            
            if (lv5_currentStep === 1) {
                // ①のチェック - □を◆と◇に分ける
                let inputValue = parseInt(document.getElementById('lv5-step1-input').value) || 0;
                let diamond = parseInt(document.getElementById('lv5-step1-diamond').value) || 0;
                let circle = parseInt(document.getElementById('lv5-step1-circle').value) || 0;
                
                // 入力値の合計が正しいかチェック
                if (diamond + circle !== inputValue) {
                    lv5_showMessage('◆と◇のあわせたかずが ちがいます', 'error');
                    return;
                }
                
                // 方法Aのチェック（被減数を分ける）
                if (inputValue === lv5_currentProblem.minuend && (diamond === 10 || circle === 10)) {
                    lv5_solutionMethod = 'A';
                    lv5_hideMessage();
                    lv5_isProcessing = true;
                    
                    lv5_highlightFormula('first');
                    lv5_updateCherryDisplay('A', lv5_stepValues);
                    lv5_updateStepTexts('A');
                    lv5_addDynamicEnterKeyListeners();
                    
                    setTimeout(() => {
                        lv5_showStep(2);
                        lv5_isProcessing = false;
                        lv5_focusNextInput(300);
                    }, 3000);
                    return;
                }
                
                // 方法Bのチェック（減数を分ける）
                if (inputValue === lv5_currentProblem.subtrahend && 
                    (diamond === lv5_stepValues.onesDigit || circle === lv5_stepValues.onesDigit)) {
                    lv5_solutionMethod = 'B';
                    lv5_stepValues.subtrahendRemaining = inputValue - lv5_stepValues.onesDigit;
                    lv5_hideMessage();
                    lv5_isProcessing = true;
                    
                    lv5_highlightFormula('second');
                    lv5_updateCherryDisplay('B', lv5_stepValues);
                    lv5_updateStepTexts('B');
                    lv5_addDynamicEnterKeyListeners();
                    
                    setTimeout(() => {
                        lv5_showStep(2);
                        lv5_isProcessing = false;
                        lv5_focusNextInput(300);
                    }, 3000);
                    return;
                }
                
                lv5_showMessage('もういちど、よくかんがえてみましょう', 'error');
                setTimeout(() => {
                    document.getElementById('lv5-step1-input').focus();
                }, 100);
                return;
            }
            
            if (lv5_currentStep === 2) {
                // ②のチェック
                let input1 = parseInt(document.getElementById('lv5-step2-input1').value) || 0;
                let input2 = parseInt(document.getElementById('lv5-step2-input2').value) || 0;
                
                if (lv5_solutionMethod === 'A') {
                    // 方法A: 10から減数を引く
                    if (input1 === lv5_currentProblem.subtrahend && input2 === lv5_stepValues.remaining) {
                        lv5_hideMessage();
                        lv5_isProcessing = true;
                        lv5_showFormulaAnimation('A');
                        setTimeout(() => {
                            lv5_showStep(3);
                            lv5_isProcessing = false;
                            lv5_focusNextInput(300);
                        }, 2000);
                    } else {
                        lv5_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv5-step2-input1').focus();
                        }, 100);
                    }
                } else {
                    // 方法B: 被減数から被減数の1の位を引く
                    if (input1 === lv5_currentProblem.minuend && input2 === lv5_stepValues.onesDigit) {
                        lv5_hideMessage();
                        lv5_isProcessing = true;
                        lv5_showFormulaAnimation('B');
                        setTimeout(() => {
                            lv5_showStep(3);
                            lv5_isProcessing = false;
                            lv5_focusNextInput(300);
                        }, 2000);
                    } else {
                        lv5_showMessage('もういちど、よくかんがえてみましょう', 'error');
                        setTimeout(() => {
                            document.getElementById('lv5-step2-input1').focus();
                        }, 100);
                    }
                }
                return;
            }
            
            if (lv5_currentStep === 3) {
                // ③のチェック（最終答え）
                let finalAnswer = parseInt(document.getElementById('lv5-step3-input').value) || 0;
                
                if (finalAnswer === lv5_currentProblem.difference) {
                   lv5_isProcessing = true;  // 追加：処理中フラグを設定
                    lv5_showMessage('せいかいです。すごい！', 'success');
                    lv5_correctCount++;
                    document.getElementById('lv5-correct-count').textContent = lv5_correctCount;
                    
                    setTimeout(() => {
                        if (lv5_correctCount >= lv5_totalProblems) {
                            document.getElementById('lv5-problem-area').classList.add('hidden');
                            document.getElementById('lv5-clear-area').classList.remove('hidden');
                            setTimeout(() => {
                                main_lvCleared(5);
                            lv5_isProcessing = false;  // 追加：フラグをリセット
                            }, 2000);
                        } else {
                            document.getElementById('lv5-next-btn').classList.remove('hidden');
                            document.getElementById('lv5-next-btn').focus();
                          lv5_isProcessing = false;  // 追加：フラグをリセット
                        }
                    }, 2000);
                } else {
                    lv5_showMessage('もういちど、よくかんがえてみましょう', 'error');
                    setTimeout(() => {
                        document.getElementById('lv5-step3-input').focus();
                   lv5_isProcessing = false;  // 追加：エラー時にフラグをリセット
                    }, 100);
                }
                return;
            }
        }

        // ステップテキストを更新
        function lv5_updateStepTexts(method) {
            if (method === 'A') {
                document.getElementById('lv5-step2-text-template').innerHTML = 
                    `１０から<input type="number" id="lv5-step2-input1" class="lv5-input" min="2" max="9">をひくと<input type="number" id="lv5-step2-input2" class="lv5-input" min="1" max="8">`;
            } else {
                document.getElementById('lv5-step2-text-template').innerHTML = 
                    `<input type="number" id="lv5-step2-input1" class="lv5-input" min="11" max="18">から<input type="number" id="lv5-step2-input2" class="lv5-input" min="1" max="8">をひくと１０`;
            }
        }

        // 式ウィンドウでのアニメーション
        function lv5_showFormulaAnimation(method) {
            if (method === 'A') {
                // 方法A: さくらんぼの10に斜線、10の真下に残りを表示
                const cherry10 = document.getElementById('lv5-cherry-split1-first');
                const formulaContainer = document.getElementById('lv5-formula-first-container');
                
                // 10に斜線を追加
                cherry10.classList.add('lv5-crossed');
                
                // さくらんぼが完全に描画されてから位置を取得
                setTimeout(() => {
                    const cherry10Rect = cherry10.getBoundingClientRect();
                    const containerRect = formulaContainer.getBoundingClientRect();
                    const relativeLeft = cherry10Rect.left - containerRect.left;
                    const relativeTop = cherry10Rect.top - containerRect.top;
                    
                    const remainingBlock = document.createElement('div');
                    remainingBlock.className = 'lv5-formula-result-block';
                    remainingBlock.textContent = lv5_stepValues.remaining;
                    remainingBlock.style.cssText = `
                        position: absolute;
                        top: ${relativeTop + cherry10Rect.height + 20}px;
                        left: ${relativeLeft + cherry10Rect.width/2 - 15}px;
                        background: #a8e6cf;
                        color: #2d3436;
                        border: 2px solid #81c784;
                        border-radius: 50%;
                        padding: 8px 12px;
                        font-weight: bold;
                        min-width: 30px;
                        text-align: center;
                        animation: lv5-resultPop 0.8s ease forwards;
                    `;
                    formulaContainer.appendChild(remainingBlock);
                }, 100);
                
            } else {
                // 方法B: 前項の数字に重ねて数字ブロックを表示してから斜線
                const formulaFirst = document.getElementById('lv5-formula-first-display');
                const formulaContainer = document.getElementById('lv5-formula-first-container');
                const cherryLeft = document.getElementById('lv5-cherry-split1-second');
                
                // 前項の位置を取得
                const firstRect = formulaFirst.getBoundingClientRect();
                const containerRect = formulaContainer.getBoundingClientRect();
                const relativeLeft = firstRect.left - containerRect.left;
                const relativeTop = firstRect.top - containerRect.top;
                
                // 前項の数字に重ねて数字ブロックを表示
                const overlayBlock = document.createElement('div');
                overlayBlock.className = 'lv5-formula-overlay-block';
                overlayBlock.textContent = lv5_currentProblem.minuend;
                overlayBlock.style.cssText = `
                    position: absolute;
                    top: ${relativeTop}px;
                    left: ${relativeLeft}px;
                    width: ${firstRect.width + 10}px;
                    height: ${firstRect.height + 4}px;
                    background: #ff7675;
                    color: white;
                    border: 2px solid #d63031;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 1.4em;
                    z-index: 10;
                    animation: lv5-resultPop 0.5s ease forwards;
                `;
                formulaContainer.appendChild(overlayBlock);
                
                // 0.5秒後に斜線を追加
                setTimeout(() => {
                    const strikethrough = document.createElement('div');
                    strikethrough.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        width: 120%;
                        height: 3px;
                        background: #d63031;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        animation: lv5-strikethrough 0.8s ease-out forwards;
                        z-index: 11;
                    `;
                    overlayBlock.appendChild(strikethrough);
                }, 500);
                
                // 下に10のブロックを表示
                const tenBlock = document.createElement('div');
                tenBlock.className = 'lv5-formula-result-block lv5-ten-block';
                tenBlock.innerHTML = '<span class="lv5-ten-digit">１</span><span class="lv5-ten-digit">０</span>';
                tenBlock.style.cssText = `
                    position: absolute;
                    top: 70px;
                    left: ${relativeLeft - 30}px;
                    background: #ff7675;
                    color: white;
                    border: 2px solid #d63031;
                    border-radius: 5px;
                    padding: 4px 8px;
                    font-weight: bold;
                    font-size: 0.9em;
                    display: inline-flex;
                    align-items: center;
                    animation: lv5-resultPop 0.8s ease forwards;
                    animation-delay: 0.8s;
                `;
                formulaContainer.appendChild(tenBlock);
                
                // さくらんぼの左ブロックを一度消してから70%薄くして再表示
                cherryLeft.style.transition = 'opacity 0.3s ease';
                cherryLeft.style.opacity = '0';
                
                setTimeout(() => {
                    cherryLeft.style.opacity = '0.3';
                    cherryLeft.style.backgroundColor = '#e0e0e0';
                    cherryLeft.style.color = '#999';
                    cherryLeft.style.border = '2px solid #ccc';
                }, 300);
            }
        }

        function lv5_nextProblem() {
            // 全てのアニメーション要素をクリア
            const formulaSection = document.querySelector('.lv5-formula-section');
            
            const existingResultBlocks = formulaSection.querySelectorAll('.lv5-formula-result-block');
            existingResultBlocks.forEach(block => block.remove());
            
            const existingOverlayBlocks = formulaSection.querySelectorAll('.lv5-formula-overlay-block');
            existingOverlayBlocks.forEach(block => block.remove());
            
            document.getElementById('lv5-next-btn').classList.add('hidden');
            
            lv5_generateProblem();
        }

        function lv5_restartGame() {
            lv5_correctCount = 0;
            document.getElementById('lv5-correct-count').textContent = lv5_correctCount;
            document.getElementById('lv5-problem-area').classList.remove('hidden');
            document.getElementById('lv5-clear-area').classList.add('hidden');
            lv5_nextProblem();
        }

        // 動的に作成される入力フィールドにEnterキーイベントを追加
        function lv5_addDynamicEnterKeyListeners() {
            const dynamicInputIds = ['lv5-step2-input1', 'lv5-step2-input2'];
            dynamicInputIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (!lv5_isProcessing) {
                                lv5_checkStep();
                            }
                        }
                    });
                }
            });
        }

         // レベル6の実装
        class Lv6HikizanGame {
            constructor() {
                this.problems = this.lv6_generateProblems();
                this.currentIndex = 0;
                this.solvedProblems = new Set();
                this.correctMessages = ['すごい！', 'やったね！', 'せいかい！', 'がんばった！'];
                this.incorrectMessage = 'もういちど、かんがえましょう';
                this.isProcessing = false;
                this.cardData = {};
                this.problemLeftElement = document.getElementById('lv6-problem-left');
                this.answerInput = document.getElementById('lv6-answer');
                this.messageElement = document.getElementById('lv6-message');
                this.progressElement = document.getElementById('lv6-progress-text');
                this.cardsContainer = document.getElementById('lv6-cards-container');
                this.sortButton = document.getElementById('lv6-sort-button');
                this.lv6_setupEventListeners();
                this.lv6_showNextProblem();
            }

            lv6_generateProblems() {
                const problems = [];
                for (let a = 18; a >= 11; a--) {
                    for (let b = 2; b <= 9; b++) {
                        const difference = a - b;
                        if (difference >= 2 && difference <= 9) {
                            problems.push({ a, b, answer: difference });
                        }
                    }
                }
                return this.lv6_shuffleArray(problems);
            }

            lv6_shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            lv6_setupEventListeners() {
                this.answerInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!this.isProcessing) {
                            this.lv6_checkAnswer();
                        }
                    }
                });

                this.answerInput.addEventListener('input', () => {
                    if (this.answerInput.value.length >= 1 && !this.isProcessing) {
                        setTimeout(() => this.lv6_checkAnswer(), 100);
                    }
                });

                this.sortButton.addEventListener('click', () => {
                    this.lv6_sortCards();
                });
            }

            lv6_showNextProblem() {
                if (this.currentIndex >= this.problems.length) {
                    this.lv6_showCompletion();
                    return;
                }

                this.isProcessing = false;
                const problem = this.problems[this.currentIndex];
                this.problemLeftElement.textContent = `${problem.a} － ${problem.b}`;
                this.answerInput.value = '';
                this.messageElement.textContent = '';
                this.messageElement.className = 'lv6-message';
                this.progressElement.textContent = `もんだい ${this.currentIndex + 1} / ${this.problems.length}`;

                setTimeout(() => {
                    this.answerInput.focus();
                }, 100);
            }

            lv6_checkAnswer() {
                if (this.isProcessing) return;

                const userAnswer = this.answerInput.value.trim();
                if (userAnswer === '') return;

                this.isProcessing = true;

                const normalizedAnswer = userAnswer.replace(/[０-９]/g, (s) => {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });

                const correctAnswer = this.problems[this.currentIndex].answer;

                if (parseInt(normalizedAnswer) === correctAnswer) {
                    this.lv6_handleCorrectAnswer();
                } else {
                    this.lv6_handleIncorrectAnswer();
                }
            }

            lv6_handleCorrectAnswer() {
                const randomMessage = this.correctMessages[Math.floor(Math.random() * this.correctMessages.length)];
                this.messageElement.textContent = randomMessage;
                this.messageElement.className = 'lv6-message lv6-correct';

                this.lv6_addCard();
                this.solvedProblems.add(this.currentIndex);

                if (Object.keys(this.cardData).length > 0) {
                    this.sortButton.style.display = 'block';
                }

                setTimeout(() => {
                    this.currentIndex++;
                    this.lv6_showNextProblem();
                }, 1500);
            }

            lv6_handleIncorrectAnswer() {
                this.messageElement.textContent = this.incorrectMessage;
                this.messageElement.className = 'lv6-message lv6-incorrect';
                this.answerInput.value = '';

                setTimeout(() => {
                    this.isProcessing = false;
                    this.answerInput.focus();
                }, 1000);
            }

            lv6_addCard() {
                const problem = this.problems[this.currentIndex];
                const targetColumn = document.querySelector(`[data-answer="${problem.answer}"]`);

                const card = document.createElement('div');
                card.className = 'lv6-card';
                card.textContent = `${problem.a} － ${problem.b}`;
                card.dataset.firstNumber = problem.a;
                card.dataset.secondNumber = problem.b;
                card.dataset.answer = problem.answer;

                if (!this.cardData[problem.answer]) {
                    this.cardData[problem.answer] = [];
                }

                this.cardData[problem.answer].push({
                    a: problem.a,
                    b: problem.b,
                    answer: problem.answer,
                    element: card
                });

                targetColumn.appendChild(card);
            }

            lv6_sortCards() {
                for (let answer = 9; answer >= 2; answer--) {
                    if (this.cardData[answer] && this.cardData[answer].length > 1) {
                        const column = document.querySelector(`[data-answer="${answer}"]`);

                        this.cardData[answer].forEach(cardInfo => {
                            cardInfo.element.classList.add('lv6-sorting');
                        });

                        // 前項の小さい順（昇順）にソート
                        this.cardData[answer].sort((a, b) => {
                            if (a.a !== b.a) {
                                return a.a - b.a; // 前項で比較（小さい順）
                            }
                            return a.b - b.b; // 前項が同じ場合は後項で比較（小さい順）
                        });

                        setTimeout(() => {
                            column.innerHTML = '';
                            this.cardData[answer].forEach((cardInfo, index) => {
                                cardInfo.element.classList.remove('lv6-sorting');
                                setTimeout(() => {
                                    column.appendChild(cardInfo.element);
                                }, index * 100);
                            });
                        }, 250);
                    }
                }
            }





lv6_showCompletion() {
                // クリア状態を保存（まとめモードでない場合のみ）
                if (main_gameState.currentMode === 'practice' && !main_gameState.clearedlvs.includes(6)) {
                    main_gameState.clearedlvs.push(6);
                    main_saveClearedlvs();
                }
                
                document.getElementById('lv6-problem-area').innerHTML = `
                    <div class="lv6-completion-message">
                        おめでとう！<br>
                        ぜんぶせいかいしました！<br>
                        とてもよくがんばりました！
                    </div>
                `;
                
                // まとめモードの場合のみ自動遷移
                if (main_gameState.currentMode === 'matome') {
                    setTimeout(() => {
                        main_lvCleared(6);
                    }, 2000);
                } else {
                    // 練習モードの場合は「もういちど」ボタンを表示
                    setTimeout(() => {
                        document.getElementById('lv6-problem-area').innerHTML += `
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="main-btn" onclick="lv6_restartGame()" style="margin: 10px;">もういちど</button>
                            </div>
                        `;
                    }, 1000);
                }
            }
 }

        let lv6_gameInstance = null;

        function lv6_initGame() {
            // レベル6画面の初期化
            document.getElementById('lv6-problem-area').innerHTML = `
                <div class="lv6-problem-container">
                    <span id="lv6-problem-left"></span>
                    <span>＝</span>
                    <input type="text" class="lv6-answer-input" id="lv6-answer" maxlength="1">
                </div>
                <div class="lv6-message" id="lv6-message"></div>
            `;

            // カードコンテナをリセット
            document.querySelectorAll('.lv6-column').forEach(column => {
                column.innerHTML = '';
            });

            // ソートボタンを隠す
            document.getElementById('lv6-sort-button').style.display = 'none';

            // ゲームインスタンスを作成
            lv6_gameInstance = new Lv6HikizanGame();
        }


// レベル7の実装
    let lv7_targetNumber = 5;
    let lv7_selectedCard = null;
    let lv7_gameNumbers = [];
    let lv7_currentQuestion = 1;
    let lv7_correctAnswers = 0;
    let lv7_questionsPerGame = 3;
    let lv7_matchedPairs = 0;
    let lv7_totalPairs = 5;
    let lv7_remainingCards = 10;

    function lv7_initGame() {
        lv7_currentQuestion = 1;
        lv7_correctAnswers = 0;
        lv7_updateDisplay();
 // 追加：ボタンの初期表示設定
    document.getElementById('lv7-changeButton').style.display = 'inline-block';

        lv7_generateNewQuestion();
    }


// 「もんだいをかえる」ボタンがクリックされた時の処理
function lv7_changeQuestion() {
    // 現在の問題をリセット
    lv7_selectedCard = null;
    lv7_matchedPairs = 0;
    lv7_remainingCards = 10;
    
    // メッセージをクリア
    document.getElementById('lv7-questionClearMessage').style.display = 'none';
    document.getElementById('lv7-clearMessage').style.display = 'none';
    document.getElementById('lv7-nextButton').style.display = 'none';
    document.getElementById('lv7-restartButton').style.display = 'none';
    
    // 新しい問題を生成
    lv7_generateNewQuestion();
}




 function lv7_generateNewQuestion() {
        let attempts = 0;
        const maxAttempts = 10;
        
        // 確実にペアが作れる答えが見つかるまで繰り返す
        while (attempts < maxAttempts) {
            // 2～9のランダムな答えを生成
            lv7_targetNumber = Math.floor(Math.random() * 8) + 2;
            
            // 答えに対して可能なペアを生成（a - b = targetNumber つまり a = b + targetNumber）
            let possiblePairs = [];
            
            // より大きい数の範囲を設定（1～20）
            for (let b = 1; b <= 15; b++) {
                let a = b + lv7_targetNumber;
                if (a <= 20) { // 大きな数は20以下に制限
                    possiblePairs.push([a, b]);
                }
            }
            
            // 5つのペアが確実に作れるかチェック
            if (possiblePairs.length >= 5) {
                // ペアをシャッフル
                for (let i = possiblePairs.length - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    [possiblePairs[i], possiblePairs[j]] = [possiblePairs[j], possiblePairs[i]];
                }
                
                // 重複なしで5つのペアを選択
                let selectedPairs = possiblePairs.slice(0, 5);
                
                // ペアを展開してゲーム用配列に追加
                lv7_gameNumbers = [];
                selectedPairs.forEach(pair => {
                    lv7_gameNumbers.push(pair[0], pair[1]);
                });
                
                // 重複する数字がないことを確認
                let uniqueNumbers = [...new Set(lv7_gameNumbers)];
                if (uniqueNumbers.length === lv7_gameNumbers.length) {
                    // 重複がない場合のみ成功
                    break;
                }
            }
            
            attempts++;
        }
        
        // フォールバック：万が一生成に失敗した場合は固定の安全な組み合わせを使用
        if (attempts >= maxAttempts) {
            lv7_targetNumber = 5; // 安全な答え
            lv7_gameNumbers = [8, 3, 9, 4, 10, 5, 11, 6, 12, 7]; // 確実にペアが作れる組み合わせ
        }
        
        // 配列をシャッフル
        for (let i = lv7_gameNumbers.length - 1; i > 0; i--) {
            let j = Math.floor(Math.random() * (i + 1));
            [lv7_gameNumbers[i], lv7_gameNumbers[j]] = [lv7_gameNumbers[j], lv7_gameNumbers[i]];
        }
        
        lv7_selectedCard = null;
        lv7_matchedPairs = 0;
        lv7_remainingCards = 10;
        lv7_totalPairs = 5;
        
        lv7_updateDisplay();
        lv7_displayNumbers();

 // 追加：ボタンの表示制御
    document.getElementById('lv7-changeButton').style.display = 'inline-block';
    document.getElementById('lv7-questionClearMessage').style.display = 'none';
    document.getElementById('lv7-clearMessage').style.display = 'none';
    document.getElementById('lv7-nextButton').style.display = 'none';
    document.getElementById('lv7-restartButton').style.display = 'none';
}
    function lv7_updateDisplay() {
        document.getElementById('lv7-targetNumber').textContent = lv7_targetNumber;
        document.getElementById('lv7-correctCount').textContent = lv7_correctAnswers;
        document.getElementById('lv7-questionCounter').textContent = `もんだい ${lv7_currentQuestion} / ${lv7_questionsPerGame}`;
        document.getElementById('lv7-remainingCards').textContent = lv7_remainingCards;
        document.getElementById('lv7-foundPairs').textContent = lv7_matchedPairs;
    }

    function lv7_displayNumbers() {
        const grid = document.getElementById('lv7-numberGrid');
        grid.innerHTML = '';
        
        lv7_gameNumbers.forEach((num, index) => {
            const card = document.createElement('div');
            card.className = 'lv7-number-card';
            card.textContent = num;
            card.onclick = () => lv7_selectCard(index);
            card.id = `lv7-card-${index}`;
            grid.appendChild(card);
        });
    }

    function lv7_selectCard(index) {
        const card = document.getElementById(`lv7-card-${index}`);
        
        // すでにマッチしたカードは選択不可
        if (card.classList.contains('lv7-matched') || card.style.visibility === 'hidden') {
            return;
        }
        
        // 同じカードをクリックした場合
        if (lv7_selectedCard === index) {
            card.classList.remove('lv7-selected');
            lv7_selectedCard = null;
            return;
        }
        
        // 最初のカード選択
        if (lv7_selectedCard === null) {
            card.classList.add('lv7-selected');
            lv7_selectedCard = index;
            return;
        }
        
        // 2つ目のカード選択
        const firstCard = document.getElementById(`lv7-card-${lv7_selectedCard}`);
        const firstNumber = lv7_gameNumbers[lv7_selectedCard];
        const secondNumber = lv7_gameNumbers[index];
        
        // ペアが正しいかチェック（引き算なので大きい数から小さい数を引く）
        const largerNumber = Math.max(firstNumber, secondNumber);
        const smallerNumber = Math.min(firstNumber, secondNumber);
        
        if (largerNumber - smallerNumber === lv7_targetNumber) {
            // 正解！
            setTimeout(() => {
                card.classList.add('lv7-matched');
                firstCard.classList.add('lv7-matched');
                
                setTimeout(() => {
                    card.style.visibility = 'hidden';
                    firstCard.style.visibility = 'hidden';
                    lv7_matchedPairs++;
                    lv7_remainingCards -= 2;
                    lv7_updateDisplay();
                    
                    // すべてのカードが消えたかチェック
                    if (lv7_remainingCards === 0) {
                        lv7_correctAnswers++;
                        lv7_updateDisplay();
                        document.getElementById('lv7-questionClearMessage').style.display = 'block';

    // 追加：もんだいをかえるボタンを非表示
    document.getElementById('lv7-changeButton').style.display = 'none';

                        
                        // 全問題完了チェック
                       // 修正後
if (lv7_correctAnswers >= lv7_questionsPerGame) {
    setTimeout(() => {
        document.getElementById('lv7-questionClearMessage').style.display = 'none';
        document.getElementById('lv7-clearMessage').style.display = 'block';
        setTimeout(() => {
            // メッセージを非表示にしてから画面遷移
            document.getElementById('lv7-clearMessage').style.display = 'none';
            main_lvCleared(7);
        }, 2000);
    }, 2000);
} else {
                            setTimeout(() => {
                                document.getElementById('lv7-questionClearMessage').style.display = 'none';
                                document.getElementById('lv7-nextButton').style.display = 'inline-block';
                            }, 2000);
                        }
                    }
                }, 800);
            }, 100);
        } else {
            // 不正解
            card.classList.add('lv7-selected');
            setTimeout(() => {
                card.classList.remove('lv7-selected');
                firstCard.classList.remove('lv7-selected');
            }, 1000);
        }
        
        lv7_selectedCard = null;
    }

    function lv7_nextQuestion() {
        if (lv7_currentQuestion < lv7_questionsPerGame) {
            lv7_currentQuestion++;
            document.getElementById('lv7-nextButton').style.display = 'none';
            lv7_generateNewQuestion();
        }
    }

    function lv7_restartGame() {
        document.getElementById('lv7-clearMessage').style.display = 'none';
        document.getElementById('lv7-restartButton').style.display = 'none';
        lv7_initGame();
    }




            // ボーナスゲームの実装
        let bonus_canvas, bonus_ctx, bonus_gameState;

        function bonus_startGame(duration = 60) {
            main_showScreen('bonus-game-screen');
            bonus_canvas = document.getElementById('bonus-gameCanvas');
            bonus_ctx = bonus_canvas.getContext('2d');
            
            bonus_gameState = {
                running: true,
                score: 0,
                lives: 3,
                timer: duration,
                powerlv: 0,
                player: { x: 600, y: 700, width: 40, height: 40, speed: 8 },
                bullets: [],
                enemies: [],
                particles: [],
                powerups: [],
                keys: {},
                lastEnemySpawn: 0,
                lastPowerupSpawn: 0,
                lastShot: 0,
                timerInterval: null,
                uiInterval: null
            };

            bonus_initializeBackground();
            bonus_gameState.lastShot = Date.now();
            bonus_gameState.lastEnemySpawn = Date.now();
            bonus_gameState.lastPowerupSpawn = Date.now();
            bonus_gameState.timerInterval = setInterval(bonus_updateTimer, 1000);
            bonus_gameState.uiInterval = setInterval(bonus_updateUI, 100);
            
            bonus_gameLoop();
        }

        function bonus_initializeBackground() {
            bonus_ctx.fillStyle = 'rgba(0, 0, 17, 1)';
            bonus_ctx.fillRect(0, 0, bonus_canvas.width, bonus_canvas.height);
        }

        function bonus_createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                bonus_gameState.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1,
                    decay: 0.02,
                    size: Math.random() * 5 + 2,
                    color: color
                });
            }
        }

        function bonus_spawnEnemy() {
            const types = [
                { color: '#ff1744', speed: 2, points: 10, size: 35 },
                { color: '#d50000', speed: 3, points: 20, size: 30 },
                { color: '#aa0000', speed: 4, points: 30, size: 25 }
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            bonus_gameState.enemies.push({
                x: Math.random() * (bonus_canvas.width - type.size),
                y: -type.size,
                width: type.size,
                height: type.size,
                speed: type.speed,
                color: type.color,
                points: type.points,
                hp: Math.floor(type.points / 10)
            });
        }

        function bonus_spawnPowerup() {
            const types = [
                { type: 'star', color: '#ffeb3b', points: 100, effect: 'score' },
                { type: 'heart', color: '#e91e63', points: 0, effect: 'life' },
                { type: 'diamond', color: '#00bcd4', points: 200, effect: 'score' },
                { type: 'power', color: '#9c27b0', points: 50, effect: 'power' }
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            bonus_gameState.powerups.push({
                x: Math.random() * (bonus_canvas.width - 25),
                y: -25,
                width: 25,
                height: 25,
                speed: 2,
                ...type,
                rotation: 0
            });
        }

        function bonus_shoot() {
            const baseX = bonus_gameState.player.x + bonus_gameState.player.width / 2;
            const baseY = bonus_gameState.player.y - 15;
            
            if (bonus_gameState.powerlv === 0) {
                bonus_gameState.bullets.push({
                    x: baseX - 5, y: baseY, width: 10, height: 25,
                    vx: 0, vy: -12, color: '#00ff88'
                });
            } else if (bonus_gameState.powerlv === 1) {
                bonus_gameState.bullets.push({
                    x: baseX - 5, y: baseY, width: 10, height: 25,
                    vx: 0, vy: -12, color: '#00ff88'
                });
                bonus_gameState.bullets.push({
                    x: baseX - 15, y: baseY, width: 8, height: 20,
                    vx: -3, vy: -10, color: '#00ccff'
                });
                bonus_gameState.bullets.push({
                    x: baseX + 5, y: baseY, width: 8, height: 20,
                    vx: 3, vy: -10, color: '#00ccff'
                });
            } else if (bonus_gameState.powerlv === 2) {
                const angles = [-0.6, -0.3, 0, 0.3, 0.6];
                angles.forEach((angle, i) => {
                    bonus_gameState.bullets.push({
                        x: baseX - 5 + (i-2) * 8, y: baseY, width: 8, height: 20,
                        vx: Math.sin(angle) * 12, vy: -Math.cos(angle) * 12,
                        color: i === 2 ? '#00ff88' : '#00ccff'
                    });
                });
            } else {
                const angles = [-0.8, -0.5, -0.25, 0, 0.25, 0.5, 0.8];
                angles.forEach((angle, i) => {
                    bonus_gameState.bullets.push({
                        x: baseX - 5 + (i-3) * 6, y: baseY, width: 8, height: 18,
                        vx: Math.sin(angle) * 12, vy: -Math.cos(angle) * 12,
                        color: i === 3 ? '#00ff88' : '#ffaa00'
                    });
                });
            }
        }

        function bonus_checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function bonus_drawPlayer() {
            const p = bonus_gameState.player;
            bonus_ctx.save();
            bonus_ctx.translate(p.x + p.width/2, p.y + p.height/2);
            const gradient = bonus_ctx.createLinearGradient(-20, -20, 20, 20);
            gradient.addColorStop(0, '#00bfff');
            gradient.addColorStop(0.5, '#1e90ff');
            gradient.addColorStop(1, '#0066cc');
            bonus_ctx.fillStyle = gradient;
            bonus_ctx.beginPath();
            bonus_ctx.moveTo(0, -18);
            bonus_ctx.lineTo(12, -8);
            bonus_ctx.lineTo(12, 8);
            bonus_ctx.lineTo(0, 18);
            bonus_ctx.lineTo(-12, 8);
            bonus_ctx.lineTo(-12, -8);
            bonus_ctx.closePath();
            bonus_ctx.fill();
            bonus_ctx.fillStyle = '#4169e1';
            bonus_ctx.fillRect(-20, -5, 8, 10);
            bonus_ctx.fillRect(12, -5, 8, 10);
            bonus_ctx.fillStyle = '#ff4500';
            bonus_ctx.fillRect(-6, 18, 3, 12);
            bonus_ctx.fillRect(-1, 18, 3, 12);
            bonus_ctx.fillRect(4, 18, 3, 12);
            bonus_ctx.fillStyle = '#ffff00';
            bonus_ctx.fillRect(-5, 18, 2, 8);
            bonus_ctx.fillRect(0, 18, 2, 8);
            bonus_ctx.fillRect(5, 18, 2, 8);
            bonus_ctx.fillStyle = '#00ffff';
            bonus_ctx.shadowColor = '#00ffff';
            bonus_ctx.shadowBlur = 15;
            bonus_ctx.beginPath();
            bonus_ctx.arc(0, -5, 5, 0, Math.PI * 2);
            bonus_ctx.fill();
            bonus_ctx.shadowBlur = 0;
            bonus_ctx.fillStyle = '#ffffff';
            bonus_ctx.fillRect(-2, -20, 4, 8);
            bonus_ctx.restore();
        }

        function bonus_drawEffects() {
            bonus_gameState.particles.forEach((p, index) => {
                bonus_ctx.save();
                bonus_ctx.globalAlpha = p.life;
                bonus_ctx.fillStyle = p.color;
                bonus_ctx.beginPath();
                bonus_ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                bonus_ctx.fill();
                bonus_ctx.restore();
                p.x += p.vx;
                p.y += p.vy;
                p.life -= p.decay;
                if (p.life <= 0) {
                    bonus_gameState.particles.splice(index, 1);
                }
            });
        }

        function bonus_update() {
            if (!bonus_gameState.running) return;
            
            if ((bonus_gameState.keys['ArrowLeft'] || bonus_gameState.keys['KeyA']) && bonus_gameState.player.x > 0) {
                bonus_gameState.player.x -= bonus_gameState.player.speed;
            }
            if ((bonus_gameState.keys['ArrowRight'] || bonus_gameState.keys['KeyD']) && bonus_gameState.player.x < bonus_canvas.width - bonus_gameState.player.width) {
                bonus_gameState.player.x += bonus_gameState.player.speed;
            }
            
            if (Date.now() - bonus_gameState.lastShot > 200) {
                bonus_shoot();
                bonus_gameState.lastShot = Date.now();
            }

            bonus_gameState.bullets.forEach((bullet, index) => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                if (bullet.y < -50 || bullet.x < -50 || bullet.x > bonus_canvas.width + 50) {
                    bonus_gameState.bullets.splice(index, 1);
                }
            });

            bonus_gameState.enemies.forEach((enemy, index) => {
                enemy.y += enemy.speed;
                if (enemy.y > bonus_canvas.height) {
                    bonus_gameState.enemies.splice(index, 1);
                }
            });

            bonus_gameState.powerups.forEach((powerup, index) => {
                powerup.y += powerup.speed;
                powerup.rotation += 0.1;
                if (powerup.y > bonus_canvas.height) {
                    bonus_gameState.powerups.splice(index, 1);
                }
            });

            bonus_gameState.bullets.forEach((bullet, bulletIndex) => {
                bonus_gameState.enemies.forEach((enemy, enemyIndex) => {
                    if (bonus_checkCollision(bullet, enemy)) {
                        enemy.hp--;
                        bonus_gameState.bullets.splice(bulletIndex, 1);
                        if (enemy.hp <= 0) {
                            bonus_gameState.score += enemy.points;
                            bonus_createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.color, 15);
                            bonus_gameState.enemies.splice(enemyIndex, 1);
                        }
                    }
                });
            });

            bonus_gameState.enemies.forEach((enemy, index) => {
                if (bonus_checkCollision(bonus_gameState.player, enemy)) {
                    bonus_gameState.lives--;
                    bonus_createParticles(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#ff6b6b', 20);
                    bonus_gameState.enemies.splice(index, 1);
                    if (bonus_gameState.lives <= 0) {
                        bonus_endGameInternal();
                    }
                }
            });

            bonus_gameState.powerups.forEach((powerup, index) => {
                if (bonus_checkCollision(bonus_gameState.player, powerup)) {
                    if (powerup.effect === 'life' && bonus_gameState.lives < 3) {
                        bonus_gameState.lives++;
                    } else if (powerup.effect === 'power') {
                        bonus_gameState.powerlv = Math.min(bonus_gameState.powerlv + 1, 5);
                        bonus_gameState.score += powerup.points;
                    } else {
                        bonus_gameState.score += powerup.points;
                    }
                    bonus_createParticles(powerup.x + powerup.width/2, powerup.y + powerup.height/2, powerup.color, 12);
                    bonus_gameState.powerups.splice(index, 1);
                }
            });

            if (Date.now() - bonus_gameState.lastEnemySpawn > 1000) {
                bonus_spawnEnemy();
                bonus_gameState.lastEnemySpawn = Date.now();
            }
            if (Date.now() - bonus_gameState.lastPowerupSpawn > 5000) {
                bonus_spawnPowerup();
                bonus_gameState.lastPowerupSpawn = Date.now();
            }
        }

        function bonus_draw() {
            bonus_ctx.fillStyle = 'rgba(0, 0, 17, 0.1)';
            bonus_ctx.fillRect(0, 0, bonus_canvas.width, bonus_canvas.height);
            
            for (let i = 0; i < 50; i++) {
                bonus_ctx.fillStyle = `rgba(255, 255, 255, ${Math.random()})`;
                bonus_ctx.fillRect(Math.random() * bonus_canvas.width, Math.random() * bonus_canvas.height, 1, 1);
            }

            bonus_drawPlayer();

            bonus_gameState.bullets.forEach(bullet => {
                bonus_ctx.save();
                bonus_ctx.fillStyle = bullet.color;
                bonus_ctx.shadowColor = bullet.color;
                bonus_ctx.shadowBlur = 15;
                bonus_ctx.beginPath();
                bonus_ctx.ellipse(bullet.x + bullet.width/2, bullet.y + bullet.height/2,
                    bullet.width/2, bullet.height/2, 0, 0, Math.PI * 2);
                bonus_ctx.fill();
                bonus_ctx.restore();
            });

            bonus_gameState.enemies.forEach(enemy => {
                bonus_ctx.save();
                bonus_ctx.fillStyle = enemy.color;
                bonus_ctx.shadowColor = enemy.color;
                bonus_ctx.shadowBlur = 20;
                bonus_ctx.beginPath();
                bonus_ctx.moveTo(enemy.x + enemy.width/2, enemy.y);
                bonus_ctx.lineTo(enemy.x, enemy.y + enemy.height);
                bonus_ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
                bonus_ctx.closePath();
                bonus_ctx.fill();
                bonus_ctx.restore();
            });

            bonus_gameState.powerups.forEach(powerup => {
                bonus_ctx.save();
                bonus_ctx.translate(powerup.x + powerup.width/2, powerup.y + powerup.height/2);
                bonus_ctx.rotate(powerup.rotation);
                bonus_ctx.fillStyle = powerup.color;
                bonus_ctx.shadowColor = powerup.color;
                bonus_ctx.shadowBlur = 25;
                
                if (powerup.type === 'star') {
                    bonus_ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI) / 5;
                        const x = Math.cos(angle) * 12;
                        const y = Math.sin(angle) * 12;
                        if (i === 0) bonus_ctx.moveTo(x, y);
                        else bonus_ctx.lineTo(x, y);
                    }
                    bonus_ctx.closePath();
                    bonus_ctx.fill();
                } else if (powerup.type === 'heart') {
                    bonus_ctx.fillStyle = powerup.color;
                    bonus_ctx.beginPath();
                    bonus_ctx.arc(-6, -3, 6, 0, Math.PI * 2);
                    bonus_ctx.arc(6, -3, 6, 0, Math.PI * 2);
                    bonus_ctx.fill();
                    bonus_ctx.beginPath();
                    bonus_ctx.moveTo(0, 8);
                    bonus_ctx.lineTo(-10, -2);
                    bonus_ctx.lineTo(10, -2);
                    bonus_ctx.closePath();
                    bonus_ctx.fill();
                } else if (powerup.type === 'power') {
                    bonus_ctx.beginPath();
                    bonus_ctx.moveTo(0, -12);
                    bonus_ctx.lineTo(-4, -4);
                    bonus_ctx.lineTo(2, -4);
                    bonus_ctx.lineTo(-2, 4);
                    bonus_ctx.lineTo(4, 4);
                    bonus_ctx.lineTo(0, 12);
                    bonus_ctx.lineTo(0, 4);
                    bonus_ctx.lineTo(-4, 4);
                    bonus_ctx.lineTo(0, -4);
                    bonus_ctx.closePath();
                    bonus_ctx.fill();
                } else {
                    bonus_ctx.beginPath();
                    bonus_ctx.moveTo(0, -12);
                    bonus_ctx.lineTo(-8, 0);
                    bonus_ctx.lineTo(0, 12);
                    bonus_ctx.lineTo(8, 0);
                    bonus_ctx.closePath();
                    bonus_ctx.fill();
                }
                bonus_ctx.restore();
            });

            bonus_drawEffects();
        }

        function bonus_gameLoop() {
            bonus_update();
            bonus_draw();
            if (bonus_gameState && bonus_gameState.running) {
                requestAnimationFrame(bonus_gameLoop);
            }
        }

        function bonus_updateTimer() {
            if (bonus_gameState.running && bonus_gameState.timer > 0) {
                bonus_gameState.timer--;
                document.getElementById('bonus-timer').textContent = bonus_gameState.timer;
                if (bonus_gameState.timer <= 0) {
                    bonus_endGameInternal();
                }
            }
        }

        function bonus_updateUI() {
            if (bonus_gameState) {
                document.getElementById('bonus-score').textContent = bonus_gameState.score;
                const hearts = '❤️'.repeat(bonus_gameState.lives);
                document.getElementById('bonus-lives').textContent = hearts;
                document.getElementById('bonus-power').textContent = `Lv.${bonus_gameState.powerlv}`;
            }
        }

        function bonus_endGameInternal() {
            bonus_gameState.running = false;
            if (bonus_gameState.timerInterval) {
                clearInterval(bonus_gameState.timerInterval);
                bonus_gameState.timerInterval = null;
            }
            if (bonus_gameState.uiInterval) {
                clearInterval(bonus_gameState.uiInterval);
                bonus_gameState.uiInterval = null;
            }
            bonus_initializeBackground();
            document.getElementById('bonus-final-score').textContent = bonus_gameState.score;
            document.getElementById('bonus-game-over').style.display = 'block';
        }

        function bonus_endGame() {
            document.getElementById('bonus-game-over').style.display = 'none';
            main_bonusGameEnded(bonus_gameState.score);
        }

        // キーボードイベント
        document.addEventListener('keydown', (e) => {
            if (bonus_gameState) {
                bonus_gameState.keys[e.code] = true;
                if (['ArrowLeft', 'ArrowRight', 'KeyA', 'KeyD', 'Space', 'Enter'].includes(e.code)) {
                    e.preventDefault();
                }
            }
            
            // レベル1でのEnterキー処理
            if (e.key === 'Enter' && document.getElementById('lv1-screen').classList.contains('active')) {
                if (!lv1_isProcessing) {
                    if (!document.getElementById('lv1-result').classList.contains('hidden')) {
                        if (!document.getElementById('lv1-next-btn').classList.contains('hidden')) {
                            lv1_nextProblem();
                        }
                    } else {
                        lv1_checkAnswer();
                    }
                }
            }
            
            // レベル2でのEnterキー処理
            if (e.key === 'Enter' && document.getElementById('lv2-screen').classList.contains('active')) {
                if (!lv2_isProcessing) {
                    if (!document.getElementById('lv2-next-btn').classList.contains('hidden')) {
                        lv2_nextProblem();
                    } else {
                        lv2_checkStep();
                    }
                }
            }
// レベル3でのEnterキー処理
    if (e.key === 'Enter' && document.getElementById('lv3-screen').classList.contains('active')) {
        if (!lv3_isProcessing) {
            if (!document.getElementById('lv3-next-btn').classList.contains('hidden')) {
                lv3_nextProblem();
            } else {
                lv3_checkStep();
            }
        }
    }
    
    // レベル4でのEnterキー処理
    if (e.key === 'Enter' && document.getElementById('lv4-screen').classList.contains('active')) {
        if (!lv4_isProcessing) {
            if (!document.getElementById('lv4-next-btn').classList.contains('hidden')) {
                lv4_nextProblem();
            } else {
                lv4_checkStep();
            }
        }
    }
    
    // レベル5でのEnterキー処理
    if (e.key === 'Enter' && document.getElementById('lv5-screen').classList.contains('active')) {
        if (!lv5_isProcessing) {
            if (!document.getElementById('lv5-next-btn').classList.contains('hidden')) {
                lv5_nextProblem();
            } else {
                lv5_checkStep();
            }
        }
    }
});     

        document.addEventListener('keyup', (e) => {
            if (bonus_gameState) {
                bonus_gameState.keys[e.code] = false;
                if (['ArrowLeft', 'ArrowRight', 'KeyA', 'KeyD', 'Space', 'Enter'].includes(e.code)) {
                    e.preventDefault();
                }
            }
        });

        // 初期化
        main_loadClearedlvs();
        main_showStart();
    </script>
</body>
</html>
